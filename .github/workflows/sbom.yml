name: SBOM Generation

on:
  push:
    branches: [main]
    paths:
      - 'pyproject.toml'
      - 'uv.lock'
      - 'Dockerfile'
  release:
    types: [published]
  workflow_dispatch:

# Performance: Cancel in-flight runs for same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: read
  security-events: write
  attestations: write
  id-token: write

env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "24"
  PNPM_VERSION: "9"

jobs:
  generate-sbom:
    name: Generate Software Bill of Materials
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          version: "latest"

      - name: Verify Python lock and dependencies
        run: |
          uv lock --check
          uv sync --locked --group dev
          uv run pip-audit --ignore-vuln CVE-2026-1703

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Verify dashboard lockfile
        working-directory: ./dashboard
        run: pnpm install --frozen-lockfile

      - name: Audit dashboard dependencies
        working-directory: ./dashboard
        run: pnpm audit --audit-level=high
      
      - name: Create supply-chain output directories
        run: mkdir -p sbom provenance

      # Python Dependencies SBOM
      - name: Generate Python SBOM (CycloneDX)
        uses: CycloneDX/gh-python-generate-sbom@v2
        with:
          input: ./pyproject.toml
          output: ./sbom/valdrix-python-sbom.json
          format: json

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # Container Image SBOM
      - name: Build Docker Image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          tags: valdrix/api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Generate Container SBOM (Syft)
        uses: anchore/sbom-action@v0
        with:
          image: valdrix/api:${{ github.sha }}
          format: cyclonedx-json
          output-file: ./sbom/valdrix-container-sbom.json
      
      # Vulnerability Scan
      - name: Scan SBOM for Vulnerabilities (Grype)
        uses: anchore/scan-action@v5
        with:
          sbom: ./sbom/valdrix-container-sbom.json
          fail-build: true
          severity-cutoff: high

      - name: Generate supply-chain provenance manifest
        run: |
          uv run python scripts/generate_provenance_manifest.py \
            --output ./provenance/supply-chain-manifest.json \
            --sbom-dir sbom
      
      # Upload as Artifacts
      - name: Upload supply-chain artifacts
        uses: actions/upload-artifact@v4
        with:
          name: supply-chain-evidence
          path: |
            ./sbom/
            ./provenance/
          retention-days: 90

      - name: Attest SBOM artifacts
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: "./sbom/*.json"

      - name: Attest provenance manifest
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: "./provenance/supply-chain-manifest.json"

      - name: Verify provenance attestations (release gate)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          uv run python scripts/verify_supply_chain_attestations.py \
            --repo "${GITHUB_REPOSITORY}" \
            --signer-workflow .github/workflows/sbom.yml \
            --artifact ./sbom/valdrix-python-sbom.json \
            --artifact ./sbom/valdrix-container-sbom.json \
            --artifact ./provenance/supply-chain-manifest.json
      
      # Intentionally do not push directly to main from CI.
      # SBOM artifacts are published through workflow artifacts/releases.
      
      # Upload to GitHub Security
      - name: Upload to GitHub Dependency Graph
        uses: actions/dependency-review-action@v4
        if: github.event_name == 'pull_request'

  compliance-report:
    name: Generate Compliance Report
    needs: generate-sbom
    runs-on: ubuntu-latest
    
    steps:
      - name: Download SBOM
        uses: actions/download-artifact@v4
        with:
          name: supply-chain-evidence
          path: ./evidence
      
      - name: Generate License Report
        run: |
          echo "# License Compliance Report" > compliance-report.md
          echo "Generated: $(date -u)" >> compliance-report.md
          echo "" >> compliance-report.md
          echo "## Python Dependencies" >> compliance-report.md
          jq -r '.components[] | "- \(.name)@\(.version): \(.licenses[0].license.id // "Unknown")"' \
            ./evidence/sbom/valdrix-python-sbom.json >> compliance-report.md 2>/dev/null || echo "- No components found" >> compliance-report.md
      
      - name: Upload Compliance Report
        uses: actions/upload-artifact@v4
        with:
          name: compliance-report
          path: compliance-report.md
