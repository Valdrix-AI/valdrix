============================= test session starts ==============================
platform linux -- Python 3.13.5, pytest-9.0.2, pluggy-1.6.0
rootdir: /home/daretechie/DevProject/GitHub/CloudSentinel-AI
configfile: pyproject.toml
plugins: anyio-4.12.1, mock-3.15.1, langsmith-0.6.2, respx-0.22.0, cov-7.0.0, asyncio-1.3.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 1871 items

tests/adapters/test_aws_adapter.py ..                                    [  0%]
tests/adapters/test_aws_cur.py F                                         [  0%]
tests/adapters/test_aws_cur_streaming.py F                               [  0%]
tests/adapters/test_aws_multitenant.py ......                            [  0%]
tests/adapters/test_azure_backend.py ..                                  [  0%]
tests/adapters/test_azure_unit.py ...                                    [  0%]
tests/adapters/test_connections_unit.py ..                               [  0%]
tests/adapters/test_cur_adapter_root.py .............                    [  1%]
tests/adapters/test_cur_automation.py ..                                 [  1%]
tests/adapters/test_gcp_backend.py ..                                    [  1%]
tests/adapters/test_multi_cloud_parity.py ..                             [  1%]
tests/analysis/test_azure_usage_analyzer.py ......                       [  2%]
tests/analysis/test_carbon_calc.py .........                             [  2%]
tests/analysis/test_carbon_calculator.py ..........                      [  3%]
tests/analysis/test_finops_analyzer.py ......                            [  3%]
tests/analysis/test_forecaster_markers.py FF                             [  3%]
tests/analysis/test_forecasting_realism.py F.F.F.                        [  4%]
tests/analysis/test_gcp_usage_analyzer.py .........                      [  4%]
tests/analysis/test_graviton_analyzer.py .                               [  4%]
tests/analysis/test_greenops_2.py ...                                    [  4%]
tests/analysis/test_prophet_forecaster.py .FF                            [  4%]
tests/analysis/test_scope3_accuracy.py ..                                [  4%]
tests/analysis/test_zombie_analyzer.py ............                      [  5%]
tests/analysis/test_zombie_coverage.py .....                             [  5%]
tests/analysis/test_zombie_detector.py ...................               [  6%]
tests/analysis/test_zombie_multi_cloud_plugins.py .....                  [  7%]
tests/analysis/test_zombie_orchestration.py ......                       [  7%]
tests/analysis/test_zombie_plugins.py .......                            [  7%]
tests/api/test_api_endpoints.py .............                            [  8%]
tests/api/test_health.py ...                                             [  8%]
tests/api/test_pagination.py .                                           [  8%]
tests/api/test_settings_api.py .........                                 [  9%]
tests/billing/test_billing.py ............                               [  9%]
tests/billing/test_financial_precision.py ..                             [  9%]
tests/billing/test_tier_guard.py ....................                    [ 11%]
tests/core/test_cache_service.py .......                                 [ 11%]
tests/core/test_circuit_breaker.py .............                         [ 12%]
tests/core/test_config_validation.py ..                                  [ 12%]
tests/core/test_delta_analysis.py ..............                         [ 12%]
tests/core/test_graceful_degradation.py ..                               [ 13%]
tests/core/test_llm_circuit_breaker.py ...........                       [ 13%]
tests/core/test_llm_guardrails_stress.py ....                            [ 13%]
tests/core/test_llm_security.py ...                                      [ 14%]
tests/core/test_middleware.py .......                                    [ 14%]
tests/core/test_public_assessment.py ..                                  [ 14%]
tests/core/test_rate_limit_stress.py ..                                  [ 14%]
tests/core/test_slack_service.py .......                                 [ 15%]
tests/core/test_usage_tracker.py ...........                             [ 15%]
tests/governance/test_audit_log.py ..................                    [ 16%]
tests/governance/test_audit_phase_1.py ...                               [ 16%]
tests/governance/test_audit_phase_2.py ....                              [ 16%]
tests/governance/test_audit_remediation_lifecycle.py ..                  [ 17%]
tests/governance/test_audit_verification.py ....                         [ 17%]
tests/governance/test_autonomous_logic.py ...                            [ 17%]
tests/governance/test_cleanup_logic.py .                                 [ 17%]
tests/governance/test_cost_aggregator.py ..                              [ 17%]
tests/governance/test_cost_cache_root.py ..............                  [ 18%]
tests/governance/test_cost_governance.py ..                              [ 18%]
tests/governance/test_cost_persistence.py x                              [ 18%]
tests/governance/test_detector.py .....                                  [ 18%]
tests/governance/test_detector_core.py ............                      [ 19%]
tests/governance/test_fail_closed_budget.py ..                           [ 19%]
tests/governance/test_hard_limit_enforcement.py ..                       [ 19%]
tests/governance/test_iam_auditor.py ..                                  [ 19%]
tests/governance/test_ingestion_pipeline.py .                            [ 19%]
tests/governance/test_job_processor.py ..........                        [ 20%]
tests/governance/test_remediation_atomicity.py ..                        [ 20%]
tests/governance/test_remediation_coverage.py ........                   [ 20%]
tests/governance/test_savings_autopilot.py ..                            [ 20%]
tests/governance/test_scheduler.py ...............                       [ 21%]
tests/governance/test_scheduler_concurrency.py .                         [ 21%]
tests/governance/test_verification.py ..                                 [ 21%]
tests/governance/test_webhook_retry.py .......                           [ 22%]
tests/integration/auth/test_auth_integration.py ..                       [ 22%]
tests/integration/billing/test_paystack_flows.py ...                     [ 22%]
tests/integration/optimization/test_remediation_lifecycle.py .           [ 22%]
tests/integration/test_cost_aggregation.py .                             [ 22%]
tests/integration/test_edge_cases.py ................                    [ 23%]
tests/integration/test_multi_cloud_report.py .                           [ 23%]
tests/integration/test_zombie_scan.py ........                           [ 23%]
tests/security/test_auth.py .....                                        [ 24%]
tests/security/test_blind_indexing.py ...                                [ 24%]
tests/security/test_due_diligence.py ............                        [ 25%]
tests/security/test_encryption.py ....                                   [ 25%]
tests/security/test_key_rotation.py .                                    [ 25%]
tests/security/test_multi_tenant_safety.py ..s.                          [ 25%]
tests/security/test_oidc_security.py ............                        [ 26%]
tests/security/test_privilege_escalation.py .....                        [ 26%]
tests/security/test_rls_security.py ....                                 [ 26%]
tests/security/test_role_assumption_security.py ...                      [ 26%]
tests/security/test_security_headers.py ...                              [ 26%]
tests/security/test_security_regression.py ..s...                        [ 27%]
tests/unit/adapters/aws/test_analytics.py ..                             [ 27%]
tests/unit/adapters/aws/test_compute.py ...                              [ 27%]
tests/unit/adapters/aws/test_containers.py ....                          [ 27%]
tests/unit/adapters/aws/test_database_plugins.py ...                     [ 27%]
tests/unit/adapters/aws/test_high_value.py ....                          [ 28%]
tests/unit/adapters/aws/test_infrastructure.py .........                 [ 28%]
tests/unit/adapters/aws/test_network.py .......                          [ 29%]
tests/unit/adapters/test_aws_adapter.py .....                            [ 29%]
tests/unit/adapters/test_aws_resource_explorer.py ....                   [ 29%]
tests/unit/adapters/test_aws_utils.py ......                             [ 29%]
tests/unit/adapters/test_azure_adapter.py ........                       [ 30%]
tests/unit/adapters/test_gcp_adapter.py .....                            [ 30%]
tests/unit/adapters/test_performance.py .                                [ 30%]
tests/unit/analysis/test_gcp_usage_analyzer_deep.py .........            [ 31%]
tests/unit/analysis/test_usage_analyzers_deep.py ....................... [ 32%]
.                                                                        [ 32%]
tests/unit/api/test_audit.py ...........                                 [ 32%]
tests/unit/api/v1/test_billing.py ..........                             [ 33%]
tests/unit/api/v1/test_carbon.py ......                                  [ 33%]
tests/unit/api/v1/test_health_dashboard_endpoints.py .                   [ 33%]
tests/unit/api/v1/test_usage_endpoints.py .                              [ 33%]
tests/unit/connections/test_cloud_connections_deep.py .............      [ 34%]
tests/unit/connections/test_instructions_audit.py ..                     [ 34%]
tests/unit/connections/test_oidc_deep.py ......                          [ 35%]
tests/unit/connections/test_organizations_deep.py ....                   [ 35%]
tests/unit/core/test_analyzer_audit.py ...                               [ 35%]
tests/unit/core/test_auth_audit.py ................                      [ 36%]
tests/unit/core/test_auth_core.py ...................                    [ 37%]
tests/unit/core/test_budget_manager_audit.py .....                       [ 37%]
tests/unit/core/test_cache.py ...                                        [ 37%]
tests/unit/core/test_cache_deep.py ..........                            [ 38%]
tests/unit/core/test_cache_resilience.py ..                              [ 38%]
tests/unit/core/test_celery_app.py .                                     [ 38%]
tests/unit/core/test_celery_app_exhaustive.py .....                      [ 38%]
tests/unit/core/test_circuit_breaker_resilience.py ....                  [ 38%]
tests/unit/core/test_cloud_connection.py ......                          [ 39%]
tests/unit/core/test_cloud_connection_audit.py .......                   [ 39%]
tests/unit/core/test_config_audit.py .F.....                             [ 39%]
tests/unit/core/test_config_validation.py F...........                   [ 40%]
tests/unit/core/test_currency.py ...                                     [ 40%]
tests/unit/core/test_currency_deep.py ...............                    [ 41%]
tests/unit/core/test_db_resilience.py ..                                 [ 41%]
tests/unit/core/test_db_session_deep.py ..............                   [ 42%]
tests/unit/core/test_dependencies.py ........                            [ 42%]
tests/unit/core/test_exceptions.py .................                     [ 43%]
tests/unit/core/test_forecaster_audit.py .FF.                            [ 43%]
tests/unit/core/test_guardrails_audit.py .....                           [ 44%]
tests/unit/core/test_health_missing_coverage.py ..............           [ 44%]
tests/unit/core/test_logging_audit.py .....                              [ 45%]
tests/unit/core/test_main.py ....                                        [ 45%]
tests/unit/core/test_middleware.py ..                                    [ 45%]
tests/unit/core/test_middleware_audit.py ....                            [ 45%]
tests/unit/core/test_models.py ..                                        [ 45%]
tests/unit/core/test_notifications_coverage.py ........                  [ 46%]
tests/unit/core/test_observability_deep.py ........                      [ 46%]
tests/unit/core/test_pricing_deep.py ...............                     [ 47%]
tests/unit/core/test_rate_limit.py ...                                   [ 47%]
tests/unit/core/test_rate_limit_audit.py ..........                      [ 48%]
tests/unit/core/test_rate_limit_expanded.py ............                 [ 48%]
tests/unit/core/test_safety_service_audit.py .....                       [ 49%]
tests/unit/core/test_security.py .....                                   [ 49%]
tests/unit/core/test_security_audit.py .................                 [ 50%]
tests/unit/core/test_security_gates_audit.py ....                        [ 50%]
tests/unit/core/test_sentry_deep.py ........                             [ 50%]
tests/unit/core/test_session.py ....                                     [ 51%]
tests/unit/core/test_session_audit.py ...........                        [ 51%]
tests/unit/core/test_tracing_deep.py .......                             [ 52%]
tests/unit/db/test_base_exhaustive.py ..                                 [ 52%]
tests/unit/db/test_session.py ....                                       [ 52%]
tests/unit/db/test_session_deep.py .......                               [ 52%]
tests/unit/db/test_session_exhaustive.py ............                    [ 53%]
tests/unit/db/test_session_missing_coverage.py .                         [ 53%]
tests/unit/governance/api/test_oidc.py ..                                [ 53%]
tests/unit/governance/api/test_public.py ...                             [ 53%]
tests/unit/governance/domain/jobs/handlers/test_base_handler.py .....    [ 54%]
tests/unit/governance/domain/jobs/handlers/test_billing_handler.py ..... [ 54%]
                                                                         [ 54%]
tests/unit/governance/domain/jobs/handlers/test_cost_handlers.py ......  [ 54%]
tests/unit/governance/domain/jobs/handlers/test_notification_handler.py . [ 54%]
....                                                                     [ 54%]
tests/unit/governance/domain/jobs/handlers/test_remediation_handler.py . [ 54%]
...                                                                      [ 55%]
tests/unit/governance/domain/jobs/handlers/test_zombie_handler.py ....   [ 55%]
tests/unit/governance/jobs/test_costs.py ...                             [ 55%]
tests/unit/governance/jobs/test_dunning.py .......                       [ 55%]
tests/unit/governance/jobs/test_finops.py .                              [ 55%]
tests/unit/governance/jobs/test_job_processor.py ....                    [ 56%]
tests/unit/governance/scheduler/test_cohorts.py ............             [ 56%]
tests/unit/governance/scheduler/test_orchestrator.py .....               [ 57%]
tests/unit/governance/scheduler/test_processors.py ..                    [ 57%]
tests/unit/governance/settings/test_activeops.py FF                      [ 57%]
tests/unit/governance/settings/test_activeops_deep.py FF                 [ 57%]
tests/unit/governance/settings/test_carbon.py FFF                        [ 57%]
tests/unit/governance/settings/test_connections.py .FFF.                 [ 57%]
tests/unit/governance/settings/test_governance_deep.py FF.               [ 57%]
tests/unit/governance/settings/test_llm_settings.py FF.                  [ 58%]
tests/unit/governance/settings/test_notifications.py FFF                 [ 58%]
tests/unit/governance/settings/test_onboard.py FFFF                      [ 58%]
tests/unit/governance/settings/test_onboard_deep.py FFFFFFF              [ 58%]
tests/unit/governance/settings/test_safety.py ..                         [ 58%]
tests/unit/governance/test_admin_api.py ......                           [ 59%]
tests/unit/governance/test_audit_logger_audit.py ....                    [ 59%]
tests/unit/governance/test_connections_api.py ...FFFFF.FFFFFFFFFFFF      [ 60%]
tests/unit/governance/test_jobs_api.py F....                             [ 60%]
tests/unit/governance/test_onboard_audit.py ...                          [ 61%]
tests/unit/llm/test_analyzer.py ..                                       [ 61%]
tests/unit/llm/test_analyzer_exhaustive.py ..................            [ 62%]
tests/unit/llm/test_budget_manager.py ...                                [ 62%]
tests/unit/llm/test_budget_manager_exhaustive.py .....                   [ 62%]
tests/unit/llm/test_circuit_breaker.py ...                               [ 62%]
tests/unit/llm/test_delta_analysis.py ...                                [ 62%]
tests/unit/llm/test_delta_analysis_exhaustive.py .............           [ 63%]
tests/unit/llm/test_factory.py ....                                      [ 63%]
tests/unit/llm/test_factory_audit.py ..............                      [ 64%]
tests/unit/llm/test_factory_exhaustive.py .......                        [ 64%]
tests/unit/llm/test_factory_modular.py .....                             [ 65%]
tests/unit/llm/test_guardrails_audit.py .........                        [ 65%]
tests/unit/llm/test_hybrid_scheduler.py ..                               [ 65%]
tests/unit/llm/test_hybrid_scheduler_exhaustive.py ..........            [ 66%]
tests/unit/llm/test_providers.py ....                                    [ 66%]
tests/unit/llm/test_usage_tracker_audit.py .........                     [ 66%]
tests/unit/llm/test_zombie_analyzer.py ...                               [ 67%]
tests/unit/llm/test_zombie_analyzer_exhaustive.py .........              [ 67%]
tests/unit/modules/notifications/test_notifications_comprehensive.py ... [ 67%]
....                                                                     [ 67%]
tests/unit/modules/optimization/adapters/aws/plugins/test_infrastructure_deep.py . [ 68%]
........                                                                 [ 68%]
tests/unit/modules/optimization/test_aws_compute_coverage.py ....        [ 68%]
tests/unit/modules/optimization/test_azure_optimization_coverage.py ...  [ 68%]
tests/unit/modules/optimization/test_finops_strategies.py ...            [ 69%]
tests/unit/modules/optimization/test_gcp_optimization_coverage.py ...    [ 69%]
tests/unit/modules/optimization/test_remediation_coverage.py ..          [ 69%]
tests/unit/modules/reporting/test_aggregator_deep.py .......             [ 69%]
tests/unit/modules/reporting/test_attribution_engine_deep.py ........    [ 70%]
tests/unit/modules/reporting/test_attribution_engine_extended.py xxxxxxx [ 70%]
xxxxxxxxxxxxx                                                            [ 71%]
tests/unit/modules/reporting/test_budget_alerts_deep.py .....            [ 71%]
tests/unit/modules/reporting/test_calculator_comprehensive.py .......... [ 71%]
......................                                                   [ 73%]
tests/unit/modules/reporting/test_carbon_scheduler.py ..                 [ 73%]
tests/unit/modules/reporting/test_carbon_scheduler_comprehensive.py .... [ 73%]
..........................................                               [ 75%]
tests/unit/modules/reporting/test_paystack_billing_coverage.py ...       [ 75%]
tests/unit/modules/reporting/test_reporting_service.py .......F.......   [ 76%]
tests/unit/modules/reporting/test_usage_api.py .                         [ 76%]
tests/unit/modules/reporting/test_webhook_retry.py ..................... [ 77%]
.....                                                                    [ 78%]
tests/unit/notifications/domain/test_email_service.py ......             [ 78%]
tests/unit/notifications/domain/test_slack_service.py ....               [ 78%]
tests/unit/notifications/test_services.py ...                            [ 78%]
tests/unit/optimization/test_remediation_guardrails.py ..                [ 78%]
tests/unit/optimization/test_remediation_service_audit.py ........       [ 79%]
tests/unit/optimization/test_unified_discovery.py ..                     [ 79%]
tests/unit/optimization/test_zombie_service_audit.py ...                 [ 79%]
tests/unit/remediation/test_circuit_breaker_deep.py ..........           [ 80%]
tests/unit/reporting/test_aggregator.py ..........                       [ 80%]
tests/unit/reporting/test_attribution_engine.py ...........              [ 81%]
tests/unit/reporting/test_billing_api.py ...................             [ 82%]
tests/unit/reporting/test_reporting_persistence_deep.py ..........FF     [ 82%]
tests/unit/services/adapters/test_adapter_factory.py ......              [ 83%]
tests/unit/services/adapters/test_aws_hardening.py .                     [ 83%]
tests/unit/services/adapters/test_azure_adapter.py .....                 [ 83%]
tests/unit/services/adapters/test_cost_cache.py ..........               [ 84%]
tests/unit/services/adapters/test_cur_adapter.py ...F.                   [ 84%]
tests/unit/services/adapters/test_rate_limiter.py ............           [ 84%]
tests/unit/services/billing/test_currency_service.py ........            [ 85%]
tests/unit/services/billing/test_dunning_service.py .......              [ 85%]
tests/unit/services/billing/test_paystack_billing.py .............       [ 86%]
tests/unit/services/carbon/test_budget_alerts.py ...........             [ 87%]
tests/unit/services/connections/test_organizations.py ...                [ 87%]
tests/unit/services/costs/test_attribution_engine.py .......             [ 87%]
tests/unit/services/jobs/test_job_handlers.py .........                  [ 88%]
tests/unit/services/llm/test_analyzer_expanded.py .........              [ 88%]
tests/unit/services/llm/test_guardrails_logic.py .............           [ 89%]
tests/unit/services/llm/test_hybrid_scheduler.py ...........             [ 89%]
tests/unit/services/llm/test_llm_logic.py ............                   [ 90%]
tests/unit/services/llm/test_llm_usage_tracker.py ......                 [ 90%]
tests/unit/services/llm/test_providers_exhaustive.py .............       [ 91%]
tests/unit/services/llm/test_usage_tracker_logic.py ...............      [ 92%]
tests/unit/services/llm/test_zombie_analyzer_logic.py ....               [ 92%]
tests/unit/services/notifications/test_email_service.py ......           [ 92%]
tests/unit/services/notifications/test_slack_integration.py ...........  [ 93%]
tests/unit/services/scheduler/test_celery_migration.py ..                [ 93%]
tests/unit/services/scheduler/test_processors_expanded.py .......        [ 93%]
tests/unit/services/scheduler/test_scheduler_processors.py .......       [ 94%]
tests/unit/services/test_upstash_cache.py .......                        [ 94%]
tests/unit/services/zombies/aws_provider/test_aws_detector.py ...        [ 94%]
tests/unit/services/zombies/azure_provider/test_azure_unattached_disks.py . [ 94%]
.                                                                        [ 94%]
tests/unit/services/zombies/azure_provider/test_orphaned_ips.py .        [ 94%]
tests/unit/services/zombies/google_provider/test_gcp_unattached_disks.py . [ 95%]
                                                                         [ 95%]
tests/unit/services/zombies/test_base.py ...                             [ 95%]
tests/unit/services/zombies/test_factory.py ....                         [ 95%]
tests/unit/services/zombies/test_remediation_service.py ..............   [ 96%]
tests/unit/services/zombies/test_zombie_service.py ......                [ 96%]
tests/unit/services/zombies/test_zombie_service_expanded.py ..           [ 96%]
tests/unit/shared/connections/test_oidc_service.py ....                  [ 96%]
tests/unit/shared/db/test_session_coverage.py ......                     [ 97%]
tests/unit/shared/llm/providers/test_base.py .....                       [ 97%]
tests/unit/shared/llm/test_pricing_data.py .....                         [ 97%]
tests/unit/shared/test_config_security.py ..                             [ 97%]
tests/unit/shared/test_core_auth_v2.py .........                         [ 98%]
tests/unit/tasks/test_scheduler_tasks_comprehensive.py .....             [ 98%]
tests/unit/test_hard_cap_service.py ...                                  [ 98%]
tests/unit/test_main_basic.py ...                                        [ 98%]
tests/unit/test_main_coverage.py .......                                 [ 99%]
tests/unit/test_pricing_phase36.py ..                                    [ 99%]
tests/unit/zombies/aws/test_compute_refactored.py ..                     [ 99%]
tests/unit/zombies/azure/test_idle_vms.py ..                             [ 99%]
tests/unit/zombies/gcp/test_idle_instances.py .....                      [ 99%]
tests/unit/zombies/test_tier_gating_phase8.py ....
ERROR: Coverage failure: total of 83 is less than fail-under=95
                                                                         [100%]

=================================== FAILURES ===================================
__________________________ test_ingest_latest_parquet __________________________

    @pytest.mark.asyncio
    async def test_ingest_latest_parquet():
        # 1. Create a mock connection
        conn = AWSConnection(
            tenant_id=uuid.uuid4(),
            aws_account_id="123456789012",
            role_arn="arn:aws:iam::123456789012:role/TestRole",
            external_id="vx-test",
            region="us-east-1"
        )
    
        # 2. Mock S3 Client and Session
        mock_s3 = AsyncMock()
    
        # Mock list_objects_v2 response
        mock_s3.list_objects_v2.return_value = {
            "Contents": [
                {"Key": "cur/report-202310.parquet", "LastModified": datetime(2023, 10, 2)}
            ]
        }
    
        # Mock/Simulate Parquet download
        df = pd.DataFrame(MOCK_CUR_DATA)
        parquet_buffer = io.BytesIO()
        df.to_parquet(parquet_buffer)
        parquet_buffer.seek(0)  # Reset buffer position to beginning
        parquet_bytes = parquet_buffer.getvalue()
    
        class MockStream:
            def __init__(self, data):
                self.data = data
                self.offset = 0
            async def __aenter__(self):
                return self
            async def __aexit__(self, exc_type, exc_val, exc_tb):
                pass
            async def read(self, amt):
                chunk = self.data[self.offset : self.offset + amt]
                self.offset += len(chunk)
                return chunk
    
        mock_s3.get_object.return_value = {"Body": MockStream(parquet_bytes)}
    
        # 3. Patch aioboto3.Session
        with patch("aioboto3.Session") as MockSession:
            session_instance = MockSession.return_value
            session_instance.client.return_value.__aenter__.return_value = mock_s3
    
            # Patch _get_credentials since it tries to instantiate MultiTenantAWSAdapter
            with patch.object(AWSCURAdapter, "_get_credentials", return_value={
                "AccessKeyId": "fake", "SecretAccessKey": "fake", "SessionToken": "fake"
            }):
                adapter = AWSCURAdapter(conn)
>               summary = await adapter.ingest_latest_parquet()
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/adapters/test_aws_cur.py:78: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
app/shared/adapters/aws_cur.py:230: in ingest_latest_parquet
    return self._process_parquet_streamingly(tmp_path)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.shared.adapters.aws_cur.AWSCURAdapter object at 0x78761ae0f4d0>
file_path = '/tmp/tmpcw9_5fxh.parquet'

    def _process_parquet_streamingly(self, file_path: str) -> CloudUsageSummary:
        """
        Processes a Parquet file using row groups to keep memory low.
        Aggregates metrics on the fly.
        """
        parquet_file = pq.ParquetFile(file_path)
    
        # Initialize Summary
        total_cost_usd = Decimal("0")
        by_service = {}
        by_region = {}
        by_tag = {}
        all_records = [] # Still keeping records for now, but could be limited if needed
    
        min_date = None
        max_date = None
    
        # AWS CUR Column Aliases
        CUR_COLUMNS = {
            "date": ["lineItem/UsageStartDate", "identity/TimeInterval", "line_item_usage_start_date"],
            "cost": ["lineItem/UnblendedCost", "line_item_unblended_cost"],
            "currency": ["lineItem/CurrencyCode", "line_item_currency_code"],
            "service": ["lineItem/ProductCode", "line_item_product_code", "product/ProductName"],
            "region": ["product/region", "lineItem/AvailabilityZone"],
            "usage_type": ["lineItem/UsageType"]
        }
    
        # Iterate through row groups
        for i in range(parquet_file.num_row_groups):
            table = parquet_file.read_row_group(i)
            df_chunk = table.to_pandas()
    
            # Resolve columns for this chunk
            col_map = {k: next((c for c in v if c in df_chunk.columns), None) for k, v in CUR_COLUMNS.items()}
            # Fallbacks for critical columns
            col_map["date"] = col_map["date"] or df_chunk.columns[0]
            col_map["cost"] = col_map["cost"] or "cost"
            col_map["service"] = col_map["service"] or "service"
    
            # Update date range
            chunk_min = pd.to_datetime(df_chunk[col_map["date"]].min()).date()
            chunk_max = pd.to_datetime(df_chunk[col_map["date"]].max()).date()
            min_date = min(min_date, chunk_min) if min_date else chunk_min
            max_date = max(max_date, chunk_max) if max_date else chunk_max
    
            # Process rows in chunk
            for _, row in df_chunk.iterrows():
                record = self._parse_row(row, col_map)
    
                # Safety valve: For massive files, we limit the records list to prevent OOM
                if len(all_records) < 100000:
                    all_records.append(record)
    
                # Aggregation
                total_cost_usd += record.amount
                by_service[record.service] = by_service.get(record.service, Decimal("0")) + record.amount
                by_region[record.region] = by_region.get(record.region, Decimal("0")) + record.amount
    
                for tk, tv in record.tags.items():
                    if tk not in by_tag:
                        by_tag[tk] = {}
                    by_tag[tk][tv] = by_tag[tk].get(tv, Decimal("0")) + record.amount
    
>       return CloudUsageSummary(
            tenant_id=str(self.connection.tenant_id),
            provider="aws",
            start_date=min_date or date.today(),
            end_date=max_date or date.today(),
            total_cost=total_cost_usd,
            records=all_records,
            by_service=by_service,
            by_region=by_region,
            by_tag=by_tag
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for CloudUsageSummary
E       start_date
E         Datetimes provided to dates should have zero time - e.g. be exact dates [type=date_from_datetime_inexact, input_value=<MagicMock name='mock.to_...)' id='132448652821904'>, input_type=MagicMock]
E           For further information visit https://errors.pydantic.dev/2.12/v/date_from_datetime_inexact
E       end_date
E         Datetimes provided to dates should have zero time - e.g. be exact dates [type=date_from_datetime_inexact, input_value=<MagicMock name='mock.to_...)' id='132448652821904'>, input_type=MagicMock]
E           For further information visit https://errors.pydantic.dev/2.12/v/date_from_datetime_inexact

app/shared/adapters/aws_cur.py:303: ValidationError
----------------------------- Captured stdout call -----------------------------
[2m[PHONE_REDACTED]T17:01:[PHONE_REDACTED]Z[0m [[32m[1minfo     [0m] [1mingesting_cur_file            [0m [36mkey[0m=[35m[REDACTED][0m
[2m[PHONE_REDACTED]T17:01:[PHONE_REDACTED]Z[0m [[31m[1merror    [0m] [1mcur_ingestion_failed          [0m [36merror[0m=[35m"2 validation errors for CloudUsageSummary\nstart_date\n  Datetimes provided to dates should have zero time - e.g. be exact dates [type=date_from_datetime_inexact, input_value=<MagicMock name='mock.to_...)' id='[PHONE_REDACTED]'>, input_type=MagicMock]\n    For further information visit https://errors.pydantic.dev/2.12/v/date_from_datetime_inexact\nend_date\n  Datetimes provided to dates should have zero time - e.g. be exact dates [type=date_from_datetime_inexact, input_value=<MagicMock name='mock.to_...)' id='[PHONE_REDACTED]'>, input_type=MagicMock]\n    For further information visit https://errors.pydantic.dev/2.12/v/date_from_datetime_inexact"[0m
_____________________ test_ingest_latest_parquet_streaming _____________________

    @pytest.mark.asyncio
    async def test_ingest_latest_parquet_streaming():
        # 1. Create a mock connection
        conn = AWSConnection(
            tenant_id=uuid.uuid4(),
            aws_account_id="123456789012",
            region="us-east-1"
        )
    
        # 2. Prepare Parquet Bytes
        df = pd.DataFrame(MOCK_CUR_DATA)
        parquet_buffer = io.BytesIO()
        # Write as multiple row groups to test chunked reading
        # PyArrow engine supports row_group_size
        df.to_parquet(parquet_buffer, row_group_size=2, engine="pyarrow")
        parquet_buffer.seek(0)  # Reset buffer position to beginning
        parquet_bytes = parquet_buffer.getvalue()
    
        # 3. Mock S3 Client
        mock_s3 = AsyncMock()
        mock_s3.list_objects_v2.return_value = {
            "Contents": [{"Key": "cur/test.parquet", "LastModified": datetime.now()}]
        }
    
        mock_s3.get_object.return_value = {"Body": MockStream(parquet_bytes)}
    
        # 4. Patch aioboto3.Session and _get_credentials
        with patch("aioboto3.Session") as MockSession:
            session_instance = MockSession.return_value
            session_instance.client.return_value.__aenter__.return_value = mock_s3
    
            with patch.object(AWSCURAdapter, "_get_credentials", return_value={
                "AccessKeyId": "fake", "SecretAccessKey": "fake", "SessionToken": "fake"
            }):
                adapter = AWSCURAdapter(conn)
>               summary = await adapter.ingest_latest_parquet()
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/adapters/test_aws_cur_streaming.py:71: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
app/shared/adapters/aws_cur.py:230: in ingest_latest_parquet
    return self._process_parquet_streamingly(tmp_path)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.shared.adapters.aws_cur.AWSCURAdapter object at 0x78761ae4ca50>
file_path = '/tmp/tmpw86clswe.parquet'

    def _process_parquet_streamingly(self, file_path: str) -> CloudUsageSummary:
        """
        Processes a Parquet file using row groups to keep memory low.
        Aggregates metrics on the fly.
        """
        parquet_file = pq.ParquetFile(file_path)
    
        # Initialize Summary
        total_cost_usd = Decimal("0")
        by_service = {}
        by_region = {}
        by_tag = {}
        all_records = [] # Still keeping records for now, but could be limited if needed
    
        min_date = None
        max_date = None
    
        # AWS CUR Column Aliases
        CUR_COLUMNS = {
            "date": ["lineItem/UsageStartDate", "identity/TimeInterval", "line_item_usage_start_date"],
            "cost": ["lineItem/UnblendedCost", "line_item_unblended_cost"],
            "currency": ["lineItem/CurrencyCode", "line_item_currency_code"],
            "service": ["lineItem/ProductCode", "line_item_product_code", "product/ProductName"],
            "region": ["product/region", "lineItem/AvailabilityZone"],
            "usage_type": ["lineItem/UsageType"]
        }
    
        # Iterate through row groups
        for i in range(parquet_file.num_row_groups):
            table = parquet_file.read_row_group(i)
            df_chunk = table.to_pandas()
    
            # Resolve columns for this chunk
            col_map = {k: next((c for c in v if c in df_chunk.columns), None) for k, v in CUR_COLUMNS.items()}
            # Fallbacks for critical columns
            col_map["date"] = col_map["date"] or df_chunk.columns[0]
            col_map["cost"] = col_map["cost"] or "cost"
            col_map["service"] = col_map["service"] or "service"
    
            # Update date range
            chunk_min = pd.to_datetime(df_chunk[col_map["date"]].min()).date()
            chunk_max = pd.to_datetime(df_chunk[col_map["date"]].max()).date()
            min_date = min(min_date, chunk_min) if min_date else chunk_min
            max_date = max(max_date, chunk_max) if max_date else chunk_max
    
            # Process rows in chunk
            for _, row in df_chunk.iterrows():
                record = self._parse_row(row, col_map)
    
                # Safety valve: For massive files, we limit the records list to prevent OOM
                if len(all_records) < 100000:
                    all_records.append(record)
    
                # Aggregation
                total_cost_usd += record.amount
                by_service[record.service] = by_service.get(record.service, Decimal("0")) + record.amount
                by_region[record.region] = by_region.get(record.region, Decimal("0")) + record.amount
    
                for tk, tv in record.tags.items():
                    if tk not in by_tag:
                        by_tag[tk] = {}
                    by_tag[tk][tv] = by_tag[tk].get(tv, Decimal("0")) + record.amount
    
>       return CloudUsageSummary(
            tenant_id=str(self.connection.tenant_id),
            provider="aws",
            start_date=min_date or date.today(),
            end_date=max_date or date.today(),
            total_cost=total_cost_usd,
            records=all_records,
            by_service=by_service,
            by_region=by_region,
            by_tag=by_tag
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for CloudUsageSummary
E       start_date
E         Datetimes provided to dates should have zero time - e.g. be exact dates [type=date_from_datetime_inexact, input_value=<MagicMock name='mock.to_...)' id='132448652821904'>, input_type=MagicMock]
E           For further information visit https://errors.pydantic.dev/2.12/v/date_from_datetime_inexact
E       end_date
E         Datetimes provided to dates should have zero time - e.g. be exact dates [type=date_from_datetime_inexact, input_value=<MagicMock name='mock.to_...)' id='132448652821904'>, input_type=MagicMock]
E           For further information visit https://errors.pydantic.dev/2.12/v/date_from_datetime_inexact

app/shared/adapters/aws_cur.py:303: ValidationError
----------------------------- Captured stdout call -----------------------------
[2m[PHONE_REDACTED]T17:01:[PHONE_REDACTED]Z[0m [[32m[1minfo     [0m] [1mingesting_cur_file            [0m [36mkey[0m=[35m[REDACTED][0m
[2m[PHONE_REDACTED]T17:01:[PHONE_REDACTED]Z[0m [[31m[1merror    [0m] [1mcur_ingestion_failed          [0m [36merror[0m=[35m"2 validation errors for CloudUsageSummary\nstart_date\n  Datetimes provided to dates should have zero time - e.g. be exact dates [type=date_from_datetime_inexact, input_value=<MagicMock name='mock.to_...)' id='[PHONE_REDACTED]'>, input_type=MagicMock]\n    For further information visit https://errors.pydantic.dev/2.12/v/date_from_datetime_inexact\nend_date\n  Datetimes provided to dates should have zero time - e.g. be exact dates [type=date_from_datetime_inexact, input_value=<MagicMock name='mock.to_...)' id='[PHONE_REDACTED]'>, input_type=MagicMock]\n    For further information visit https://errors.pydantic.dev/2.12/v/date_from_datetime_inexact"[0m
______________________ test_forecast_with_anomaly_markers ______________________

self = <AsyncMock name='mock.execute' id='132448650722816'>

    def assert_called(self):
        """assert that the mock was called at least once
        """
        if self.call_count == 0:
            msg = ("Expected '%s' to have been called." %
                   (self._mock_name or 'mock'))
>           raise AssertionError(msg)
E           AssertionError: Expected 'execute' to have been called.

../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/unittest/mock.py:948: AssertionError

During handling of the above exception, another exception occurred:

    @pytest.mark.asyncio
    async def test_forecast_with_anomaly_markers():
        """Test that anomaly markers are correctly fetched and passed to Prophet."""
        tenant_id = uuid4()
        db = AsyncMock()
    
        # 1. Mock anomaly markers in DB
        marker = AnomalyMarker(
            tenant_id=tenant_id,
            start_date=date(2025, 1, 15),
            end_date=date(2025, 1, 16),
            marker_type="PROMOTION_SPIKE",
            label="New Year Promo"
        )
    
        mock_result = MagicMock()
        mock_result.scalars.return_value.all.return_value = [marker]
        db.execute.return_value = mock_result
    
        # 2. Mock history (30 days)
        history = []
        for i in range(30):
            record = MagicMock()
            record.date = date(2025, 1, 1) + timedelta(days=i)
            record.amount = Decimal("100.0")
            record.service = "AmazonEC2"
            history.append(record)
    
        # 3. Create mock Prophet class and instance
        mock_prophet_instance = MagicMock()
        mock_prophet_instance.fit.return_value = mock_prophet_instance
    
        # Mock predict output
        import pandas as pd
        future_df = pd.DataFrame({
            'ds': pd.date_range(start='2025-01-31', periods=7),
            'yhat': [100.0] * 7,
            'yhat_lower': [90.0] * 7,
            'yhat_upper': [110.0] * 7
        })
        mock_prophet_instance.predict.return_value = future_df
        mock_prophet_instance.make_future_dataframe.return_value = future_df
    
        mock_prophet_class = MagicMock(return_value=mock_prophet_instance)
    
        # 4. Use patch with create=True to handle conditional import
        with patch("app.shared.analysis.forecaster.Prophet", mock_prophet_class, create=True), \
             patch("app.shared.analysis.forecaster.PROPHET_AVAILABLE", True):
    
            await SymbolicForecaster.forecast(
                history,
                days=7,
                db=db,
                tenant_id=tenant_id
            )
    
            # Verify Anomaly Marker query was called
>           db.execute.assert_called()
E           AssertionError: Expected 'execute' to have been called.

tests/analysis/test_forecaster_markers.py:67: AssertionError
----------------------------- Captured stdout call -----------------------------
[2m[PHONE_REDACTED]T17:01:[PHONE_REDACTED]Z[0m [[31m[1merror    [0m] [1mforecasting_failed_unexpectedly[0m [36merror[0m=[35m"'>' not supported between instances of 'MagicMock' and 'float'"[0m
______________________ test_holt_winters_confidence_bands ______________________

    @pytest.mark.asyncio
    async def test_holt_winters_confidence_bands():
        """Test that Holt-Winters fallback provides confidence bands."""
        # 1. Mock history (enough for HW but less than 14 for Prophet fallback)
        history = []
        for i in range(10):
            record = MagicMock()
            record.date = date(2025, 1, 1) + timedelta(days=i)
            record.amount = Decimal("100.0") + Decimal(str(i % 2))
            record.service = "AmazonEC2"
            history.append(record)
    
        # force PROPHET_AVAILABLE = False to trigger HW
        with pytest.MonkeyPatch().context() as mp:
            import app.shared.analysis.forecaster
            mp.setattr(app.shared.analysis.forecaster, "PROPHET_AVAILABLE", False)
    
            results = await SymbolicForecaster.forecast(history, days=7)
    
>           assert "Holt-Winters" in results["model"]
E           AssertionError: assert 'Holt-Winters' in 'None'

tests/analysis/test_forecaster_markers.py:95: AssertionError
----------------------------- Captured stdout call -----------------------------
[2m[PHONE_REDACTED]T17:01:[PHONE_REDACTED]Z[0m [[31m[1merror    [0m] [1mforecasting_failed_unexpectedly[0m [36merror[0m=[35m"'>' not supported between instances of 'MagicMock' and 'float'"[0m
_________________________ test_outlier_detection_logic _________________________

    @pytest.mark.asyncio
    async def test_outlier_detection_logic():
        """
        Test that the outlier detection correctly identifies a sharp cost spike.
        """
        history = generate_mock_history(30, spiky=True)
        df = pd.DataFrame([{"ds": r.date, "y": float(r.amount)} for r in history])
    
        # Access private method for testing logic
        detected_df = SymbolicForecaster._detect_outliers(df)
    
        anomalies = detected_df[detected_df['is_outlier']]
>       assert len(anomalies) >= 1
E       AssertionError: assert 0 >= 1
E        +  where 0 = len(<MagicMock name='mock.DataFrame().copy().__getitem__()' id='132448652349120'>)

tests/analysis/test_forecasting_realism.py:39: AssertionError
________________________ test_interval_growth_over_time ________________________

    @pytest.mark.asyncio
    async def test_interval_growth_over_time():
        """
        Statistical forecasts should generally become less certain (wider intervals) over time.
        """
        history = generate_mock_history(30, trend=5.0) # Add some volatility/trend
        result = await SymbolicForecaster.forecast(history, days=14)
    
        intervals = []
        for entry in result["forecast"]:
            intervals.append(float(entry["confidence_upper"] - entry["confidence_lower"]))
    
        # The last interval should be wider than the first (simplified check)
>       assert intervals[-1] > intervals[0]
               ^^^^^^^^^^^^^
E       IndexError: list index out of range

tests/analysis/test_forecasting_realism.py:72: IndexError
----------------------------- Captured stdout call -----------------------------
[2m[PHONE_REDACTED]T17:01:[PHONE_REDACTED]Z[0m [[31m[1merror    [0m] [1mforecasting_failed_unexpectedly[0m [36merror[0m=[35m"'>' not supported between instances of 'MagicMock' and 'float'"[0m
______________________ test_forecast_edge_cases_zero_cost ______________________

    @pytest.mark.asyncio
    async def test_forecast_edge_cases_zero_cost():
        """
        Test resilience to zero cost data.
        """
        history = [
            CostRecord(date=datetime.now() - timedelta(days=i), amount=Decimal("0.0"), service="ec2")
            for i in range(20)
        ]
        result = await SymbolicForecaster.forecast(history)
    
>       assert result["confidence"] != "error"
E       AssertionError: assert 'error' != 'error'

tests/analysis/test_forecasting_realism.py:99: AssertionError
----------------------------- Captured stdout call -----------------------------
[2m[PHONE_REDACTED]T17:01:[PHONE_REDACTED]Z[0m [[31m[1merror    [0m] [1mforecasting_failed_unexpectedly[0m [36merror[0m=[35m"'>' not supported between instances of 'MagicMock' and 'float'"[0m
_______________________ test_forecaster_prophet_success ________________________

    @pytest.mark.asyncio
    async def test_forecaster_prophet_success():
        # Create 20 days of data for Prophet (requires >= 14 in my implementation)
        history = [
            CostRecord(date=datetime.now() - timedelta(days=i), amount=Decimal(str(10.0 + (i % 7))), service="ec2")
            for i in range(20)
        ]
    
        # Mock Prophet since it may not be installed
        import pandas as pd
        from unittest.mock import MagicMock, patch
    
        mock_prophet_instance = MagicMock()
        mock_prophet_instance.fit.return_value = mock_prophet_instance
    
        future_df = pd.DataFrame({
            'ds': pd.date_range(start=datetime.now(), periods=5),
            'yhat': [15.0] * 5,
            'yhat_lower': [12.0] * 5,
            'yhat_upper': [18.0] * 5
        })
        mock_prophet_instance.predict.return_value = future_df
        mock_prophet_instance.make_future_dataframe.return_value = future_df
    
        mock_prophet_class = MagicMock(return_value=mock_prophet_instance)
    
        with patch("app.shared.analysis.forecaster.Prophet", mock_prophet_class, create=True), \
             patch("app.shared.analysis.forecaster.PROPHET_AVAILABLE", True):
    
            result = await SymbolicForecaster.forecast(history, days=5)
    
>           assert result["model"] == "Prophet"
E           AssertionError: assert 'None' == 'Prophet'
E             
E             - Prophet
E             + None

tests/analysis/test_prophet_forecaster.py:49: AssertionError
----------------------------- Captured stdout call -----------------------------
[2m[PHONE_REDACTED]T17:01:[PHONE_REDACTED]Z[0m [[31m[1merror    [0m] [1mforecasting_failed_unexpectedly[0m [36merror[0m=[35m"'>' not supported between instances of 'MagicMock' and 'float'"[0m
____________________ test_forecaster_fallback_holt_winters _____________________

    @pytest.mark.asyncio
    async def test_forecaster_fallback_holt_winters():
        # Create 10 days of data (too few for Prophet, but enough for HW)
        history = [
            CostRecord(date=datetime.now() - timedelta(days=i), amount=Decimal(str(10.0 + i)), service="ec2")
            for i in range(10)
        ]
        result = await SymbolicForecaster.forecast(history, days=3)
    
>       assert "Holt-Winters" in result["model"]
E       AssertionError: assert 'Holt-Winters' in 'None'

tests/analysis/test_prophet_forecaster.py:62: AssertionError
----------------------------- Captured stdout call -----------------------------
[2m[PHONE_REDACTED]T17:01:[PHONE_REDACTED]Z[0m [[31m[1merror    [0m] [1mforecasting_failed_unexpectedly[0m [36merror[0m=[35m"'>' not supported between instances of 'MagicMock' and 'float'"[0m
_____________________ test_settings_production_validation ______________________

    def test_settings_production_validation():
        # Production without CSRF secret should fail
        # We MUST ensure TESTING=False and DEBUG=False to trigger production validation
        with patch.dict("os.environ", {}, clear=True):
            with pytest.raises(ValueError) as exc:
                Settings(
                    DEBUG=False,
                    TESTING=False,
                    SUPABASE_JWT_SECRET="x"*32,
                    DATABASE_URL="postgresql://user:pass@host/db",
                    ENCRYPTION_KEY="k"*32,
                    KDF_SALT="s"*32,
                    CSRF_SECRET_KEY=None,
                )
>           assert "CSRF_SECRET_KEY must be set" in str(exc.value)
E           AssertionError: assert 'CSRF_SECRET_KEY must be set' in '1 validation error for Settings\nCSRF_SECRET_KEY\n  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]\n    For further information visit https://errors.pydantic.dev/2.12/v/string_type'
E            +  where '1 validation error for Settings\nCSRF_SECRET_KEY\n  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]\n    For further information visit https://errors.pydantic.dev/2.12/v/string_type' = str(1 validation error for Settings\nCSRF_SECRET_KEY\n  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]\n    For further information visit https://errors.pydantic.dev/2.12/v/string_type)
E            +    where 1 validation error for Settings\nCSRF_SECRET_KEY\n  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]\n    For further information visit https://errors.pydantic.dev/2.12/v/string_type = <ExceptionInfo 1 validation error for Settings\nCSRF_SECRET_KEY\n  Input should be a valid string [type=string_type, inp...ue=None, input_type=NoneType]\n    For further information visit https://errors.pydantic.dev/2.12/v/string_type tblen=3>.value

tests/unit/core/test_config_audit.py:31: AssertionError
_________ TestSettingsValidation.test_settings_missing_required_fields _________

self = <tests.unit.core.test_config_validation.TestSettingsValidation object at 0x787621122d50>

    def test_settings_missing_required_fields(self):
        """Test validation when required fields are missing."""
        # Ensure no env vars interfere by explicitly passing None and clearing env
        with patch.dict("os.environ", {}, clear=True):
            with pytest.raises(ValidationError) as exc:
                Settings(_env_file=None)
    
>           assert "DATABASE_URL" in str(exc.value)
E           AssertionError: assert 'DATABASE_URL' in '1 validation error for Settings\nSUPABASE_JWT_SECRET\n  Field required [type=missing, input_value={}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing'
E            +  where '1 validation error for Settings\nSUPABASE_JWT_SECRET\n  Field required [type=missing, input_value={}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing' = str(1 validation error for Settings\nSUPABASE_JWT_SECRET\n  Field required [type=missing, input_value={}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing)
E            +    where 1 validation error for Settings\nSUPABASE_JWT_SECRET\n  Field required [type=missing, input_value={}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing = <ExceptionInfo 1 validation error for Settings\nSUPABASE_JWT_SECRET\n  Field required [type=missing, input_value={}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.12/v/missing tblen=3>.value

tests/unit/core/test_config_validation.py:20: AssertionError
_______________________ test_forecaster_prophet_trigger ________________________

self = <AsyncMock name='_run_prophet' id='132448311476976'>

    def assert_called(self):
        """assert that the mock was called at least once
        """
        if self.call_count == 0:
            msg = ("Expected '%s' to have been called." %
                   (self._mock_name or 'mock'))
>           raise AssertionError(msg)
E           AssertionError: Expected '_run_prophet' to have been called.

../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/unittest/mock.py:948: AssertionError

During handling of the above exception, another exception occurred:

    def test_forecaster_prophet_trigger():
        """Verify that Sufficient data (>=14 days) triggers Prophet."""
        # 20 days of data
        history = [MagicMock(date=f"2026-01-{i:02d}", amount=10.0) for i in range(1, 21)]
    
        with patch("app.shared.analysis.forecaster.PROPHET_AVAILABLE", True):
            with patch.object(SymbolicForecaster, "_run_prophet", return_value={"model": "Prophet"}) as mock_prophet:
                import asyncio
                asyncio.run(SymbolicForecaster.forecast(history))
>               mock_prophet.assert_called()
E               AssertionError: Expected '_run_prophet' to have been called.

tests/unit/core/test_forecaster_audit.py:29: AssertionError
----------------------------- Captured stdout call -----------------------------
[2m[PHONE_REDACTED]T17:04:[PHONE_REDACTED]Z[0m [[31m[1merror    [0m] [1mforecasting_failed_unexpectedly[0m [36merror[0m=[35m"'>' not supported between instances of 'MagicMock' and 'float'"[0m
________________________ test_outlier_detection_3sigma _________________________

    def test_outlier_detection_3sigma():
        """Verify that sharp cost spikes are identified as outliers."""
        # Increase sample size to make 3-sigma detection more reliable
        data = {"ds": pd.date_range(start="2026-01-01", periods=20), "y": [100]*19 + [100000]}
        df = pd.DataFrame(data)
    
        result_df = SymbolicForecaster._detect_outliers(df)
        # Check the last element (index 19), which is the spike
        assert bool(result_df.iloc[19]["is_outlier"]) is True
>       assert bool(result_df.iloc[0]["is_outlier"]) is False
E       AssertionError: assert True is False
E        +  where True = bool(<MagicMock name='mock.DataFrame().copy().iloc.__getitem__().__getitem__()' id='132448311481680'>)

tests/unit/core/test_forecaster_audit.py:40: AssertionError
_________________ test_get_activeops_settings_creates_default __________________

self = <sqlalchemy.engine.base.Connection object at 0x7876082c0350>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x7876082c0650>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x787619864350>
parameters = [('0478c161926846fcaa4aaf18aabd7d17',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78760540c160>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: remediation_settings

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

async_client = <httpx.AsyncClient object at 0x7876082c01d0>
db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x78760a1687c0>
mock_user_id = '43d482d7-e41d-47cd-8429-2e7137084f75'
mock_tenant_id = '0478c161-9268-46fc-aa4a-af18aabd7d17'
app = <fastapi.applications.FastAPI object at 0x787621e96f90>

    @pytest.mark.asyncio
    async def test_get_activeops_settings_creates_default(async_client: AsyncClient, db, mock_user_id, mock_tenant_id, app):
        """GET /activeops should create default settings if they don't exist."""
        user_id = uuid.UUID(mock_user_id)
        tenant_id = uuid.UUID(mock_tenant_id)
        mock_user = CurrentUser(id=user_id, tenant_id=tenant_id, email="test@valdrix.io", role=UserRole.ADMIN)
    
        app.dependency_overrides[get_current_user] = lambda: mock_user
        try:
>           response = await async_client.get("/api/v1/settings/activeops")
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_activeops.py:16: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1768: in get
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:380: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/activeops.py:52: in get_activeops_settings
    result = await db.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78760540c160>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: remediation_settings
E               [SQL: SELECT remediation_settings.id, remediation_settings.tenant_id, remediation_settings.auto_pilot_enabled, remediation_settings.min_confidence_threshold, remediation_settings.max_deletions_per_hour, remediation_settings.simulation_mode, remediation_settings.hard_cap_enabled, remediation_settings.monthly_hard_cap_usd 
E               FROM remediation_settings 
E               WHERE remediation_settings.tenant_id = ?]
E               [parameters: ('0478c161926846fcaa4aaf18aabd7d17',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:04:45,510 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:04:45,511 INFO sqlalchemy.engine.Engine SELECT remediation_settings.id, remediation_settings.tenant_id, remediation_settings.auto_pilot_enabled, remediation_settings.min_confidence_threshold, remediation_settings.max_deletions_per_hour, remediation_settings.simulation_mode, remediation_settings.hard_cap_enabled, remediation_settings.monthly_hard_cap_usd 
FROM remediation_settings 
WHERE remediation_settings.tenant_id = ?
2026-02-08 18:04:45,512 INFO sqlalchemy.engine.Engine [generated in 0.00026s] ('0478c161926846fcaa4aaf18aabd7d17',)
2026-02-08 18:04:45,512 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/activeops", "method": "GET", "error_id": "4833edfb-138a-447c-a4e1-5ebeb5194df6", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:04:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: remediation_settings\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 380, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/activeops.py\", line 52, in get_activeops_settings\n    result = await db.execute(\n             ^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: remediation_settings\n[SQL: SELECT remediation_settings.id, remediation_settings.tenant_id, remediation_settings.auto_pilot_enabled, remediation_settings.min_confidence_threshold, remediation_settings.max_deletions_per_hour, remediation_settings.simulation_mode, remediation_settings.hard_cap_enabled, remediation_settings.monthly_hard_cap_usd \nFROM remediation_settings \nWHERE remediation_settings.tenant_id = ?]\n[parameters: ('0478c[PHONE_REDACTED]fcaa4aaf18aabd7d17',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT remediation_settings.id, remediation_settings.tenant_id, remediation_settings.auto_pilot_enabled, remediation_settings.min_confidence_threshold, remediation_settings.max_deletions_per_hour, remediation_settings.simulation_mode, remediation_settings.hard_cap_enabled, remediation_settings.monthly_hard_cap_usd 
FROM remediation_settings 
WHERE remediation_settings.tenant_id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00026s] ('0478c161926846fcaa4aaf18aabd7d17',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
________________________ test_update_activeops_settings ________________________

self = <sqlalchemy.engine.base.Connection object at 0x787606280ad0>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x787606281e50>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x787619864350>
parameters = [('908239f7ec9f4bdf86874a95343a13dd',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78760bb18fa0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: remediation_settings

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

async_client = <httpx.AsyncClient object at 0x787603ee6510>
db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x78760a169a90>
mock_user_id = '43933e13-f1c0-495c-8ecc-a48933e579d9'
mock_tenant_id = '908239f7-ec9f-4bdf-8687-4a95343a13dd'
app = <fastapi.applications.FastAPI object at 0x787621e96f90>

    @pytest.mark.asyncio
    async def test_update_activeops_settings(async_client: AsyncClient, db, mock_user_id, mock_tenant_id, app):
        """PUT /activeops should update existing settings."""
        user_id = uuid.UUID(mock_user_id)
        tenant_id = uuid.UUID(mock_tenant_id)
        mock_user = CurrentUser(id=user_id, tenant_id=tenant_id, email="test@valdrix.io", role=UserRole.ADMIN)
    
        settings = RemediationSettings(tenant_id=tenant_id, auto_pilot_enabled=False, min_confidence_threshold=0.95)
        db.add(settings)
        await db.commit()
    
        app.dependency_overrides[get_current_user] = lambda: mock_user
        try:
>           response = await async_client.put("/api/v1/settings/activeops", json={"auto_pilot_enabled": True, "min_confidence_threshold": 0.90})
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_activeops.py:36: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1896: in put
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/activeops.py:84: in update_activeops_settings
    result = await db.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78760bb18fa0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: remediation_settings
E               [SQL: SELECT remediation_settings.id, remediation_settings.tenant_id, remediation_settings.auto_pilot_enabled, remediation_settings.min_confidence_threshold, remediation_settings.max_deletions_per_hour, remediation_settings.simulation_mode, remediation_settings.hard_cap_enabled, remediation_settings.monthly_hard_cap_usd 
E               FROM remediation_settings 
E               WHERE remediation_settings.tenant_id = ?]
E               [parameters: ('908239f7ec9f4bdf86874a95343a13dd',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:04:46,881 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:04:46,882 INFO sqlalchemy.engine.Engine SELECT remediation_settings.id, remediation_settings.tenant_id, remediation_settings.auto_pilot_enabled, remediation_settings.min_confidence_threshold, remediation_settings.max_deletions_per_hour, remediation_settings.simulation_mode, remediation_settings.hard_cap_enabled, remediation_settings.monthly_hard_cap_usd 
FROM remediation_settings 
WHERE remediation_settings.tenant_id = ?
2026-02-08 18:04:46,882 INFO sqlalchemy.engine.Engine [cached since 1.37s ago] ('908239f7ec9f4bdf86874a95343a13dd',)
2026-02-08 18:04:46,882 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/activeops", "method": "PUT", "error_id": "df771a96-07b7-4b51-86bc-7235db425ddf", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:04:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: remediation_settings\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/activeops.py\", line 84, in update_activeops_settings\n    result = await db.execute(\n             ^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: remediation_settings\n[SQL: SELECT remediation_settings.id, remediation_settings.tenant_id, remediation_settings.auto_pilot_enabled, remediation_settings.min_confidence_threshold, remediation_settings.max_deletions_per_hour, remediation_settings.simulation_mode, remediation_settings.hard_cap_enabled, remediation_settings.monthly_hard_cap_usd \nFROM remediation_settings \nWHERE remediation_settings.tenant_id = ?]\n[parameters: ('[PHONE_REDACTED]f7ec9f4bdf[PHONE_REDACTED]a[PHONE_REDACTED]a13dd',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT remediation_settings.id, remediation_settings.tenant_id, remediation_settings.auto_pilot_enabled, remediation_settings.min_confidence_threshold, remediation_settings.max_deletions_per_hour, remediation_settings.simulation_mode, remediation_settings.hard_cap_enabled, remediation_settings.monthly_hard_cap_usd 
FROM remediation_settings 
WHERE remediation_settings.tenant_id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 1.37s ago] ('908239f7ec9f4bdf86874a95343a13dd',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
____________________ test_activeops_settings_full_lifecycle ____________________

self = <sqlalchemy.engine.base.Connection object at 0x787606281a90>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x787606280590>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x787619864350>
parameters = [('5cb545428581473ba43613b4445f070c',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x7876048043a0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: remediation_settings

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

async_client = <httpx.AsyncClient object at 0x787606280710>
db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x78760a1680c0>
mock_user_id = '2916653e-579e-417c-8260-cc94f35d1344'
mock_tenant_id = '5cb54542-8581-473b-a436-13b4445f070c'
app = <fastapi.applications.FastAPI object at 0x787621e96f90>

    @pytest.mark.asyncio
    async def test_activeops_settings_full_lifecycle(async_client: AsyncClient, db, mock_user_id, mock_tenant_id, app):
        """Deep test for ActiveOps settings covering all branches."""
        user_id = uuid.UUID(mock_user_id)
        tenant_id = uuid.UUID(mock_tenant_id)
        mock_user = CurrentUser(id=user_id, tenant_id=tenant_id, email="test@activeops.io", role=UserRole.ADMIN)
    
        app.dependency_overrides[get_current_user] = lambda: mock_user
    
        try:
            # 1. GET - Should create default (Missing lines 57-72)
>           response = await async_client.get("/api/v1/settings/activeops")
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_activeops_deep.py:19: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1768: in get
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:380: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/activeops.py:52: in get_activeops_settings
    result = await db.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x7876048043a0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: remediation_settings
E               [SQL: SELECT remediation_settings.id, remediation_settings.tenant_id, remediation_settings.auto_pilot_enabled, remediation_settings.min_confidence_threshold, remediation_settings.max_deletions_per_hour, remediation_settings.simulation_mode, remediation_settings.hard_cap_enabled, remediation_settings.monthly_hard_cap_usd 
E               FROM remediation_settings 
E               WHERE remediation_settings.tenant_id = ?]
E               [parameters: ('5cb545428581473ba43613b4445f070c',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:04:48,429 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:04:48,429 INFO sqlalchemy.engine.Engine SELECT remediation_settings.id, remediation_settings.tenant_id, remediation_settings.auto_pilot_enabled, remediation_settings.min_confidence_threshold, remediation_settings.max_deletions_per_hour, remediation_settings.simulation_mode, remediation_settings.hard_cap_enabled, remediation_settings.monthly_hard_cap_usd 
FROM remediation_settings 
WHERE remediation_settings.tenant_id = ?
2026-02-08 18:04:48,430 INFO sqlalchemy.engine.Engine [cached since 2.918s ago] ('5cb545428581473ba43613b4445f070c',)
2026-02-08 18:04:48,430 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/activeops", "method": "GET", "error_id": "834e019c-d[PHONE_REDACTED]f4b-10b406facd6f", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:04:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: remediation_settings\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 380, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/activeops.py\", line 52, in get_activeops_settings\n    result = await db.execute(\n             ^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: remediation_settings\n[SQL: SELECT remediation_settings.id, remediation_settings.tenant_id, remediation_settings.auto_pilot_enabled, remediation_settings.min_confidence_threshold, remediation_settings.max_deletions_per_hour, remediation_settings.simulation_mode, remediation_settings.hard_cap_enabled, remediation_settings.monthly_hard_cap_usd \nFROM remediation_settings \nWHERE remediation_settings.tenant_id = ?]\n[parameters: ('5cb[PHONE_REDACTED]ba[PHONE_REDACTED]b4445f070c',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT remediation_settings.id, remediation_settings.tenant_id, remediation_settings.auto_pilot_enabled, remediation_settings.min_confidence_threshold, remediation_settings.max_deletions_per_hour, remediation_settings.simulation_mode, remediation_settings.hard_cap_enabled, remediation_settings.monthly_hard_cap_usd 
FROM remediation_settings 
WHERE remediation_settings.tenant_id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 2.918s ago] ('5cb545428581473ba43613b4445f070c',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
______________ test_update_activeops_settings_creates_if_missing _______________

self = <sqlalchemy.engine.base.Connection object at 0x787619981910>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x787619980c50>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x787619864350>
parameters = [('0cc2591b504b4334b5d620f3b668a7e2',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787609c5fca0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: remediation_settings

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

async_client = <httpx.AsyncClient object at 0x7876062828d0>
db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x78760a0dfd20>
mock_user_id = '1a001ee0-9179-4312-a17e-3f68976c3e6e'
mock_tenant_id = 'f3ecdc8f-88ea-4ff7-b16b-0868220cde1f'
app = <fastapi.applications.FastAPI object at 0x787621e96f90>

    @pytest.mark.asyncio
    async def test_update_activeops_settings_creates_if_missing(async_client: AsyncClient, db, mock_user_id, mock_tenant_id, app):
        """PUT /activeops should create settings if they don't exist (edge case)."""
        user_id = uuid.UUID(mock_user_id)
        # Use a fresh tenant ID to ensure settings don't exist
        tenant_id = uuid.uuid4()
        mock_user = CurrentUser(id=user_id, tenant_id=tenant_id, email="test-new@activeops.io", role=UserRole.ADMIN)
    
        app.dependency_overrides[get_current_user] = lambda: mock_user
        try:
            update_data = {"auto_pilot_enabled": True, "min_confidence_threshold": 0.75}
>           response = await async_client.put("/api/v1/settings/activeops", json=update_data)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_activeops_deep.py:63: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1896: in put
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/activeops.py:84: in update_activeops_settings
    result = await db.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787609c5fca0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: remediation_settings
E               [SQL: SELECT remediation_settings.id, remediation_settings.tenant_id, remediation_settings.auto_pilot_enabled, remediation_settings.min_confidence_threshold, remediation_settings.max_deletions_per_hour, remediation_settings.simulation_mode, remediation_settings.hard_cap_enabled, remediation_settings.monthly_hard_cap_usd 
E               FROM remediation_settings 
E               WHERE remediation_settings.tenant_id = ?]
E               [parameters: ('0cc2591b504b4334b5d620f3b668a7e2',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:04:49,820 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:04:49,821 INFO sqlalchemy.engine.Engine SELECT remediation_settings.id, remediation_settings.tenant_id, remediation_settings.auto_pilot_enabled, remediation_settings.min_confidence_threshold, remediation_settings.max_deletions_per_hour, remediation_settings.simulation_mode, remediation_settings.hard_cap_enabled, remediation_settings.monthly_hard_cap_usd 
FROM remediation_settings 
WHERE remediation_settings.tenant_id = ?
2026-02-08 18:04:49,821 INFO sqlalchemy.engine.Engine [cached since 4.31s ago] ('0cc2591b504b4334b5d620f3b668a7e2',)
2026-02-08 18:04:49,822 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/activeops", "method": "PUT", "error_id": "7fb445ed-93a[PHONE_REDACTED]b87-80aa38f44f22", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:04:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: remediation_settings\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/activeops.py\", line 84, in update_activeops_settings\n    result = await db.execute(\n             ^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: remediation_settings\n[SQL: SELECT remediation_settings.id, remediation_settings.tenant_id, remediation_settings.auto_pilot_enabled, remediation_settings.min_confidence_threshold, remediation_settings.max_deletions_per_hour, remediation_settings.simulation_mode, remediation_settings.hard_cap_enabled, remediation_settings.monthly_hard_cap_usd \nFROM remediation_settings \nWHERE remediation_settings.tenant_id = ?]\n[parameters: ('0cc2591b504b4334b5d620f3b668a7e2',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT remediation_settings.id, remediation_settings.tenant_id, remediation_settings.auto_pilot_enabled, remediation_settings.min_confidence_threshold, remediation_settings.max_deletions_per_hour, remediation_settings.simulation_mode, remediation_settings.hard_cap_enabled, remediation_settings.monthly_hard_cap_usd 
FROM remediation_settings 
WHERE remediation_settings.tenant_id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 4.31s ago] ('0cc2591b504b4334b5d620f3b668a7e2',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
___________________ test_get_carbon_settings_creates_default ___________________

self = <sqlalchemy.engine.base.Connection object at 0x787619980650>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x787619980410>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x7876107ad650>
parameters = [('2eb3c3db25c4418087c872328bd3163f',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787609eb7ee0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: carbon_settings

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

async_client = <httpx.AsyncClient object at 0x787619981c10>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x78760a0df4d0>

    @pytest.mark.asyncio
    async def test_get_carbon_settings_creates_default(async_client: AsyncClient, db_session):
        """Test that GET /api/v1/settings/carbon creates default settings if none exist."""
>       response = await async_client.get("/api/v1/settings/carbon")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_carbon.py:28: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1768: in get
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:380: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/carbon.py:60: in get_carbon_settings
    result = await db.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787609eb7ee0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: carbon_settings
E               [SQL: SELECT carbon_settings.id, carbon_settings.tenant_id, carbon_settings.carbon_budget_kg, carbon_settings.alert_threshold_percent, carbon_settings.default_region, carbon_settings.email_enabled, carbon_settings.email_recipients, carbon_settings.last_alert_sent, carbon_settings.created_at, carbon_settings.updated_at 
E               FROM carbon_settings 
E               WHERE carbon_settings.tenant_id = ?]
E               [parameters: ('2eb3c3db25c4418087c872328bd3163f',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:04:51,229 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:04:51,231 INFO sqlalchemy.engine.Engine SELECT carbon_settings.id, carbon_settings.tenant_id, carbon_settings.carbon_budget_kg, carbon_settings.alert_threshold_percent, carbon_settings.default_region, carbon_settings.email_enabled, carbon_settings.email_recipients, carbon_settings.last_alert_sent, carbon_settings.created_at, carbon_settings.updated_at 
FROM carbon_settings 
WHERE carbon_settings.tenant_id = ?
2026-02-08 18:04:51,231 INFO sqlalchemy.engine.Engine [generated in 0.00025s] ('2eb3c3db25c4418087c872328bd3163f',)
2026-02-08 18:04:51,232 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/carbon", "method": "GET", "error_id": "0c9ec785-d[PHONE_REDACTED]b-a918-cb6d7fc7ef36", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:04:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: carbon_settings\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 380, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/carbon.py\", line 60, in get_carbon_settings\n    result = await db.execute(\n             ^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: carbon_settings\n[SQL: SELECT carbon_settings.id, carbon_settings.tenant_id, carbon_settings.carbon_budget_kg, carbon_settings.alert_threshold_percent, carbon_settings.default_region, carbon_settings.email_enabled, carbon_settings.email_recipients, carbon_settings.last_alert_sent, carbon_settings.created_at, carbon_settings.updated_at \nFROM carbon_settings \nWHERE carbon_settings.tenant_id = ?]\n[parameters: ('2eb3c3db25c[PHONE_REDACTED]c[PHONE_REDACTED]bd3163f',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT carbon_settings.id, carbon_settings.tenant_id, carbon_settings.carbon_budget_kg, carbon_settings.alert_threshold_percent, carbon_settings.default_region, carbon_settings.email_enabled, carbon_settings.email_recipients, carbon_settings.last_alert_sent, carbon_settings.created_at, carbon_settings.updated_at 
FROM carbon_settings 
WHERE carbon_settings.tenant_id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00025s] ('2eb3c3db25c4418087c872328bd3163f',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
_________________________ test_update_carbon_settings __________________________

self = <sqlalchemy.engine.base.Connection object at 0x78761957a750>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x78761957a510>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x7876107ad650>
parameters = [('40f2b659d31c4678aa63d83ec02ffe85',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787609944e20>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: carbon_settings

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

async_client = <httpx.AsyncClient object at 0x7876199813d0>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x78760a16b4d0>
mock_user = <MagicMock id='132448362002960'>

    @pytest.mark.asyncio
    async def test_update_carbon_settings(async_client: AsyncClient, db_session, mock_user):
        """Test PUT /api/v1/settings/carbon updates existing settings."""
        # First create settings
        settings = CarbonSettings(
            tenant_id=mock_user.tenant_id,
            carbon_budget_kg=50.0,
            alert_threshold_percent=50,
            default_region="eu-west-1"
        )
        db_session.add(settings)
        await db_session.commit()
    
        update_data = {
            "carbon_budget_kg": 200.0,
            "alert_threshold_percent": 90,
            "default_region": "us-west-2",
            "email_enabled": True,
            "email_recipients": "alerts@example.com"
        }
    
>       response = await async_client.put("/api/v1/settings/carbon", json=update_data)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_carbon.py:62: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1896: in put
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/carbon.py:98: in update_carbon_settings
    result = await db.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787609944e20>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: carbon_settings
E               [SQL: SELECT carbon_settings.id, carbon_settings.tenant_id, carbon_settings.carbon_budget_kg, carbon_settings.alert_threshold_percent, carbon_settings.default_region, carbon_settings.email_enabled, carbon_settings.email_recipients, carbon_settings.last_alert_sent, carbon_settings.created_at, carbon_settings.updated_at 
E               FROM carbon_settings 
E               WHERE carbon_settings.tenant_id = ?]
E               [parameters: ('40f2b659d31c4678aa63d83ec02ffe85',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:04:52,601 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:04:52,602 INFO sqlalchemy.engine.Engine SELECT carbon_settings.id, carbon_settings.tenant_id, carbon_settings.carbon_budget_kg, carbon_settings.alert_threshold_percent, carbon_settings.default_region, carbon_settings.email_enabled, carbon_settings.email_recipients, carbon_settings.last_alert_sent, carbon_settings.created_at, carbon_settings.updated_at 
FROM carbon_settings 
WHERE carbon_settings.tenant_id = ?
2026-02-08 18:04:52,602 INFO sqlalchemy.engine.Engine [cached since 1.371s ago] ('40f2b659d31c4678aa63d83ec02ffe85',)
2026-02-08 18:04:52,603 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/carbon", "method": "PUT", "error_id": "714f63d[PHONE_REDACTED]ece-969a-8fe860dd8c43", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:04:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: carbon_settings\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/carbon.py\", line 98, in update_carbon_settings\n    result = await db.execute(\n             ^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: carbon_settings\n[SQL: SELECT carbon_settings.id, carbon_settings.tenant_id, carbon_settings.carbon_budget_kg, carbon_settings.alert_threshold_percent, carbon_settings.default_region, carbon_settings.email_enabled, carbon_settings.email_recipients, carbon_settings.last_alert_sent, carbon_settings.created_at, carbon_settings.updated_at \nFROM carbon_settings \nWHERE carbon_settings.tenant_id = ?]\n[parameters: ('40f2b659d31c4678aa63d83ec02ffe85',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT carbon_settings.id, carbon_settings.tenant_id, carbon_settings.carbon_budget_kg, carbon_settings.alert_threshold_percent, carbon_settings.default_region, carbon_settings.email_enabled, carbon_settings.email_recipients, carbon_settings.last_alert_sent, carbon_settings.created_at, carbon_settings.updated_at 
FROM carbon_settings 
WHERE carbon_settings.tenant_id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 1.371s ago] ('40f2b659d31c4678aa63d83ec02ffe85',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
________________ test_update_carbon_settings_creates_if_missing ________________

self = <sqlalchemy.engine.base.Connection object at 0x78761957b590>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x78761957b710>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x7876107ad650>
parameters = [('e7be5f4a8b5c4f808360a6c65b592c1d',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787609e35a80>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: carbon_settings

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

async_client = <httpx.AsyncClient object at 0x787602f67890>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x78760670f4d0>

    @pytest.mark.asyncio
    async def test_update_carbon_settings_creates_if_missing(async_client: AsyncClient, db_session):
        """Test PUT /api/v1/settings/carbon creates settings if they don't exist yet."""
        update_data = {
            "carbon_budget_kg": 150.0,
            "alert_threshold_percent": 75,
            "default_region": "ap-southeast-1"
        }
    
>       response = await async_client.put("/api/v1/settings/carbon", json=update_data)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_carbon.py:83: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1896: in put
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/carbon.py:98: in update_carbon_settings
    result = await db.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787609e35a80>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: carbon_settings
E               [SQL: SELECT carbon_settings.id, carbon_settings.tenant_id, carbon_settings.carbon_budget_kg, carbon_settings.alert_threshold_percent, carbon_settings.default_region, carbon_settings.email_enabled, carbon_settings.email_recipients, carbon_settings.last_alert_sent, carbon_settings.created_at, carbon_settings.updated_at 
E               FROM carbon_settings 
E               WHERE carbon_settings.tenant_id = ?]
E               [parameters: ('e7be5f4a8b5c4f808360a6c65b592c1d',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:04:54,419 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:04:54,419 INFO sqlalchemy.engine.Engine SELECT carbon_settings.id, carbon_settings.tenant_id, carbon_settings.carbon_budget_kg, carbon_settings.alert_threshold_percent, carbon_settings.default_region, carbon_settings.email_enabled, carbon_settings.email_recipients, carbon_settings.last_alert_sent, carbon_settings.created_at, carbon_settings.updated_at 
FROM carbon_settings 
WHERE carbon_settings.tenant_id = ?
2026-02-08 18:04:54,420 INFO sqlalchemy.engine.Engine [cached since 3.188s ago] ('e7be5f4a8b5c4f808360a6c65b592c1d',)
2026-02-08 18:04:54,420 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/carbon", "method": "PUT", "error_id": "baff027d-[PHONE_REDACTED]b-af62-23b322c61ac2", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:04:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: carbon_settings\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/carbon.py\", line 98, in update_carbon_settings\n    result = await db.execute(\n             ^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: carbon_settings\n[SQL: SELECT carbon_settings.id, carbon_settings.tenant_id, carbon_settings.carbon_budget_kg, carbon_settings.alert_threshold_percent, carbon_settings.default_region, carbon_settings.email_enabled, carbon_settings.email_recipients, carbon_settings.last_alert_sent, carbon_settings.created_at, carbon_settings.updated_at \nFROM carbon_settings \nWHERE carbon_settings.tenant_id = ?]\n[parameters: ('e7be5f4a8b5c4f[PHONE_REDACTED]a6c65b592c1d',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT carbon_settings.id, carbon_settings.tenant_id, carbon_settings.carbon_budget_kg, carbon_settings.alert_threshold_percent, carbon_settings.default_region, carbon_settings.email_enabled, carbon_settings.email_recipients, carbon_settings.last_alert_sent, carbon_settings.created_at, carbon_settings.updated_at 
FROM carbon_settings 
WHERE carbon_settings.tenant_id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 3.188s ago] ('e7be5f4a8b5c4f808360a6c65b592c1d',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
__________________________ test_create_aws_connection __________________________

self = <sqlalchemy.engine.base.Connection object at 0x7876197fd910>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x78761957abd0>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x7876073c7b50>
parameters = [('4e6aa2b57135453288700225d97e06d6', '123456789012')]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x7876109e1e40>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: aws_connections

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

async_client = <httpx.AsyncClient object at 0x78761957b4d0>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x78760670c7c0>
mock_user = <MagicMock id='132448362001952'>

    @pytest.mark.asyncio
    async def test_create_aws_connection(async_client: AsyncClient, db_session, mock_user):
        """Test creating an AWS connection (all tiers)."""
        payload = {
            "aws_account_id": "123456789012",
            "role_arn": "arn:aws:iam::123456789012:role/Valdrix",
            "external_id": "vx-" + "a" * 32,
            "region": "us-east-1"
        }
>       response = await async_client.post("/api/v1/settings/connections/aws", json=payload)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_connections.py:45: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/connections.py:117: in create_aws_connection
    existing = await db.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x7876109e1e40>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: aws_connections
E               [SQL: SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
E               FROM aws_connections 
E               WHERE aws_connections.tenant_id = ? AND aws_connections.aws_account_id = ?]
E               [parameters: ('4e6aa2b57135453288700225d97e06d6', '123456789012')]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:04:56,326 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:04:56,328 INFO sqlalchemy.engine.Engine SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
FROM aws_connections 
WHERE aws_connections.tenant_id = ? AND aws_connections.aws_account_id = ?
2026-02-08 18:04:56,328 INFO sqlalchemy.engine.Engine [generated in 0.00029s] ('4e6aa2b57135453288700225d97e06d6', '123456789012')
2026-02-08 18:04:56,329 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/connections/aws", "method": "POST", "error_id": "ac3c621e-[PHONE_REDACTED]b34-97fb-40fd6e[PHONE_REDACTED]", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:04:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: aws_connections\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 117, in create_aws_connection\n    existing = await db.execute(\n               ^^^^^^^^^^^^^^^^^\n    ...<4 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: aws_connections\n[SQL: SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at \nFROM aws_connections \nWHERE aws_connections.tenant_id = ? AND aws_connections.aws_account_id = ?]\n[parameters: ('4e6aa2b[PHONE_REDACTED]d97e06d6', '[PHONE_REDACTED]')]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
FROM aws_connections 
WHERE aws_connections.tenant_id = ? AND aws_connections.aws_account_id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00029s] ('4e6aa2b57135453288700225d97e06d6', '123456789012')
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
_______________ test_create_azure_connection_denied_on_free_tier _______________

self = <sqlalchemy.engine.base.Connection object at 0x7876195e5cd0>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x7876197fd0d0>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x7876199a9850>
parameters = [('33d276540695478eb5131bb249b382a3',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78760991fdc0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: tenants

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

async_client = <httpx.AsyncClient object at 0x78761957b050>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x78760504ef20>
mock_user = <MagicMock id='132448362001616'>

    @pytest.mark.asyncio
    async def test_create_azure_connection_denied_on_free_tier(async_client: AsyncClient, db_session, mock_user):
        """Test Azure connection denied for Free tier."""
        # Ensure tenant is on FREE plan
        tenant = Tenant(id=mock_user.tenant_id, name="Free Tenant", plan=PricingTier.FREE.value)
        db_session.add(tenant)
        await db_session.commit()
    
        payload = {
            "name": "Azure Sub",
            "subscription_id": str(uuid.uuid4()),
            "azure_tenant_id": str(uuid.uuid4()),
            "client_id": str(uuid.uuid4()),
            "client_secret": "secret"
        }
>       response = await async_client.post("/api/v1/settings/connections/azure", json=payload)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_connections.py:68: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/connections.py:302: in create_azure_connection
    await check_growth_tier(current_user, db)
app/modules/governance/api/v1/settings/connections.py:52: in check_growth_tier
    result = await db.execute(select(Tenant).where(Tenant.id == user.tenant_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78760991fdc0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: tenants
E               [SQL: SELECT tenants.id, tenants.name, tenants.name_bidx, tenants."plan", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at 
E               FROM tenants 
E               WHERE tenants.id = ?]
E               [parameters: ('33d276540695478eb5131bb249b382a3',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:04:57,763 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:04:57,765 INFO sqlalchemy.engine.Engine SELECT tenants.id, tenants.name, tenants.name_bidx, tenants."plan", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at 
FROM tenants 
WHERE tenants.id = ?
2026-02-08 18:04:57,765 INFO sqlalchemy.engine.Engine [generated in 0.00026s] ('33d276540695478eb5131bb249b382a3',)
2026-02-08 18:04:57,766 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/connections/azure", "method": "POST", "error_id": "ef952dc9-b50e-[PHONE_REDACTED]b9b-b70cba47f6ab", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:04:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: tenants\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 302, in create_azure_connection\n    await check_growth_tier(current_user, db)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 52, in check_growth_tier\n    result = await db.execute(select(Tenant).where(Tenant.id == user.tenant_id))\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: tenants\n[SQL: SELECT tenants.id, tenants.name, tenants.name_bidx, tenants.\"plan\", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at \nFROM tenants \nWHERE tenants.id = ?]\n[parameters: ('33d[PHONE_REDACTED]eb5131bb249b382a3',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT tenants.id, tenants.name, tenants.name_bidx, tenants."plan", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at 
FROM tenants 
WHERE tenants.id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00026s] ('33d276540695478eb5131bb249b382a3',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
_______________ test_create_azure_connection_allowed_on_pro_tier _______________

self = <sqlalchemy.engine.base.Connection object at 0x7876195e44d0>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x7876195e59d0>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x7876199a9850>
parameters = [('98af566a8a9c445383bb37c343609f38',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x7876039db1c0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: tenants

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

async_client = <httpx.AsyncClient object at 0x7876197fd190>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x78760670e3c0>
mock_user = <MagicMock id='132448362003968'>

    @pytest.mark.asyncio
    async def test_create_azure_connection_allowed_on_pro_tier(async_client: AsyncClient, db_session, mock_user):
        """Test Azure connection allowed for Pro tier."""
        tenant = Tenant(id=mock_user.tenant_id, name="Pro Tenant", plan=PricingTier.PRO.value)
        db_session.add(tenant)
        await db_session.commit()
    
        sub_id = str(uuid.uuid4())
        payload = {
            "name": "Azure Sub",
            "subscription_id": sub_id,
            "azure_tenant_id": str(uuid.uuid4()),
            "client_id": str(uuid.uuid4()),
            "client_secret": "secret"
        }
>       response = await async_client.post("/api/v1/settings/connections/azure", json=payload)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_connections.py:87: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/connections.py:302: in create_azure_connection
    await check_growth_tier(current_user, db)
app/modules/governance/api/v1/settings/connections.py:52: in check_growth_tier
    result = await db.execute(select(Tenant).where(Tenant.id == user.tenant_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x7876039db1c0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: tenants
E               [SQL: SELECT tenants.id, tenants.name, tenants.name_bidx, tenants."plan", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at 
E               FROM tenants 
E               WHERE tenants.id = ?]
E               [parameters: ('98af566a8a9c445383bb37c343609f38',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:04:59,312 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:04:59,312 INFO sqlalchemy.engine.Engine SELECT tenants.id, tenants.name, tenants.name_bidx, tenants."plan", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at 
FROM tenants 
WHERE tenants.id = ?
2026-02-08 18:04:59,312 INFO sqlalchemy.engine.Engine [cached since 1.547s ago] ('98af566a8a9c445383bb37c343609f38',)
2026-02-08 18:04:59,313 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/connections/azure", "method": "POST", "error_id": "7ac7f58c-200f-[PHONE_REDACTED]d1-057fcd496b29", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:04:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: tenants\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 302, in create_azure_connection\n    await check_growth_tier(current_user, db)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 52, in check_growth_tier\n    result = await db.execute(select(Tenant).where(Tenant.id == user.tenant_id))\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: tenants\n[SQL: SELECT tenants.id, tenants.name, tenants.name_bidx, tenants.\"plan\", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at \nFROM tenants \nWHERE tenants.id = ?]\n[parameters: ('98af566a8a9c[PHONE_REDACTED]bb37c[PHONE_REDACTED]f38',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT tenants.id, tenants.name, tenants.name_bidx, tenants."plan", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at 
FROM tenants 
WHERE tenants.id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 1.547s ago] ('98af566a8a9c445383bb37c343609f38',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
________________________ test_carbon_settings_lifecycle ________________________

self = <sqlalchemy.engine.base.Connection object at 0x7876195e4110>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x7876195e5190>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x7876107ad650>
parameters = [('ee3c5cb2eea842dbb8e8b92d3d047e49',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78760bf14580>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: carbon_settings

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

async_client = <httpx.AsyncClient object at 0x787603068050>
db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x78760504c980>
mock_user_id = '2319351a-204b-4572-8aa0-1b3e36011f80'
mock_tenant_id = 'ee3c5cb2-eea8-42db-b8e8-b92d3d047e49'
app = <fastapi.applications.FastAPI object at 0x787621e96f90>

    @pytest.mark.asyncio
    async def test_carbon_settings_lifecycle(async_client: AsyncClient, db, mock_user_id, mock_tenant_id, app):
        """Deep test for Carbon settings."""
        user_id = uuid.UUID(mock_user_id)
        tenant_id = uuid.UUID(mock_tenant_id)
        mock_user = CurrentUser(id=user_id, tenant_id=tenant_id, email="test@carbon.io", role=UserRole.ADMIN)
        app.dependency_overrides[get_current_user] = lambda: mock_user
    
        try:
            # 1. GET - Create default
>           response = await async_client.get("/api/v1/settings/carbon")
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_governance_deep.py:16: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1768: in get
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:380: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/carbon.py:60: in get_carbon_settings
    result = await db.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78760bf14580>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: carbon_settings
E               [SQL: SELECT carbon_settings.id, carbon_settings.tenant_id, carbon_settings.carbon_budget_kg, carbon_settings.alert_threshold_percent, carbon_settings.default_region, carbon_settings.email_enabled, carbon_settings.email_recipients, carbon_settings.last_alert_sent, carbon_settings.created_at, carbon_settings.updated_at 
E               FROM carbon_settings 
E               WHERE carbon_settings.tenant_id = ?]
E               [parameters: ('ee3c5cb2eea842dbb8e8b92d3d047e49',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:01,140 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:01,141 INFO sqlalchemy.engine.Engine SELECT carbon_settings.id, carbon_settings.tenant_id, carbon_settings.carbon_budget_kg, carbon_settings.alert_threshold_percent, carbon_settings.default_region, carbon_settings.email_enabled, carbon_settings.email_recipients, carbon_settings.last_alert_sent, carbon_settings.created_at, carbon_settings.updated_at 
FROM carbon_settings 
WHERE carbon_settings.tenant_id = ?
2026-02-08 18:05:01,141 INFO sqlalchemy.engine.Engine [cached since 9.91s ago] ('ee3c5cb2eea842dbb8e8b92d3d047e49',)
2026-02-08 18:05:01,141 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/carbon", "method": "GET", "error_id": "8df[PHONE_REDACTED]-d[PHONE_REDACTED]be-bbb5-cc7906d4dec9", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: carbon_settings\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 380, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/carbon.py\", line 60, in get_carbon_settings\n    result = await db.execute(\n             ^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: carbon_settings\n[SQL: SELECT carbon_settings.id, carbon_settings.tenant_id, carbon_settings.carbon_budget_kg, carbon_settings.alert_threshold_percent, carbon_settings.default_region, carbon_settings.email_enabled, carbon_settings.email_recipients, carbon_settings.last_alert_sent, carbon_settings.created_at, carbon_settings.updated_at \nFROM carbon_settings \nWHERE carbon_settings.tenant_id = ?]\n[parameters: ('ee3c5cb2eea842dbb8e8b92d3d047e49',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT carbon_settings.id, carbon_settings.tenant_id, carbon_settings.carbon_budget_kg, carbon_settings.alert_threshold_percent, carbon_settings.default_region, carbon_settings.email_enabled, carbon_settings.email_recipients, carbon_settings.last_alert_sent, carbon_settings.created_at, carbon_settings.updated_at 
FROM carbon_settings 
WHERE carbon_settings.tenant_id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 9.91s ago] ('ee3c5cb2eea842dbb8e8b92d3d047e49',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
____________________ test_notifications_settings_lifecycle _____________________

self = <sqlalchemy.engine.base.Connection object at 0x7876104c3e90>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x7876104c3ad0>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x78760bfa7150>
parameters = [('bccf8c3b6ad548e59c4e80e2487f567f',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78760bf13a60>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: notification_settings

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

async_client = <httpx.AsyncClient object at 0x7876195e6510>
db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x787604508910>
mock_user_id = 'f41ac3c3-288f-4257-b4e3-09311f2eb500'
mock_tenant_id = 'bccf8c3b-6ad5-48e5-9c4e-80e2487f567f'
app = <fastapi.applications.FastAPI object at 0x787621e96f90>

    @pytest.mark.asyncio
    async def test_notifications_settings_lifecycle(async_client: AsyncClient, db, mock_user_id, mock_tenant_id, app):
        """Deep test for Notification settings."""
        user_id = uuid.UUID(mock_user_id)
        tenant_id = uuid.UUID(mock_tenant_id)
        mock_user = CurrentUser(id=user_id, tenant_id=tenant_id, email="test@notify.io", role=UserRole.ADMIN)
        app.dependency_overrides[get_current_user] = lambda: mock_user
    
        try:
            # 1. GET - Create default
>           response = await async_client.get("/api/v1/settings/notifications")
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_governance_deep.py:39: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1768: in get
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:380: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/notifications.py:66: in get_notification_settings
    result = await db.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78760bf13a60>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: notification_settings
E               [SQL: SELECT notification_settings.id, notification_settings.tenant_id, notification_settings.slack_enabled, notification_settings.slack_channel_override, notification_settings.digest_schedule, notification_settings.digest_hour, notification_settings.digest_minute, notification_settings.alert_on_budget_warning, notification_settings.alert_on_budget_exceeded, notification_settings.alert_on_carbon_budget_warning, notification_settings.alert_on_carbon_budget_exceeded, notification_settings.alert_on_zombie_detected 
E               FROM notification_settings 
E               WHERE notification_settings.tenant_id = ?]
E               [parameters: ('bccf8c3b6ad548e59c4e80e2487f567f',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:02,640 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:02,642 INFO sqlalchemy.engine.Engine SELECT notification_settings.id, notification_settings.tenant_id, notification_settings.slack_enabled, notification_settings.slack_channel_override, notification_settings.digest_schedule, notification_settings.digest_hour, notification_settings.digest_minute, notification_settings.alert_on_budget_warning, notification_settings.alert_on_budget_exceeded, notification_settings.alert_on_carbon_budget_warning, notification_settings.alert_on_carbon_budget_exceeded, notification_settings.alert_on_zombie_detected 
FROM notification_settings 
WHERE notification_settings.tenant_id = ?
2026-02-08 18:05:02,642 INFO sqlalchemy.engine.Engine [generated in 0.00042s] ('bccf8c3b6ad548e59c4e80e2487f567f',)
2026-02-08 18:05:02,643 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/notifications", "method": "GET", "error_id": "c[PHONE_REDACTED]b-86e3-4c97-a[PHONE_REDACTED]ad3bb7802", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: notification_settings\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 380, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/notifications.py\", line 66, in get_notification_settings\n    result = await db.execute(\n             ^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: notification_settings\n[SQL: SELECT notification_settings.id, notification_settings.tenant_id, notification_settings.slack_enabled, notification_settings.slack_channel_override, notification_settings.digest_schedule, notification_settings.digest_hour, notification_settings.digest_minute, notification_settings.alert_on_budget_warning, notification_settings.alert_on_budget_exceeded, notification_settings.alert_on_carbon_budget_warning, notification_settings.alert_on_carbon_budget_exceeded, notification_settings.alert_on_zombie_detected \nFROM notification_settings \nWHERE notification_settings.tenant_id = ?]\n[parameters: ('bccf8c3b6ad548e59c4e80e2487f567f',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT notification_settings.id, notification_settings.tenant_id, notification_settings.slack_enabled, notification_settings.slack_channel_override, notification_settings.digest_schedule, notification_settings.digest_hour, notification_settings.digest_minute, notification_settings.alert_on_budget_warning, notification_settings.alert_on_budget_exceeded, notification_settings.alert_on_carbon_budget_warning, notification_settings.alert_on_carbon_budget_exceeded, notification_settings.alert_on_zombie_detected 
FROM notification_settings 
WHERE notification_settings.tenant_id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00042s] ('bccf8c3b6ad548e59c4e80e2487f567f',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
____________________ test_get_llm_settings_creates_default _____________________

self = <sqlalchemy.engine.base.Connection object at 0x787603146510>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x7876195e5250>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x787606ddbe50>
parameters = [('beb76de5f2844f0ba7b93b423f598c7a',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787605dcf700>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: llm_budgets

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

async_client = <httpx.AsyncClient object at 0x7876104c2f90>
db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x787603b3c6e0>
mock_user_id = 'bf021f59-24aa-4970-a1b4-c7cd37140a17'
mock_tenant_id = 'beb76de5-f284-4f0b-a7b9-3b423f598c7a'
app = <fastapi.applications.FastAPI object at 0x787621e96f90>

    @pytest.mark.asyncio
    async def test_get_llm_settings_creates_default(async_client: AsyncClient, db, mock_user_id, mock_tenant_id, app):
        """GET /llm should create default budget if it doesn't exist."""
        user_id = uuid.UUID(mock_user_id)
        tenant_id = uuid.UUID(mock_tenant_id)
        mock_user = CurrentUser(id=user_id, tenant_id=tenant_id, email="test@valdrix.io", role=UserRole.ADMIN)
    
        app.dependency_overrides[get_current_user] = lambda: mock_user
        try:
>           response = await async_client.get("/api/v1/settings/llm")
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_llm_settings.py:16: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1768: in get
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:380: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/llm.py:71: in get_llm_settings
    result = await db.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787605dcf700>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: llm_budgets
E               [SQL: SELECT llm_budgets.id, llm_budgets.tenant_id, llm_budgets.monthly_limit_usd, llm_budgets.alert_threshold_percent, llm_budgets.hard_limit, llm_budgets.preferred_provider, llm_budgets.preferred_model, llm_budgets.openai_api_key, llm_budgets.claude_api_key, llm_budgets.google_api_key, llm_budgets.groq_api_key, llm_budgets.alert_sent_at 
E               FROM llm_budgets 
E               WHERE llm_budgets.tenant_id = ?]
E               [parameters: ('beb76de5f2844f0ba7b93b423f598c7a',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:04,785 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:04,787 INFO sqlalchemy.engine.Engine SELECT llm_budgets.id, llm_budgets.tenant_id, llm_budgets.monthly_limit_usd, llm_budgets.alert_threshold_percent, llm_budgets.hard_limit, llm_budgets.preferred_provider, llm_budgets.preferred_model, llm_budgets.openai_api_key, llm_budgets.claude_api_key, llm_budgets.google_api_key, llm_budgets.groq_api_key, llm_budgets.alert_sent_at 
FROM llm_budgets 
WHERE llm_budgets.tenant_id = ?
2026-02-08 18:05:04,787 INFO sqlalchemy.engine.Engine [generated in 0.00030s] ('beb76de5f2844f0ba7b93b423f598c7a',)
2026-02-08 18:05:04,788 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/llm", "method": "GET", "error_id": "[PHONE_REDACTED]fe-d48b-4ca8-a62e-58bbf94f8e10", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: llm_budgets\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 380, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/llm.py\", line 71, in get_llm_settings\n    result = await db.execute(\n             ^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: llm_budgets\n[SQL: SELECT llm_budgets.id, llm_budgets.tenant_id, llm_budgets.monthly_limit_usd, llm_budgets.alert_threshold_percent, llm_budgets.hard_limit, llm_budgets.preferred_provider, llm_budgets.preferred_model, llm_budgets.openai_api_key, llm_budgets.claude_api_key, llm_budgets.google_api_key, llm_budgets.groq_api_key, llm_budgets.alert_sent_at \nFROM llm_budgets \nWHERE llm_budgets.tenant_id = ?]\n[parameters: ('beb76de5f2844f0ba7b93b423f598c7a',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT llm_budgets.id, llm_budgets.tenant_id, llm_budgets.monthly_limit_usd, llm_budgets.alert_threshold_percent, llm_budgets.hard_limit, llm_budgets.preferred_provider, llm_budgets.preferred_model, llm_budgets.openai_api_key, llm_budgets.claude_api_key, llm_budgets.google_api_key, llm_budgets.groq_api_key, llm_budgets.alert_sent_at 
FROM llm_budgets 
WHERE llm_budgets.tenant_id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00030s] ('beb76de5f2844f0ba7b93b423f598c7a',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
___________________________ test_update_llm_settings ___________________________

self = <sqlalchemy.engine.base.Connection object at 0x78760aa38e90>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x78760aa3b950>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x787606ddbe50>
parameters = [('f982148e0f6b4383944d9d33812e3f67',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78760bbaaa40>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: llm_budgets

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

async_client = <httpx.AsyncClient object at 0x787603146450>
db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x787609c25e80>
mock_user_id = 'c4445ec3-bffb-4563-8a6d-849bc90285f7'
mock_tenant_id = 'f982148e-0f6b-4383-944d-9d33812e3f67'
app = <fastapi.applications.FastAPI object at 0x787621e96f90>

    @pytest.mark.asyncio
    async def test_update_llm_settings(async_client: AsyncClient, db, mock_user_id, mock_tenant_id, app):
        """PUT /llm should update existing budget and keys."""
        user_id = uuid.UUID(mock_user_id)
        tenant_id = uuid.UUID(mock_tenant_id)
        mock_user = CurrentUser(id=user_id, tenant_id=tenant_id, email="test@valdrix.io", role=UserRole.ADMIN)
    
        budget = LLMBudget(tenant_id=tenant_id, monthly_limit_usd=10.0, preferred_provider="groq")
        db.add(budget)
        await db.commit()
    
        update_data = {"monthly_limit_usd": 50.0, "preferred_provider": "openai", "openai_api_key": "sk-test"}
        app.dependency_overrides[get_current_user] = lambda: mock_user
        try:
>           response = await async_client.put("/api/v1/settings/llm", json=update_data)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_llm_settings.py:36: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1896: in put
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/llm.py:119: in update_llm_settings
    result = await db.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78760bbaaa40>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: llm_budgets
E               [SQL: SELECT llm_budgets.id, llm_budgets.tenant_id, llm_budgets.monthly_limit_usd, llm_budgets.alert_threshold_percent, llm_budgets.hard_limit, llm_budgets.preferred_provider, llm_budgets.preferred_model, llm_budgets.openai_api_key, llm_budgets.claude_api_key, llm_budgets.google_api_key, llm_budgets.groq_api_key, llm_budgets.alert_sent_at 
E               FROM llm_budgets 
E               WHERE llm_budgets.tenant_id = ?]
E               [parameters: ('f982148e0f6b4383944d9d33812e3f67',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:06,638 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:06,639 INFO sqlalchemy.engine.Engine SELECT llm_budgets.id, llm_budgets.tenant_id, llm_budgets.monthly_limit_usd, llm_budgets.alert_threshold_percent, llm_budgets.hard_limit, llm_budgets.preferred_provider, llm_budgets.preferred_model, llm_budgets.openai_api_key, llm_budgets.claude_api_key, llm_budgets.google_api_key, llm_budgets.groq_api_key, llm_budgets.alert_sent_at 
FROM llm_budgets 
WHERE llm_budgets.tenant_id = ?
2026-02-08 18:05:06,639 INFO sqlalchemy.engine.Engine [cached since 1.852s ago] ('f982148e0f6b4383944d9d33812e3f67',)
2026-02-08 18:05:06,639 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/llm", "method": "PUT", "error_id": "8e6edea[PHONE_REDACTED]-3ada5017a96f", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: llm_budgets\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/llm.py\", line 119, in update_llm_settings\n    result = await db.execute(\n             ^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: llm_budgets\n[SQL: SELECT llm_budgets.id, llm_budgets.tenant_id, llm_budgets.monthly_limit_usd, llm_budgets.alert_threshold_percent, llm_budgets.hard_limit, llm_budgets.preferred_provider, llm_budgets.preferred_model, llm_budgets.openai_api_key, llm_budgets.claude_api_key, llm_budgets.google_api_key, llm_budgets.groq_api_key, llm_budgets.alert_sent_at \nFROM llm_budgets \nWHERE llm_budgets.tenant_id = ?]\n[parameters: ('f[PHONE_REDACTED]e0f6b[PHONE_REDACTED]d9d[PHONE_REDACTED]e3f67',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT llm_budgets.id, llm_budgets.tenant_id, llm_budgets.monthly_limit_usd, llm_budgets.alert_threshold_percent, llm_budgets.hard_limit, llm_budgets.preferred_provider, llm_budgets.preferred_model, llm_budgets.openai_api_key, llm_budgets.claude_api_key, llm_budgets.google_api_key, llm_budgets.groq_api_key, llm_budgets.alert_sent_at 
FROM llm_budgets 
WHERE llm_budgets.tenant_id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 1.852s ago] ('f982148e0f6b4383944d9d33812e3f67',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
________________ test_get_notification_settings_creates_default ________________

self = <sqlalchemy.engine.base.Connection object at 0x78760a7571d0>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x78760a756f90>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x78760bfa7150>
parameters = [('0af10eedc93b475a89eceba3e654eec4',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x7876066205e0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: notification_settings

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

async_client = <httpx.AsyncClient object at 0x787603146750>
mock_user_id = '189a6a0a-bb16-4949-b7ef-20eae225473c'
mock_tenant_id = '0af10eed-c93b-475a-89ec-eba3e654eec4'
app = <fastapi.applications.FastAPI object at 0x787621e96f90>

    @pytest.mark.asyncio
    async def test_get_notification_settings_creates_default(async_client: AsyncClient, mock_user_id, mock_tenant_id, app):
        """GET /notifications should create default settings if they don't exist."""
        user_id = uuid.UUID(mock_user_id)
        tenant_id = uuid.UUID(mock_tenant_id)
        mock_user = CurrentUser(id=user_id, tenant_id=tenant_id, email="test@valdrix.io", role=UserRole.ADMIN)
    
        app.dependency_overrides[get_current_user] = lambda: mock_user
        try:
>           response = await async_client.get("/api/v1/settings/notifications")
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_notifications.py:17: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1768: in get
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:380: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/notifications.py:66: in get_notification_settings
    result = await db.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x7876066205e0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: notification_settings
E               [SQL: SELECT notification_settings.id, notification_settings.tenant_id, notification_settings.slack_enabled, notification_settings.slack_channel_override, notification_settings.digest_schedule, notification_settings.digest_hour, notification_settings.digest_minute, notification_settings.alert_on_budget_warning, notification_settings.alert_on_budget_exceeded, notification_settings.alert_on_carbon_budget_warning, notification_settings.alert_on_carbon_budget_exceeded, notification_settings.alert_on_zombie_detected 
E               FROM notification_settings 
E               WHERE notification_settings.tenant_id = ?]
E               [parameters: ('0af10eedc93b475a89eceba3e654eec4',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:08,505 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:08,506 INFO sqlalchemy.engine.Engine SELECT notification_settings.id, notification_settings.tenant_id, notification_settings.slack_enabled, notification_settings.slack_channel_override, notification_settings.digest_schedule, notification_settings.digest_hour, notification_settings.digest_minute, notification_settings.alert_on_budget_warning, notification_settings.alert_on_budget_exceeded, notification_settings.alert_on_carbon_budget_warning, notification_settings.alert_on_carbon_budget_exceeded, notification_settings.alert_on_zombie_detected 
FROM notification_settings 
WHERE notification_settings.tenant_id = ?
2026-02-08 18:05:08,506 INFO sqlalchemy.engine.Engine [cached since 5.864s ago] ('0af10eedc93b475a89eceba3e654eec4',)
2026-02-08 18:05:08,507 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/notifications", "method": "GET", "error_id": "7c3bc4b3-74bd-42d1-be03-47c49afacc2c", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: notification_settings\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 380, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/notifications.py\", line 66, in get_notification_settings\n    result = await db.execute(\n             ^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: notification_settings\n[SQL: SELECT notification_settings.id, notification_settings.tenant_id, notification_settings.slack_enabled, notification_settings.slack_channel_override, notification_settings.digest_schedule, notification_settings.digest_hour, notification_settings.digest_minute, notification_settings.alert_on_budget_warning, notification_settings.alert_on_budget_exceeded, notification_settings.alert_on_carbon_budget_warning, notification_settings.alert_on_carbon_budget_exceeded, notification_settings.alert_on_zombie_detected \nFROM notification_settings \nWHERE notification_settings.tenant_id = ?]\n[parameters: ('0af10eedc93b475a89eceba3e654eec4',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT notification_settings.id, notification_settings.tenant_id, notification_settings.slack_enabled, notification_settings.slack_channel_override, notification_settings.digest_schedule, notification_settings.digest_hour, notification_settings.digest_minute, notification_settings.alert_on_budget_warning, notification_settings.alert_on_budget_exceeded, notification_settings.alert_on_carbon_budget_warning, notification_settings.alert_on_carbon_budget_exceeded, notification_settings.alert_on_zombie_detected 
FROM notification_settings 
WHERE notification_settings.tenant_id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 5.864s ago] ('0af10eedc93b475a89eceba3e654eec4',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
______________________ test_update_notification_settings _______________________

self = <sqlalchemy.engine.base.Connection object at 0x78761371de50>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x78761371dfd0>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x78760bfa7150>
parameters = [('d634078d5bd642b5bd502ff0b5f11f13',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787606567400>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: notification_settings

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

async_client = <httpx.AsyncClient object at 0x787603146690>
db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x787609c26dd0>
mock_user_id = '9dbc0a9f-5627-4114-8111-e4092aa440e5'
mock_tenant_id = 'd634078d-5bd6-42b5-bd50-2ff0b5f11f13'
app = <fastapi.applications.FastAPI object at 0x787621e96f90>

    @pytest.mark.asyncio
    async def test_update_notification_settings(async_client: AsyncClient, db, mock_user_id, mock_tenant_id, app):
        """PUT /notifications should update existing settings."""
        user_id = uuid.UUID(mock_user_id)
        tenant_id = uuid.UUID(mock_tenant_id)
        mock_user = CurrentUser(id=user_id, tenant_id=tenant_id, email="test@valdrix.io", role=UserRole.ADMIN)
    
        settings = NotificationSettings(tenant_id=tenant_id, slack_enabled=True, digest_schedule="daily")
        db.add(settings)
        await db.commit()
    
        update_data = {"slack_enabled": False, "digest_schedule": "weekly"}
        app.dependency_overrides[get_current_user] = lambda: mock_user
        try:
>           response = await async_client.put("/api/v1/settings/notifications", json=update_data)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_notifications.py:38: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1896: in put
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/notifications.py:108: in update_notification_settings
    result = await db.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787606567400>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: notification_settings
E               [SQL: SELECT notification_settings.id, notification_settings.tenant_id, notification_settings.slack_enabled, notification_settings.slack_channel_override, notification_settings.digest_schedule, notification_settings.digest_hour, notification_settings.digest_minute, notification_settings.alert_on_budget_warning, notification_settings.alert_on_budget_exceeded, notification_settings.alert_on_carbon_budget_warning, notification_settings.alert_on_carbon_budget_exceeded, notification_settings.alert_on_zombie_detected 
E               FROM notification_settings 
E               WHERE notification_settings.tenant_id = ?]
E               [parameters: ('d634078d5bd642b5bd502ff0b5f11f13',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:09,961 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:09,962 INFO sqlalchemy.engine.Engine SELECT notification_settings.id, notification_settings.tenant_id, notification_settings.slack_enabled, notification_settings.slack_channel_override, notification_settings.digest_schedule, notification_settings.digest_hour, notification_settings.digest_minute, notification_settings.alert_on_budget_warning, notification_settings.alert_on_budget_exceeded, notification_settings.alert_on_carbon_budget_warning, notification_settings.alert_on_carbon_budget_exceeded, notification_settings.alert_on_zombie_detected 
FROM notification_settings 
WHERE notification_settings.tenant_id = ?
2026-02-08 18:05:09,962 INFO sqlalchemy.engine.Engine [cached since 7.32s ago] ('d634078d5bd642b5bd502ff0b5f11f13',)
2026-02-08 18:05:09,963 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/notifications", "method": "PUT", "error_id": "042a[PHONE_REDACTED]b-4fd6-a289-be5944fbb475", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: notification_settings\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/notifications.py\", line 108, in update_notification_settings\n    result = await db.execute(\n             ^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: notification_settings\n[SQL: SELECT notification_settings.id, notification_settings.tenant_id, notification_settings.slack_enabled, notification_settings.slack_channel_override, notification_settings.digest_schedule, notification_settings.digest_hour, notification_settings.digest_minute, notification_settings.alert_on_budget_warning, notification_settings.alert_on_budget_exceeded, notification_settings.alert_on_carbon_budget_warning, notification_settings.alert_on_carbon_budget_exceeded, notification_settings.alert_on_zombie_detected \nFROM notification_settings \nWHERE notification_settings.tenant_id = ?]\n[parameters: ('d[PHONE_REDACTED]d5bd642b5bd502ff0b5f11f13',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT notification_settings.id, notification_settings.tenant_id, notification_settings.slack_enabled, notification_settings.slack_channel_override, notification_settings.digest_schedule, notification_settings.digest_hour, notification_settings.digest_minute, notification_settings.alert_on_budget_warning, notification_settings.alert_on_budget_exceeded, notification_settings.alert_on_carbon_budget_warning, notification_settings.alert_on_carbon_budget_exceeded, notification_settings.alert_on_zombie_detected 
FROM notification_settings 
WHERE notification_settings.tenant_id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 7.32s ago] ('d634078d5bd642b5bd502ff0b5f11f13',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
_________________________ test_test_slack_notification _________________________

self = <sqlalchemy.engine.base.Connection object at 0x78761371c7d0>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x78761371cb90>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x78760bfa7150>
parameters = [('d86f2118c9d34ad1ac6a90878f270e5e',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78760a1270a0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: notification_settings

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

async_client = <httpx.AsyncClient object at 0x78760bbcc350>
mock_user_id = '69416017-ea88-41af-9547-30736c7f9d66'
mock_tenant_id = 'd86f2118-c9d3-4ad1-ac6a-90878f270e5e'
app = <fastapi.applications.FastAPI object at 0x787621e96f90>

    @pytest.mark.asyncio
    async def test_test_slack_notification(async_client: AsyncClient, mock_user_id, mock_tenant_id, app):
        """POST /notifications/test-slack should trigger SlackService."""
        user_id = uuid.UUID(mock_user_id)
        tenant_id = uuid.UUID(mock_tenant_id)
        mock_user = CurrentUser(id=user_id, tenant_id=tenant_id, email="test@valdrix.io", role=UserRole.ADMIN)
    
        from app.shared.core.config import Settings
        mock_settings = Settings()
        mock_settings.SLACK_BOT_TOKEN = "xoxb-test"
        mock_settings.SLACK_CHANNEL_ID = "C12345"
    
        mock_slack = AsyncMock()
        mock_slack.send_alert.return_value = True
    
        app.dependency_overrides[get_current_user] = lambda: mock_user
        # Patch where the lazy-imported service is DEFINED/USED
        with patch("app.shared.core.config.get_settings", return_value=mock_settings), \
             patch("app.modules.notifications.domain.SlackService", return_value=mock_slack):
    
            try:
>               response = await async_client.post("/api/v1/settings/notifications/test-slack")
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_notifications.py:65: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/notifications.py:172: in test_slack_notification
    result = await db.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78760a1270a0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: notification_settings
E               [SQL: SELECT notification_settings.id, notification_settings.tenant_id, notification_settings.slack_enabled, notification_settings.slack_channel_override, notification_settings.digest_schedule, notification_settings.digest_hour, notification_settings.digest_minute, notification_settings.alert_on_budget_warning, notification_settings.alert_on_budget_exceeded, notification_settings.alert_on_carbon_budget_warning, notification_settings.alert_on_carbon_budget_exceeded, notification_settings.alert_on_zombie_detected 
E               FROM notification_settings 
E               WHERE notification_settings.tenant_id = ?]
E               [parameters: ('d86f2118c9d34ad1ac6a90878f270e5e',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:11,413 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:11,413 INFO sqlalchemy.engine.Engine SELECT notification_settings.id, notification_settings.tenant_id, notification_settings.slack_enabled, notification_settings.slack_channel_override, notification_settings.digest_schedule, notification_settings.digest_hour, notification_settings.digest_minute, notification_settings.alert_on_budget_warning, notification_settings.alert_on_budget_exceeded, notification_settings.alert_on_carbon_budget_warning, notification_settings.alert_on_carbon_budget_exceeded, notification_settings.alert_on_zombie_detected 
FROM notification_settings 
WHERE notification_settings.tenant_id = ?
2026-02-08 18:05:11,414 INFO sqlalchemy.engine.Engine [cached since 8.772s ago] ('d86f2118c9d34ad1ac6a90878f270e5e',)
2026-02-08 18:05:11,414 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/notifications/test-slack", "method": "POST", "error_id": "87d4614a-22a3-4d60-8b40-aa9b5ae762e3", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: notification_settings\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/notifications.py\", line 172, in test_slack_notification\n    result = await db.execute(\n             ^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: notification_settings\n[SQL: SELECT notification_settings.id, notification_settings.tenant_id, notification_settings.slack_enabled, notification_settings.slack_channel_override, notification_settings.digest_schedule, notification_settings.digest_hour, notification_settings.digest_minute, notification_settings.alert_on_budget_warning, notification_settings.alert_on_budget_exceeded, notification_settings.alert_on_carbon_budget_warning, notification_settings.alert_on_carbon_budget_exceeded, notification_settings.alert_on_zombie_detected \nFROM notification_settings \nWHERE notification_settings.tenant_id = ?]\n[parameters: ('d86f2118c9d34ad1ac6a[PHONE_REDACTED]f270e5e',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT notification_settings.id, notification_settings.tenant_id, notification_settings.slack_enabled, notification_settings.slack_channel_override, notification_settings.digest_schedule, notification_settings.digest_hour, notification_settings.digest_minute, notification_settings.alert_on_budget_warning, notification_settings.alert_on_budget_exceeded, notification_settings.alert_on_carbon_budget_warning, notification_settings.alert_on_carbon_budget_exceeded, notification_settings.alert_on_zombie_detected 
FROM notification_settings 
WHERE notification_settings.tenant_id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 8.772s ago] ('d86f2118c9d34ad1ac6a90878f270e5e',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
_____________________________ test_onboard_success _____________________________

self = <sqlalchemy.engine.base.Connection object at 0x7876109aeed0>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x7876109aef90>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x78761a034f50>
parameters = [('b8737a57201b4f2b87b1fe60295d4edb',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787609e959c0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: users

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

async_client = <httpx.AsyncClient object at 0x78761371c050>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x78760b6f5550>
mock_jwt_user = <MagicMock id='132448362003632'>

    @pytest.mark.asyncio
    async def test_onboard_success(async_client: AsyncClient, db_session, mock_jwt_user):
        """Test successful onboarding creates tenant and user."""
        onboard_data = {
            "tenant_name": "Test Tenant",
            "admin_email": "admin@example.com"
        }
    
>       response = await async_client.post("/api/v1/settings/onboard", json=onboard_data)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_onboard.py:32: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/onboard.py:39: in onboard
    existing = await db.execute(select(User).where(User.id == user.id))
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787609e959c0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users
E               [SQL: SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
E               FROM users 
E               WHERE users.id = ?]
E               [parameters: ('b8737a57201b4f2b87b1fe60295d4edb',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:12,845 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:12,897 INFO sqlalchemy.engine.Engine SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
FROM users 
WHERE users.id = ?
2026-02-08 18:05:12,897 INFO sqlalchemy.engine.Engine [generated in 0.00029s] ('b8737a57201b4f2b87b1fe60295d4edb',)
2026-02-08 18:05:12,898 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/onboard", "method": "POST", "error_id": "31a215b3-9acd-4427-b[PHONE_REDACTED]f[PHONE_REDACTED]", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: users\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/onboard.py\", line 39, in onboard\n    existing = await db.execute(select(User).where(User.id == user.id))\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users\n[SQL: SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role \nFROM users \nWHERE users.id = ?]\n[parameters: ('b8737a[PHONE_REDACTED]b4f2b87b1fe[PHONE_REDACTED]d4edb',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
FROM users 
WHERE users.id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00029s] ('b8737a57201b4f2b87b1fe60295d4edb',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
________________________ test_onboard_already_onboarded ________________________

self = <sqlalchemy.engine.base.Connection object at 0x7876109af410>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x7876109acc50>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x78761a034f50>
parameters = [('bc1d910bcb9a4e318b90f6974ef6326a',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78761975b400>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: users

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

async_client = <httpx.AsyncClient object at 0x78761371d790>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x787609deb930>
mock_jwt_user = <MagicMock id='132448361991536'>

    @pytest.mark.asyncio
    async def test_onboard_already_onboarded(async_client: AsyncClient, db_session, mock_jwt_user):
        """Test that onboarding fails if user already exists in DB."""
        # Pre-create user
        tenant = Tenant(name="Existing")
        db_session.add(tenant)
        await db_session.flush()
        user = User(id=mock_jwt_user.id, email=mock_jwt_user.email, tenant_id=tenant.id)
        db_session.add(user)
        await db_session.commit()
    
        onboard_data = {"tenant_name": "New Tenant"}
>       response = await async_client.post("/api/v1/settings/onboard", json=onboard_data)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_onboard.py:61: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/onboard.py:39: in onboard
    existing = await db.execute(select(User).where(User.id == user.id))
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78761975b400>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users
E               [SQL: SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
E               FROM users 
E               WHERE users.id = ?]
E               [parameters: ('bc1d910bcb9a4e318b90f6974ef6326a',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:14,384 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:14,384 INFO sqlalchemy.engine.Engine SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
FROM users 
WHERE users.id = ?
2026-02-08 18:05:14,385 INFO sqlalchemy.engine.Engine [cached since 1.487s ago] ('bc1d910bcb9a4e318b90f6974ef6326a',)
2026-02-08 18:05:14,385 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/onboard", "method": "POST", "error_id": "75ce8592-f[PHONE_REDACTED]-cb78bdf43b10", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: users\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/onboard.py\", line 39, in onboard\n    existing = await db.execute(select(User).where(User.id == user.id))\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users\n[SQL: SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role \nFROM users \nWHERE users.id = ?]\n[parameters: ('bc1d910bcb9a4e318b90f6974ef6326a',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
FROM users 
WHERE users.id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 1.487s ago] ('bc1d910bcb9a4e318b90f6974ef6326a',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
_________________ test_onboard_with_cloud_verification_success _________________

self = <sqlalchemy.engine.base.Connection object at 0x787608c48f50>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x787608c493d0>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x78761a034f50>
parameters = [('73d06fbe0f204dfcb1184aa22dce94d2',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78760b245480>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: users

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

async_client = <httpx.AsyncClient object at 0x7876109ac950>

    @pytest.mark.asyncio
    async def test_onboard_with_cloud_verification_success(async_client: AsyncClient):
        """Test onboarding with successful AWS connection verification."""
        onboard_data = {
            "tenant_name": "Cloud Tenant",
            "cloud_config": {
                "platform": "aws",
                "role_arn": "arn:aws:iam::123456789012:role/ValdrixRole",
                "external_id": "ext-123"
            }
        }
    
        # Mock AdapterFactory and AWSAdapter
        with patch("app.shared.adapters.factory.AdapterFactory.get_adapter") as mock_get_adapter:
            mock_adapter = AsyncMock()
            mock_adapter.verify_connection.return_value = True
            mock_get_adapter.return_value = mock_adapter
    
>           response = await async_client.post("/api/v1/settings/onboard", json=onboard_data)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_onboard.py:83: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/onboard.py:39: in onboard
    existing = await db.execute(select(User).where(User.id == user.id))
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78760b245480>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users
E               [SQL: SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
E               FROM users 
E               WHERE users.id = ?]
E               [parameters: ('73d06fbe0f204dfcb1184aa22dce94d2',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:15,832 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:15,832 INFO sqlalchemy.engine.Engine SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
FROM users 
WHERE users.id = ?
2026-02-08 18:05:15,833 INFO sqlalchemy.engine.Engine [cached since 2.936s ago] ('73d06fbe0f204dfcb1184aa22dce94d2',)
2026-02-08 18:05:15,833 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/onboard", "method": "POST", "error_id": "8d2f25f[PHONE_REDACTED]a78-b983-eb4e2ef635ab", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: users\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/onboard.py\", line 39, in onboard\n    existing = await db.execute(select(User).where(User.id == user.id))\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users\n[SQL: SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role \nFROM users \nWHERE users.id = ?]\n[parameters: ('73d06fbe0f204dfcb1184aa22dce94d2',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
FROM users 
WHERE users.id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 2.936s ago] ('73d06fbe0f204dfcb1184aa22dce94d2',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
_________________ test_onboard_with_cloud_verification_failure _________________

self = <sqlalchemy.engine.base.Connection object at 0x78760804cd10>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x78760804c1d0>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x78761a034f50>
parameters = [('16cca1e320ff435a9985c00b18bae577',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78761ae65b40>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: users

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

async_client = <httpx.AsyncClient object at 0x787608c48650>

    @pytest.mark.asyncio
    async def test_onboard_with_cloud_verification_failure(async_client: AsyncClient):
        """Test onboarding fails if cloud connection verification fails."""
        onboard_data = {
            "tenant_name": "Bad Cloud Tenant",
            "cloud_config": {
                "platform": "aws",
                "role_arn": "arn:aws:iam::123456789012:role/BadRole"
            }
        }
    
        with patch("app.shared.adapters.factory.AdapterFactory.get_adapter") as mock_get_adapter:
            mock_adapter = AsyncMock()
            mock_adapter.verify_connection.return_value = False
            mock_get_adapter.return_value = mock_adapter
    
>           response = await async_client.post("/api/v1/settings/onboard", json=onboard_data)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_onboard.py:104: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/onboard.py:39: in onboard
    existing = await db.execute(select(User).where(User.id == user.id))
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78761ae65b40>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users
E               [SQL: SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
E               FROM users 
E               WHERE users.id = ?]
E               [parameters: ('16cca1e320ff435a9985c00b18bae577',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:17,744 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:17,744 INFO sqlalchemy.engine.Engine SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
FROM users 
WHERE users.id = ?
2026-02-08 18:05:17,745 INFO sqlalchemy.engine.Engine [cached since 4.847s ago] ('16cca1e320ff435a9985c00b18bae577',)
2026-02-08 18:05:17,745 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/onboard", "method": "POST", "error_id": "20e11e49-37c0-4dbc-9b07-12fcd[PHONE_REDACTED]f9", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: users\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/onboard.py\", line 39, in onboard\n    existing = await db.execute(select(User).where(User.id == user.id))\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users\n[SQL: SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role \nFROM users \nWHERE users.id = ?]\n[parameters: ('16cca1e320ff435a9985c00b18bae577',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
FROM users 
WHERE users.id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 4.847s ago] ('16cca1e320ff435a9985c00b18bae577',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
____________________________ test_onboard_lifecycle ____________________________

self = <sqlalchemy.engine.base.Connection object at 0x7876078cfad0>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x7876078cfdd0>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x78761a034f50>
parameters = [('2d1d200dfd364569bfd0f5db25b25d33',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78761904f760>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: users

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

async_client = <httpx.AsyncClient object at 0x787607bebc50>
db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7876032b4c20>
app = <fastapi.applications.FastAPI object at 0x787621e96f90>

    @pytest.mark.asyncio
    async def test_onboard_lifecycle(async_client: AsyncClient, db, app):
        """Deep test for the Onboarding API using real DB fixture."""
        user_id = uuid.uuid4()
        email = f"onboard_{uuid.uuid4().hex[:8]}@test.io"
        mock_user = CurrentUser(id=user_id, tenant_id=None, email=email, role=UserRole.MEMBER)
    
        app.dependency_overrides[get_current_user_from_jwt] = lambda: mock_user
    
        try:
            onboard_data = {
                "tenant_name": "Test Tenant Corp",
                "admin_email": email
            }
>           response = await async_client.post("/api/v1/settings/onboard", json=onboard_data)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_onboard_deep.py:47: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/onboard.py:39: in onboard
    existing = await db.execute(select(User).where(User.id == user.id))
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78761904f760>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users
E               [SQL: SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
E               FROM users 
E               WHERE users.id = ?]
E               [parameters: ('2d1d200dfd364569bfd0f5db25b25d33',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:19,188 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:19,189 INFO sqlalchemy.engine.Engine SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
FROM users 
WHERE users.id = ?
2026-02-08 18:05:19,189 INFO sqlalchemy.engine.Engine [cached since 6.292s ago] ('2d1d200dfd364569bfd0f5db25b25d33',)
2026-02-08 18:05:19,190 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/onboard", "method": "POST", "error_id": "9e0e[PHONE_REDACTED]dab-9d4d-017a8be9c01d", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: users\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/onboard.py\", line 39, in onboard\n    existing = await db.execute(select(User).where(User.id == user.id))\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users\n[SQL: SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role \nFROM users \nWHERE users.id = ?]\n[parameters: ('2d1d200dfd[PHONE_REDACTED]bfd0f5db25b25d33',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
FROM users 
WHERE users.id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 6.292s ago] ('2d1d200dfd364569bfd0f5db25b25d33',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
____________________________ test_onboard_endpoint _____________________________

self = <sqlalchemy.engine.base.Connection object at 0x787607474350>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x787607474590>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x78761a034f50>
parameters = [('4c6db335b7244851a95a72bb2535200b',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78761092e500>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: users

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

mock_db = <MagicMock id='132448308917456'>
mock_user = CurrentUser(id=UUID('4c6db335-b724-4851-a95a-72bb2535200b'), email='onboard_078e47ce@test.io', tenant_id=None, role=<UserRole.MEMBER: 'member'>, tier=<PricingTier.STARTER: 'starter'>)

    @pytest.mark.asyncio
    async def test_onboard_endpoint(mock_db, mock_user):
        from app.main import app
        from app.shared.db.session import get_db
        app.dependency_overrides[get_db] = lambda: mock_db
        app.dependency_overrides[get_current_user_from_jwt] = lambda: mock_user
    
        mock_db.execute.return_value.scalar_one_or_none.return_value = None
    
        transport = ASGITransport(app=app)
        async with AsyncClient(transport=transport, base_url="http://test") as ac:
>           response = await ac.post("/api/v1/settings/onboard", json={"tenant_name": "TestTenant"})
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_onboard_deep.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/onboard.py:39: in onboard
    existing = await db.execute(select(User).where(User.id == user.id))
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78761092e500>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users
E               [SQL: SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
E               FROM users 
E               WHERE users.id = ?]
E               [parameters: ('4c6db335b7244851a95a72bb2535200b',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:20,219 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:20,219 INFO sqlalchemy.engine.Engine SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
FROM users 
WHERE users.id = ?
2026-02-08 18:05:20,219 INFO sqlalchemy.engine.Engine [cached since 7.322s ago] ('4c6db335b7244851a95a72bb2535200b',)
2026-02-08 18:05:20,220 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/onboard", "method": "POST", "error_id": "6e4799f7-62fa-4669-a259-e7390aa4fc90", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: users\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/onboard.py\", line 39, in onboard\n    existing = await db.execute(select(User).where(User.id == user.id))\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users\n[SQL: SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role \nFROM users \nWHERE users.id = ?]\n[parameters: ('4c6db335b[PHONE_REDACTED]a95a72bb[PHONE_REDACTED]b',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
FROM users 
WHERE users.id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 7.322s ago] ('4c6db335b7244851a95a72bb2535200b',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
____________________________ test_onboard_duplicate ____________________________

self = <sqlalchemy.engine.base.Connection object at 0x787607475550>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x7876074756d0>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x78761a034f50>
parameters = [('77924d0b50c74cc09390561885c9ddd3',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78760462ff40>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: users

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

mock_db = <MagicMock id='132448308912080'>
mock_user = CurrentUser(id=UUID('77924d0b-50c7-4cc0-9390-561885c9ddd3'), email='onboard_69ca632c@test.io', tenant_id=None, role=<UserRole.MEMBER: 'member'>, tier=<PricingTier.STARTER: 'starter'>)

    @pytest.mark.asyncio
    async def test_onboard_duplicate(mock_db, mock_user):
        from app.main import app
        from app.shared.db.session import get_db
        app.dependency_overrides[get_db] = lambda: mock_db
        app.dependency_overrides[get_current_user_from_jwt] = lambda: mock_user
    
        mock_db.execute.return_value.scalar_one_or_none.return_value = MagicMock()
    
        transport = ASGITransport(app=app)
        async with AsyncClient(transport=transport, base_url="http://test") as ac:
>           response = await ac.post("/api/v1/settings/onboard", json={"tenant_name": "DuplicateTenant"})
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_onboard_deep.py:91: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/onboard.py:39: in onboard
    existing = await db.execute(select(User).where(User.id == user.id))
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78760462ff40>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users
E               [SQL: SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
E               FROM users 
E               WHERE users.id = ?]
E               [parameters: ('77924d0b50c74cc09390561885c9ddd3',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:21,308 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:21,308 INFO sqlalchemy.engine.Engine SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
FROM users 
WHERE users.id = ?
2026-02-08 18:05:21,309 INFO sqlalchemy.engine.Engine [cached since 8.412s ago] ('77924d0b50c74cc09390561885c9ddd3',)
2026-02-08 18:05:21,309 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/onboard", "method": "POST", "error_id": "c790ad5f-[PHONE_REDACTED]a9b-81d2-d2a5b[PHONE_REDACTED]a3", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: users\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/onboard.py\", line 39, in onboard\n    existing = await db.execute(select(User).where(User.id == user.id))\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users\n[SQL: SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role \nFROM users \nWHERE users.id = ?]\n[parameters: ('[PHONE_REDACTED]d0b50c74cc[PHONE_REDACTED]c9ddd3',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
FROM users 
WHERE users.id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 8.412s ago] ('77924d0b50c74cc09390561885c9ddd3',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
_____________________ test_onboard_with_cloud_config_multi _____________________

self = <sqlalchemy.engine.base.Connection object at 0x787607475610>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x787607475250>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x78761a034f50>
parameters = [('c738a3e1d48346489d66da81bae6c004',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787604e06fe0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: users

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

mock_db = <MagicMock id='132448338782464'>
mock_user = CurrentUser(id=UUID('c738a3e1-d483-4648-9d66-da81bae6c004'), email='onboard_1feff50d@test.io', tenant_id=None, role=<UserRole.MEMBER: 'member'>, tier=<PricingTier.STARTER: 'starter'>)

    @pytest.mark.asyncio
    async def test_onboard_with_cloud_config_multi(mock_db, mock_user):
        from app.main import app
        from app.shared.db.session import get_db
    
        app.dependency_overrides[get_db] = lambda: mock_db
        app.dependency_overrides[get_current_user_from_jwt] = lambda: mock_user
    
        platforms = [
            ("aws", {"role_arn": "arn:aws:iam::...", "external_id": "123"}),
            ("azure", {"client_id": "...", "client_secret": "...", "azure_tenant_id": "...", "subscription_id": "..."}),
            ("gcp", {"project_id": "...", "service_account_json": "{}"})
        ]
    
        for platform, config in platforms:
            mock_db.execute.return_value.scalar_one_or_none.return_value = None
            mock_adapter = AsyncMock()
            mock_adapter.verify_connection.return_value = True
    
            with patch("app.shared.adapters.factory.AdapterFactory.get_adapter", return_value=mock_adapter):
                transport = ASGITransport(app=app)
                async with AsyncClient(transport=transport, base_url="http://test") as ac:
                    payload = {
                        "tenant_name": f"Tenant-{platform}",
                        "cloud_config": {"platform": platform, **config}
                    }
>                   response = await ac.post("/api/v1/settings/onboard", json=payload)
                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_onboard_deep.py:125: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/onboard.py:39: in onboard
    existing = await db.execute(select(User).where(User.id == user.id))
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787604e06fe0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users
E               [SQL: SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
E               FROM users 
E               WHERE users.id = ?]
E               [parameters: ('c738a3e1d48346489d66da81bae6c004',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:22,390 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:22,391 INFO sqlalchemy.engine.Engine SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
FROM users 
WHERE users.id = ?
2026-02-08 18:05:22,391 INFO sqlalchemy.engine.Engine [cached since 9.494s ago] ('c738a3e1d48346489d66da81bae6c004',)
2026-02-08 18:05:22,392 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/onboard", "method": "POST", "error_id": "549c1eed-d933-4b9d-81a0-57da9681abe6", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: users\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/onboard.py\", line 39, in onboard\n    existing = await db.execute(select(User).where(User.id == user.id))\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users\n[SQL: SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role \nFROM users \nWHERE users.id = ?]\n[parameters: ('c738a3e1d[PHONE_REDACTED]d66da81bae6c004',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
FROM users 
WHERE users.id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 9.494s ago] ('c738a3e1d48346489d66da81bae6c004',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
________________________ test_onboard_invalid_platform _________________________

self = <sqlalchemy.engine.base.Connection object at 0x7876197fa810>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x78761915bad0>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x78761a034f50>
parameters = [('820cf91310e640138c856a386e9003fe',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787604e07b80>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: users

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

mock_db = <MagicMock id='132448338777760'>
mock_user = CurrentUser(id=UUID('820cf913-10e6-4013-8c85-6a386e9003fe'), email='onboard_53989912@test.io', tenant_id=None, role=<UserRole.MEMBER: 'member'>, tier=<PricingTier.STARTER: 'starter'>)

    @pytest.mark.asyncio
    async def test_onboard_invalid_platform(mock_db, mock_user):
        from app.main import app
        from app.shared.db.session import get_db
        app.dependency_overrides[get_db] = lambda: mock_db
        app.dependency_overrides[get_current_user_from_jwt] = lambda: mock_user
        mock_db.execute.return_value.scalar_one_or_none.return_value = None
    
        transport = ASGITransport(app=app)
        async with AsyncClient(transport=transport, base_url="http://test") as ac:
            payload = {
                "tenant_name": "NewTenant",
                "cloud_config": {"platform": "unknown"}
            }
>           response = await ac.post("/api/v1/settings/onboard", json=payload)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_onboard_deep.py:144: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/onboard.py:39: in onboard
    existing = await db.execute(select(User).where(User.id == user.id))
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787604e07b80>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users
E               [SQL: SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
E               FROM users 
E               WHERE users.id = ?]
E               [parameters: ('820cf91310e640138c856a386e9003fe',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:23,433 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:23,434 INFO sqlalchemy.engine.Engine SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
FROM users 
WHERE users.id = ?
2026-02-08 18:05:23,434 INFO sqlalchemy.engine.Engine [cached since 10.54s ago] ('820cf91310e640138c856a386e9003fe',)
2026-02-08 18:05:23,434 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/onboard", "method": "POST", "error_id": "69c8f3b3-2bf6-46db-b2da-e796f2b[PHONE_REDACTED]", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: users\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/onboard.py\", line 39, in onboard\n    existing = await db.execute(select(User).where(User.id == user.id))\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users\n[SQL: SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role \nFROM users \nWHERE users.id = ?]\n[parameters: ('820cf[PHONE_REDACTED]e[PHONE_REDACTED]c856a386e9003fe',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
FROM users 
WHERE users.id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 10.54s ago] ('820cf91310e640138c856a386e9003fe',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
_________________________ test_onboard_connection_fail _________________________

self = <sqlalchemy.engine.base.Connection object at 0x787609d025d0>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x7876197fa690>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x78761a034f50>
parameters = [('c21973bcacce48f5a087a148d51e03f4',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787604f34b80>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: users

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

mock_db = <MagicMock id='132448338779104'>
mock_user = CurrentUser(id=UUID('c21973bc-acce-48f5-a087-a148d51e03f4'), email='onboard_bdd9bc2f@test.io', tenant_id=None, role=<UserRole.MEMBER: 'member'>, tier=<PricingTier.STARTER: 'starter'>)

    @pytest.mark.asyncio
    async def test_onboard_connection_fail(mock_db, mock_user):
        from app.main import app
        from app.shared.db.session import get_db
        app.dependency_overrides[get_db] = lambda: mock_db
        app.dependency_overrides[get_current_user_from_jwt] = lambda: mock_user
        mock_db.execute.return_value.scalar_one_or_none.return_value = None
    
        mock_adapter = AsyncMock()
        mock_adapter.verify_connection.return_value = False
    
        with patch("app.shared.adapters.factory.AdapterFactory.get_adapter", return_value=mock_adapter):
            transport = ASGITransport(app=app)
            async with AsyncClient(transport=transport, base_url="http://test") as ac:
                payload = {
                    "tenant_name": "FailTenant",
                    "cloud_config": {"platform": "aws", "role_arn": "arn:aws:iam::..."}
                }
>               response = await ac.post("/api/v1/settings/onboard", json=payload)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_onboard_deep.py:169: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/onboard.py:39: in onboard
    existing = await db.execute(select(User).where(User.id == user.id))
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787604f34b80>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users
E               [SQL: SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
E               FROM users 
E               WHERE users.id = ?]
E               [parameters: ('c21973bcacce48f5a087a148d51e03f4',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:24,545 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:24,546 INFO sqlalchemy.engine.Engine SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
FROM users 
WHERE users.id = ?
2026-02-08 18:05:24,546 INFO sqlalchemy.engine.Engine [cached since 11.65s ago] ('c21973bcacce48f5a087a148d51e03f4',)
2026-02-08 18:05:24,546 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/onboard", "method": "POST", "error_id": "4f2b1d25-a1ec-4bf[PHONE_REDACTED]ff938", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: users\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/onboard.py\", line 39, in onboard\n    existing = await db.execute(select(User).where(User.id == user.id))\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users\n[SQL: SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role \nFROM users \nWHERE users.id = ?]\n[parameters: ('c[PHONE_REDACTED]bcacce48f5a087a148d51e03f4',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
FROM users 
WHERE users.id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 11.65s ago] ('c21973bcacce48f5a087a148d51e03f4',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
________________________ test_onboard_exception_handler ________________________

self = <sqlalchemy.engine.base.Connection object at 0x787609d03950>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x787609d03ad0>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x78761a034f50>
parameters = [('3ee2e9079b974b34826d12ec95008f10',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78760599b4c0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: users

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

mock_db = <MagicMock id='132448478241392'>
mock_user = CurrentUser(id=UUID('3ee2e907-9b97-4b34-826d-12ec95008f10'), email='onboard_7e00bca3@test.io', tenant_id=None, role=<UserRole.MEMBER: 'member'>, tier=<PricingTier.STARTER: 'starter'>)

    @pytest.mark.asyncio
    async def test_onboard_exception_handler(mock_db, mock_user):
        from app.main import app
        from app.shared.db.session import get_db
        app.dependency_overrides[get_db] = lambda: mock_db
        app.dependency_overrides[get_current_user_from_jwt] = lambda: mock_user
        mock_db.execute.return_value.scalar_one_or_none.return_value = None
    
        with patch("app.shared.adapters.factory.AdapterFactory.get_adapter", side_effect=Exception("Unexpected crash")):
            transport = ASGITransport(app=app)
            async with AsyncClient(transport=transport, base_url="http://test") as ac:
                payload = {
                    "tenant_name": "CrashTenant",
                    "cloud_config": {"platform": "aws", "role_arn": "arn:aws:iam::..."}
                }
>               response = await ac.post("/api/v1/settings/onboard", json=payload)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/settings/test_onboard_deep.py:191: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/onboard.py:39: in onboard
    existing = await db.execute(select(User).where(User.id == user.id))
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78760599b4c0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users
E               [SQL: SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
E               FROM users 
E               WHERE users.id = ?]
E               [parameters: ('3ee2e9079b974b34826d12ec95008f10',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:25,976 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:25,977 INFO sqlalchemy.engine.Engine SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
FROM users 
WHERE users.id = ?
2026-02-08 18:05:25,977 INFO sqlalchemy.engine.Engine [cached since 13.08s ago] ('3ee2e9079b974b34826d12ec95008f10',)
2026-02-08 18:05:25,978 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/onboard", "method": "POST", "error_id": "65cf337c-492e-4fe7-880b-40e32d[PHONE_REDACTED]", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: users\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/onboard.py\", line 39, in onboard\n    existing = await db.execute(select(User).where(User.id == user.id))\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users\n[SQL: SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role \nFROM users \nWHERE users.id = ?]\n[parameters: ('3ee2e9079b974b[PHONE_REDACTED]d12ec[PHONE_REDACTED]f10',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT users.id, users.tenant_id, users.email, users.email_bidx, users.role 
FROM users 
WHERE users.id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 13.08s ago] ('3ee2e9079b974b34826d12ec95008f10',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
__________________________ test_create_aws_connection __________________________

self = <sqlalchemy.engine.base.Connection object at 0x787606f2d250>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x787606f2d6d0>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x7876073c7b50>
parameters = [('5156acbc611648d8a2be466e506c1f74', '123456789012')]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787605a29240>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: aws_connections

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

ac = <httpx.AsyncClient object at 0x787609d03110>, override_auth = None
auth_user = CurrentUser(id=UUID('c3b8a231-332d-4554-90b6-a4824eaf4bfb'), email='test@valdrix.io', tenant_id=UUID('5156acbc-6116-48d8-a2be-466e506c1f74'), role=<UserRole.ADMIN: 'admin'>, tier=<PricingTier.FREE: 'free'>)
db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x78760733f000>

    @pytest.mark.asyncio
    async def test_create_aws_connection(ac, override_auth, auth_user, db):
        payload = {
            "aws_account_id": "123456789012",
            "role_arn": "arn:aws:iam::123456789012:role/Valdrix",
            "external_id": "vx-12345678901234567890123456789012",
            "region": "us-east-1",
            "is_management_account": True,
            "organization_id": "o-123"
        }
>       resp = await ac.post("/api/v1/settings/connections/aws", json=payload)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/test_connections_api.py:121: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/connections.py:117: in create_aws_connection
    existing = await db.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787605a29240>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: aws_connections
E               [SQL: SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
E               FROM aws_connections 
E               WHERE aws_connections.tenant_id = ? AND aws_connections.aws_account_id = ?]
E               [parameters: ('5156acbc611648d8a2be466e506c1f74', '123456789012')]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:30,031 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:30,032 INFO sqlalchemy.engine.Engine SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
FROM aws_connections 
WHERE aws_connections.tenant_id = ? AND aws_connections.aws_account_id = ?
2026-02-08 18:05:30,032 INFO sqlalchemy.engine.Engine [cached since 33.7s ago] ('5156acbc611648d8a2be466e506c1f74', '123456789012')
2026-02-08 18:05:30,033 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/connections/aws", "method": "POST", "error_id": "[PHONE_REDACTED]f-[PHONE_REDACTED]d0-b8c2-9c[PHONE_REDACTED]ce1e", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: aws_connections\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 117, in create_aws_connection\n    existing = await db.execute(\n               ^^^^^^^^^^^^^^^^^\n    ...<4 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: aws_connections\n[SQL: SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at \nFROM aws_connections \nWHERE aws_connections.tenant_id = ? AND aws_connections.aws_account_id = ?]\n[parameters: ('5156acbc[PHONE_REDACTED]d8a2be466e506c1f74', '[PHONE_REDACTED]')]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
FROM aws_connections 
WHERE aws_connections.tenant_id = ? AND aws_connections.aws_account_id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 33.7s ago] ('5156acbc611648d8a2be466e506c1f74', '123456789012')
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
________________________ test_duplicate_aws_connection _________________________

self = <sqlalchemy.engine.base.Connection object at 0x78761a6d2150>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x78761a6d22d0>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x7876073c7b50>
parameters = [('8e15ab663e9a48a8bcaace6fe5eb6575', '999999999999')]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787605a82680>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: aws_connections

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

ac = <httpx.AsyncClient object at 0x787606c22750>
db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x78760733ca60>
override_auth = None
auth_user = CurrentUser(id=UUID('e3a139f4-3192-4f38-a1d8-689a8fe64a61'), email='test@valdrix.io', tenant_id=UUID('8e15ab66-3e9a-48a8-bcaa-ce6fe5eb6575'), role=<UserRole.ADMIN: 'admin'>, tier=<PricingTier.FREE: 'free'>)

    @pytest.mark.asyncio
    async def test_duplicate_aws_connection(ac, db, override_auth, auth_user):
        # Pre-create a connection
        conn = AWSConnection(
            tenant_id=auth_user.tenant_id,
            aws_account_id="999999999999",
            role_arn="arn:aws:iam::999999999999:role/Valdrix",
            external_id="vx-99999999999999999999999999999999",
            status="pending"
        )
        db.add(conn)
        await db.commit()
    
        payload = {
            "aws_account_id": "999999999999",
            "role_arn": "arn:aws:iam::999999999999:role/Valdrix",
            "external_id": "vx-99999999999999999999999999999999",
            "region": "us-east-1"
        }
>       resp = await ac.post("/api/v1/settings/connections/aws", json=payload)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/test_connections_api.py:147: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/connections.py:117: in create_aws_connection
    existing = await db.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787605a82680>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: aws_connections
E               [SQL: SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
E               FROM aws_connections 
E               WHERE aws_connections.tenant_id = ? AND aws_connections.aws_account_id = ?]
E               [parameters: ('8e15ab663e9a48a8bcaace6fe5eb6575', '999999999999')]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:31,474 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:31,474 INFO sqlalchemy.engine.Engine SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
FROM aws_connections 
WHERE aws_connections.tenant_id = ? AND aws_connections.aws_account_id = ?
2026-02-08 18:05:31,475 INFO sqlalchemy.engine.Engine [cached since 35.15s ago] ('8e15ab663e9a48a8bcaace6fe5eb6575', '999999999999')
2026-02-08 18:05:31,475 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/connections/aws", "method": "POST", "error_id": "9e677db9-23ca-[PHONE_REDACTED]d63-e[PHONE_REDACTED]b8", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: aws_connections\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 117, in create_aws_connection\n    existing = await db.execute(\n               ^^^^^^^^^^^^^^^^^\n    ...<4 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: aws_connections\n[SQL: SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at \nFROM aws_connections \nWHERE aws_connections.tenant_id = ? AND aws_connections.aws_account_id = ?]\n[parameters: ('8e15ab663e9a48a8bcaace6fe5eb6575', '[PHONE_REDACTED]')]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
FROM aws_connections 
WHERE aws_connections.tenant_id = ? AND aws_connections.aws_account_id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 35.15s ago] ('8e15ab663e9a48a8bcaace6fe5eb6575', '999999999999')
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
______________________________ test_sync_aws_org _______________________________

self = <sqlalchemy.engine.base.Connection object at 0x78761a6d3650>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x78761a6d3710>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x787606e2a150>
parameters = [('7fea6add34404cd5980f164e1f56f16e', 'd0b615dfedca4917add03d214b7530b4')]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787604cbf7c0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: aws_connections

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

ac = <httpx.AsyncClient object at 0x787619376b10>
db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x78760733dda0>
override_auth = None
auth_user = CurrentUser(id=UUID('5c14759d-bf0b-49cb-9f60-07bfec3c26e5'), email='test@valdrix.io', tenant_id=UUID('d0b615df-edca-4917-add0-3d214b7530b4'), role=<UserRole.ADMIN: 'admin'>, tier=<PricingTier.FREE: 'free'>)

    @pytest.mark.asyncio
    async def test_sync_aws_org(ac, db, override_auth, auth_user):
        # Create management account
        conn = AWSConnection(
            tenant_id=auth_user.tenant_id,
            aws_account_id="112233445566",
            role_arn="arn:aws:iam::112233445566:role/Valdrix",
            external_id="vx-11223344556611223344556611223344",
            is_management_account=True,
            status="active"
        )
        db.add(conn)
        await db.commit()
    
        with patch("app.shared.connections.organizations.OrganizationsDiscoveryService.sync_accounts") as mock_sync:
            mock_sync.return_value = 5
>           resp = await ac.post(f"/api/v1/settings/connections/aws/{conn.id}/sync-org")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/test_connections_api.py:166: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/connections.py:195: in sync_aws_org
    result = await db.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787604cbf7c0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: aws_connections
E               [SQL: SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
E               FROM aws_connections 
E               WHERE aws_connections.id = ? AND aws_connections.tenant_id = ?]
E               [parameters: ('7fea6add34404cd5980f164e1f56f16e', 'd0b615dfedca4917add03d214b7530b4')]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:32,948 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:32,949 INFO sqlalchemy.engine.Engine SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
FROM aws_connections 
WHERE aws_connections.id = ? AND aws_connections.tenant_id = ?
2026-02-08 18:05:32,950 INFO sqlalchemy.engine.Engine [generated in 0.00025s] ('7fea6add34404cd5980f164e1f56f16e', 'd0b615dfedca4917add03d214b7530b4')
2026-02-08 18:05:32,950 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/connections/aws/7fea6add-[PHONE_REDACTED]cd5-980f-164e1f56f16e/sync-org", "method": "POST", "error_id": "af1580f7-635c-4f51-bfee-b5b418b[PHONE_REDACTED]", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: aws_connections\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 195, in sync_aws_org\n    result = await db.execute(\n             ^^^^^^^^^^^^^^^^^\n    ...<4 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: aws_connections\n[SQL: SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at \nFROM aws_connections \nWHERE aws_connections.id = ? AND aws_connections.tenant_id = ?]\n[parameters: ('7fea6add[PHONE_REDACTED]cd5980f164e1f56f16e', 'd0b615dfedca4917add03d214b7530b4')]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
FROM aws_connections 
WHERE aws_connections.id = ? AND aws_connections.tenant_id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00025s] ('7fea6add34404cd5980f164e1f56f16e', 'd0b615dfedca4917add03d214b7530b4')
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
_______________________ test_sync_aws_org_not_management _______________________

self = <sqlalchemy.engine.base.Connection object at 0x7876195e19d0>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x7876195e1a90>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x787606e2a150>
parameters = [('8ca01017ff1e43d98082ccdac2be551b', '440682d32a9a4eb8b23a0dfa759ee962')]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787604a61780>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: aws_connections

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

ac = <httpx.AsyncClient object at 0x78761a6d3ad0>
db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x78760733f3f0>
override_auth = None
auth_user = CurrentUser(id=UUID('b5167bd7-7b85-4a18-b538-fa7938d19cff'), email='test@valdrix.io', tenant_id=UUID('440682d3-2a9a-4eb8-b23a-0dfa759ee962'), role=<UserRole.ADMIN: 'admin'>, tier=<PricingTier.FREE: 'free'>)

    @pytest.mark.asyncio
    async def test_sync_aws_org_not_management(ac, db, override_auth, auth_user):
        # Standard connection (not management)
        conn = AWSConnection(
            tenant_id=auth_user.tenant_id,
            aws_account_id="998877665544",
            role_arn="arn:aws:iam::998877665544:role/Valdrix",
            external_id="vx-998877665544",
            is_management_account=False,
            status="active"
        )
        db.add(conn)
        await db.commit()
    
>       resp = await ac.post(f"/api/v1/settings/connections/aws/{conn.id}/sync-org")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/test_connections_api.py:184: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/connections.py:195: in sync_aws_org
    result = await db.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787604a61780>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: aws_connections
E               [SQL: SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
E               FROM aws_connections 
E               WHERE aws_connections.id = ? AND aws_connections.tenant_id = ?]
E               [parameters: ('8ca01017ff1e43d98082ccdac2be551b', '440682d32a9a4eb8b23a0dfa759ee962')]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:34,380 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:34,381 INFO sqlalchemy.engine.Engine SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
FROM aws_connections 
WHERE aws_connections.id = ? AND aws_connections.tenant_id = ?
2026-02-08 18:05:34,381 INFO sqlalchemy.engine.Engine [cached since 1.431s ago] ('8ca01017ff1e43d98082ccdac2be551b', '440682d32a9a4eb8b23a0dfa759ee962')
2026-02-08 18:05:34,381 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/connections/aws/8ca[PHONE_REDACTED]-ff1e-43d[PHONE_REDACTED]-ccdac2be551b/sync-org", "method": "POST", "error_id": "28e155e6-4dcf-46f8-b29a-740ef62ff0f2", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: aws_connections\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 195, in sync_aws_org\n    result = await db.execute(\n             ^^^^^^^^^^^^^^^^^\n    ...<4 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: aws_connections\n[SQL: SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at \nFROM aws_connections \nWHERE aws_connections.id = ? AND aws_connections.tenant_id = ?]\n[parameters: ('8ca[PHONE_REDACTED]ff1e43d[PHONE_REDACTED]ccdac2be551b', '[PHONE_REDACTED]d32a9a4eb8b23a0dfa759ee962')]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
FROM aws_connections 
WHERE aws_connections.id = ? AND aws_connections.tenant_id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 1.431s ago] ('8ca01017ff1e43d98082ccdac2be551b', '440682d32a9a4eb8b23a0dfa759ee962')
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
__________________________ test_list_aws_connections ___________________________

self = <sqlalchemy.engine.base.Connection object at 0x7876195e3dd0>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x7876195e3e90>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x787606cb1c50>
parameters = [('19e26e84e9414322bbfcb3ba81075442',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787605852200>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: aws_connections

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

ac = <httpx.AsyncClient object at 0x7876195e2810>
db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x787606e18670>
override_auth = None
auth_user = CurrentUser(id=UUID('b6403a80-2206-4a2f-b47c-3b7bffd9d5db'), email='test@valdrix.io', tenant_id=UUID('19e26e84-e941-4322-bbfc-b3ba81075442'), role=<UserRole.ADMIN: 'admin'>, tier=<PricingTier.FREE: 'free'>)

    @pytest.mark.asyncio
    async def test_list_aws_connections(ac, db, override_auth, auth_user):
        conn = AWSConnection(tenant_id=auth_user.tenant_id, aws_account_id="123", role_arn="arn", external_id="vx-123", status="active")
        db.add(conn)
        await db.commit()
>       resp = await ac.get("/api/v1/settings/connections/aws")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/test_connections_api.py:192: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1768: in get
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:380: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/connections.py:152: in list_aws_connections
    result = await db.execute(select(AWSConnection).where(AWSConnection.tenant_id == current_user.tenant_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787605852200>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: aws_connections
E               [SQL: SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
E               FROM aws_connections 
E               WHERE aws_connections.tenant_id = ?]
E               [parameters: ('19e26e84e9414322bbfcb3ba81075442',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:35,766 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:35,767 INFO sqlalchemy.engine.Engine SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
FROM aws_connections 
WHERE aws_connections.tenant_id = ?
2026-02-08 18:05:35,768 INFO sqlalchemy.engine.Engine [generated in 0.00023s] ('19e26e84e9414322bbfcb3ba81075442',)
2026-02-08 18:05:35,768 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/connections/aws", "method": "GET", "error_id": "262ef85d-[PHONE_REDACTED]d17-9e[PHONE_REDACTED]dbe1b8", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: aws_connections\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 380, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 152, in list_aws_connections\n    result = await db.execute(select(AWSConnection).where(AWSConnection.tenant_id == current_user.tenant_id))\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: aws_connections\n[SQL: SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at \nFROM aws_connections \nWHERE aws_connections.tenant_id = ?]\n[parameters: ('19e26e84e[PHONE_REDACTED]bbfcb3ba[PHONE_REDACTED]',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
FROM aws_connections 
WHERE aws_connections.tenant_id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00023s] ('19e26e84e9414322bbfcb3ba81075442',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
__________________________ test_delete_aws_connection __________________________

self = <sqlalchemy.engine.base.Connection object at 0x78760454b410>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x78760454b4d0>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x787606e2a150>
parameters = [('ebaea55a09a449278a968aa85d7fac52', '42074b7e8520416dae83405df60dc61c')]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787604b7a4a0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: aws_connections

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

ac = <httpx.AsyncClient object at 0x787606c23f50>
db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x787606cfd860>
override_auth = None
auth_user = CurrentUser(id=UUID('27d394fa-b7dd-4aff-8eda-394218ff0ac9'), email='test@valdrix.io', tenant_id=UUID('42074b7e-8520-416d-ae83-405df60dc61c'), role=<UserRole.ADMIN: 'admin'>, tier=<PricingTier.FREE: 'free'>)

    @pytest.mark.asyncio
    async def test_delete_aws_connection(ac, db, override_auth, auth_user):
        conn = AWSConnection(tenant_id=auth_user.tenant_id, aws_account_id="delete-me", role_arn="arn", external_id="vx-123", status="active")
        db.add(conn)
        await db.commit()
>       resp = await ac.delete(f"/api/v1/settings/connections/aws/{conn.id}")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/test_connections_api.py:211: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1966: in delete
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/connections.py:173: in delete_aws_connection
    result = await db.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787604b7a4a0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: aws_connections
E               [SQL: SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
E               FROM aws_connections 
E               WHERE aws_connections.id = ? AND aws_connections.tenant_id = ?]
E               [parameters: ('ebaea55a09a449278a968aa85d7fac52', '42074b7e8520416dae83405df60dc61c')]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:38,127 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:38,128 INFO sqlalchemy.engine.Engine SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
FROM aws_connections 
WHERE aws_connections.id = ? AND aws_connections.tenant_id = ?
2026-02-08 18:05:38,128 INFO sqlalchemy.engine.Engine [cached since 5.179s ago] ('ebaea55a09a449278a968aa85d7fac52', '42074b7e8520416dae83405df60dc61c')
2026-02-08 18:05:38,129 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/connections/aws/ebaea55a-09a[PHONE_REDACTED]a96-8aa85d7fac52", "method": "DELETE", "error_id": "01dac[PHONE_REDACTED]cf-8e[PHONE_REDACTED]f3f77be6", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: aws_connections\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 173, in delete_aws_connection\n    result = await db.execute(\n             ^^^^^^^^^^^^^^^^^\n    ...<4 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: aws_connections\n[SQL: SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at \nFROM aws_connections \nWHERE aws_connections.id = ? AND aws_connections.tenant_id = ?]\n[parameters: ('ebaea55a09a[PHONE_REDACTED]a968aa85d7fac52', '[PHONE_REDACTED]b7e[PHONE_REDACTED]dae[PHONE_REDACTED]df60dc61c')]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT aws_connections.id, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
FROM aws_connections 
WHERE aws_connections.id = ? AND aws_connections.tenant_id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 5.179s ago] ('ebaea55a09a449278a968aa85d7fac52', '42074b7e8520416dae83405df60dc61c')
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
_________________ test_create_azure_connection_denied_on_free __________________

self = <sqlalchemy.engine.base.Connection object at 0x78760360d6d0>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x78760360c590>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x7876199a9850>
parameters = [('02d0851fb50d4099a6b2cacb3e667d42',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x7876059c0e80>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: tenants

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

ac = <httpx.AsyncClient object at 0x78760454bdd0>, override_auth = None

    @pytest.mark.asyncio
    async def test_create_azure_connection_denied_on_free(ac, override_auth):
        payload = {
            "name": "Azure Test",
            "azure_tenant_id": str(uuid4()),
            "client_id": str(uuid4()),
            "subscription_id": str(uuid4()),
            "client_secret": "secret"
        }
>       resp = await ac.post("/api/v1/settings/connections/azure", json=payload)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/test_connections_api.py:229: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/connections.py:302: in create_azure_connection
    await check_growth_tier(current_user, db)
app/modules/governance/api/v1/settings/connections.py:52: in check_growth_tier
    result = await db.execute(select(Tenant).where(Tenant.id == user.tenant_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x7876059c0e80>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: tenants
E               [SQL: SELECT tenants.id, tenants.name, tenants.name_bidx, tenants."plan", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at 
E               FROM tenants 
E               WHERE tenants.id = ?]
E               [parameters: ('02d0851fb50d4099a6b2cacb3e667d42',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:39,564 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:39,565 INFO sqlalchemy.engine.Engine SELECT tenants.id, tenants.name, tenants.name_bidx, tenants."plan", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at 
FROM tenants 
WHERE tenants.id = ?
2026-02-08 18:05:39,565 INFO sqlalchemy.engine.Engine [cached since 41.8s ago] ('02d0851fb50d4099a6b2cacb3e667d42',)
2026-02-08 18:05:39,565 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/connections/azure", "method": "POST", "error_id": "35cf96ba-a3fb-4d7a-ac32-ca[PHONE_REDACTED]fa", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: tenants\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 302, in create_azure_connection\n    await check_growth_tier(current_user, db)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 52, in check_growth_tier\n    result = await db.execute(select(Tenant).where(Tenant.id == user.tenant_id))\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: tenants\n[SQL: SELECT tenants.id, tenants.name, tenants.name_bidx, tenants.\"plan\", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at \nFROM tenants \nWHERE tenants.id = ?]\n[parameters: ('02d0851fb50d4099a6b2cacb3e667d42',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT tenants.id, tenants.name, tenants.name_bidx, tenants."plan", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at 
FROM tenants 
WHERE tenants.id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 41.8s ago] ('02d0851fb50d4099a6b2cacb3e667d42',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
________________ test_create_azure_connection_success_on_growth ________________

self = <sqlalchemy.engine.base.Connection object at 0x78760360ec90>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x78760360dd90>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x7876199a9850>
parameters = [('4766e4b827c1409d9de813e1ab32f5df',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787605a45900>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: tenants

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

ac = <httpx.AsyncClient object at 0x78760454a510>
db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x787606cf9e80>
override_auth = None
auth_user = CurrentUser(id=UUID('35fe360d-4b07-48f0-84b6-e3e4f09af03b'), email='test@valdrix.io', tenant_id=UUID('4766e4b8-27c1-409d-9de8-13e1ab32f5df'), role=<UserRole.ADMIN: 'admin'>, tier=<PricingTier.GROWTH: 'growth'>)

    @pytest.mark.asyncio
    async def test_create_azure_connection_success_on_growth(ac, db, override_auth, auth_user):
        # Upgrade tenant
        tenant = await db.get(Tenant, auth_user.tenant_id)
        tenant.plan = PricingTier.GROWTH.value
        await db.commit()
        auth_user.tier = PricingTier.GROWTH
    
        payload = {
            "name": "Azure Growth",
            "azure_tenant_id": str(uuid4()),
            "client_id": str(uuid4()),
            "subscription_id": str(uuid4()),
            "client_secret": "secret"
        }
>       resp = await ac.post("/api/v1/settings/connections/azure", json=payload)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/test_connections_api.py:256: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/connections.py:302: in create_azure_connection
    await check_growth_tier(current_user, db)
app/modules/governance/api/v1/settings/connections.py:52: in check_growth_tier
    result = await db.execute(select(Tenant).where(Tenant.id == user.tenant_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787605a45900>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: tenants
E               [SQL: SELECT tenants.id, tenants.name, tenants.name_bidx, tenants."plan", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at 
E               FROM tenants 
E               WHERE tenants.id = ?]
E               [parameters: ('4766e4b827c1409d9de813e1ab32f5df',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:40,971 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:40,972 INFO sqlalchemy.engine.Engine SELECT tenants.id, tenants.name, tenants.name_bidx, tenants."plan", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at 
FROM tenants 
WHERE tenants.id = ?
2026-02-08 18:05:40,972 INFO sqlalchemy.engine.Engine [cached since 43.21s ago] ('4766e4b827c1409d9de813e1ab32f5df',)
2026-02-08 18:05:40,972 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/connections/azure", "method": "POST", "error_id": "74c7c157-add7-4f[PHONE_REDACTED]f-ebd5e9954d8d", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: tenants\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 302, in create_azure_connection\n    await check_growth_tier(current_user, db)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 52, in check_growth_tier\n    result = await db.execute(select(Tenant).where(Tenant.id == user.tenant_id))\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: tenants\n[SQL: SELECT tenants.id, tenants.name, tenants.name_bidx, tenants.\"plan\", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at \nFROM tenants \nWHERE tenants.id = ?]\n[parameters: ('4766e4b827c1409d9de813e1ab32f5df',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT tenants.id, tenants.name, tenants.name_bidx, tenants."plan", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at 
FROM tenants 
WHERE tenants.id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 43.21s ago] ('4766e4b827c1409d9de813e1ab32f5df',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
_________________________ test_verify_azure_connection _________________________

self = <sqlalchemy.engine.base.Connection object at 0x7876087d47d0>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x7876087d4890>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x7876199a9850>
parameters = [('3f0e7dca15694e4c8503239deddb1ffe',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x7876038a23e0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: tenants

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

ac = <httpx.AsyncClient object at 0x78760360eb10>
db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x787606cf9e10>
override_auth = None
auth_user = CurrentUser(id=UUID('859982ed-e1bb-47b2-84ac-6b509e4470f0'), email='test@valdrix.io', tenant_id=UUID('3f0e7dca-1569-4e4c-8503-239deddb1ffe'), role=<UserRole.ADMIN: 'admin'>, tier=<PricingTier.GROWTH: 'growth'>)

    @pytest.mark.asyncio
    async def test_verify_azure_connection(ac, db, override_auth, auth_user):
        tenant = await db.get(Tenant, auth_user.tenant_id)
        tenant.plan = PricingTier.GROWTH.value
        await db.commit()
        auth_user.tier = PricingTier.GROWTH
    
        conn = AzureConnection(tenant_id=auth_user.tenant_id, name="Az", azure_tenant_id="t", client_id="c", subscription_id="s")
        db.add(conn)
        await db.commit()
        with patch("app.shared.connections.azure.AzureConnectionService.verify_connection") as mock_verify:
            mock_verify.return_value = {"status": "verified"}
>           resp = await ac.post(f"/api/v1/settings/connections/azure/{conn.id}/verify")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/test_connections_api.py:272: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/connections.py:341: in verify_azure_connection
    await check_growth_tier(current_user, db)
app/modules/governance/api/v1/settings/connections.py:52: in check_growth_tier
    result = await db.execute(select(Tenant).where(Tenant.id == user.tenant_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x7876038a23e0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: tenants
E               [SQL: SELECT tenants.id, tenants.name, tenants.name_bidx, tenants."plan", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at 
E               FROM tenants 
E               WHERE tenants.id = ?]
E               [parameters: ('3f0e7dca15694e4c8503239deddb1ffe',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:42,392 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:42,392 INFO sqlalchemy.engine.Engine SELECT tenants.id, tenants.name, tenants.name_bidx, tenants."plan", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at 
FROM tenants 
WHERE tenants.id = ?
2026-02-08 18:05:42,392 INFO sqlalchemy.engine.Engine [cached since 44.63s ago] ('3f0e7dca15694e4c8503239deddb1ffe',)
2026-02-08 18:05:42,393 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/connections/azure/[PHONE_REDACTED]a7-cb6d-45e5-85e7-020bb[PHONE_REDACTED]e/verify", "method": "POST", "error_id": "343b2b07-9d6b-43ed-b3cb-dbb4b4299daa", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: tenants\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 341, in verify_azure_connection\n    await check_growth_tier(current_user, db)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 52, in check_growth_tier\n    result = await db.execute(select(Tenant).where(Tenant.id == user.tenant_id))\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: tenants\n[SQL: SELECT tenants.id, tenants.name, tenants.name_bidx, tenants.\"plan\", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at \nFROM tenants \nWHERE tenants.id = ?]\n[parameters: ('3f0e7dca[PHONE_REDACTED]e4c[PHONE_REDACTED]deddb1ffe',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT tenants.id, tenants.name, tenants.name_bidx, tenants."plan", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at 
FROM tenants 
WHERE tenants.id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 44.63s ago] ('3f0e7dca15694e4c8503239deddb1ffe',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
_________________________ test_list_azure_connections __________________________

self = <sqlalchemy.engine.base.Connection object at 0x7876087d6690>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x7876087d56d0>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x787619614050>
parameters = [('f80598ea79d5403eb27e71a1494ba320',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787603762620>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: azure_connections

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

ac = <httpx.AsyncClient object at 0x78760360ee10>
db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x787606cfbe70>
override_auth = None
auth_user = CurrentUser(id=UUID('25e11fd7-6057-476b-884f-f13764997f87'), email='test@valdrix.io', tenant_id=UUID('f80598ea-79d5-403e-b27e-71a1494ba320'), role=<UserRole.ADMIN: 'admin'>, tier=<PricingTier.FREE: 'free'>)

    @pytest.mark.asyncio
    async def test_list_azure_connections(ac, db, override_auth, auth_user):
        # Retrieve regardless of tier
>       resp = await ac.get("/api/v1/settings/connections/azure")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/test_connections_api.py:278: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1768: in get
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:380: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/connections.py:351: in list_azure_connections
    return await AzureConnectionService(db).list_connections(current_user.tenant_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/connections/azure.py:13: in list_connections
    result = await self.db.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787603762620>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: azure_connections
E               [SQL: SELECT azure_connections.id, azure_connections.tenant_id, azure_connections.name, azure_connections.azure_tenant_id, azure_connections.client_id, azure_connections.subscription_id, azure_connections.client_secret, azure_connections.auth_method, azure_connections.is_active, azure_connections.last_synced_at, azure_connections.last_ingested_at, azure_connections.error_message, azure_connections.created_at, azure_connections.updated_at 
E               FROM azure_connections 
E               WHERE azure_connections.tenant_id = ?]
E               [parameters: ('f80598ea79d5403eb27e71a1494ba320',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:43,773 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:43,774 INFO sqlalchemy.engine.Engine SELECT azure_connections.id, azure_connections.tenant_id, azure_connections.name, azure_connections.azure_tenant_id, azure_connections.client_id, azure_connections.subscription_id, azure_connections.client_secret, azure_connections.auth_method, azure_connections.is_active, azure_connections.last_synced_at, azure_connections.last_ingested_at, azure_connections.error_message, azure_connections.created_at, azure_connections.updated_at 
FROM azure_connections 
WHERE azure_connections.tenant_id = ?
2026-02-08 18:05:43,775 INFO sqlalchemy.engine.Engine [generated in 0.00024s] ('f80598ea79d5403eb27e71a1494ba320',)
2026-02-08 18:05:43,775 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/connections/azure", "method": "GET", "error_id": "[PHONE_REDACTED]e6a-56b9-42b4-a357-b1b0bccf46bc", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: azure_connections\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 380, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 351, in list_azure_connections\n    return await AzureConnectionService(db).list_connections(current_user.tenant_id)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/connections/azure.py\", line 13, in list_connections\n    result = await self.db.execute(\n             ^^^^^^^^^^^^^^^^^^^^^^\n        select(AzureConnection).where(AzureConnection.tenant_id == tenant_id)\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: azure_connections\n[SQL: SELECT azure_connections.id, azure_connections.tenant_id, azure_connections.name, azure_connections.azure_tenant_id, azure_connections.client_id, azure_connections.subscription_id, azure_connections.client_secret, azure_connections.auth_method, azure_connections.is_active, azure_connections.last_synced_at, azure_connections.last_ingested_at, azure_connections.error_message, azure_connections.created_at, azure_connections.updated_at \nFROM azure_connections \nWHERE azure_connections.tenant_id = ?]\n[parameters: ('f[PHONE_REDACTED]ea79d5403eb27e71a1494ba320',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT azure_connections.id, azure_connections.tenant_id, azure_connections.name, azure_connections.azure_tenant_id, azure_connections.client_id, azure_connections.subscription_id, azure_connections.client_secret, azure_connections.auth_method, azure_connections.is_active, azure_connections.last_synced_at, azure_connections.last_ingested_at, azure_connections.error_message, azure_connections.created_at, azure_connections.updated_at 
FROM azure_connections 
WHERE azure_connections.tenant_id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00024s] ('f80598ea79d5403eb27e71a1494ba320',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
_________________ test_create_gcp_connection_success_on_growth _________________

self = <sqlalchemy.engine.base.Connection object at 0x7876087d71d0>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x7876087d6450>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x7876199a9850>
parameters = [('161ea7b2b3354937adb7d179ec4014c5',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78760331efe0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: tenants

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

ac = <httpx.AsyncClient object at 0x7876087d6d50>
db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7876087b1a90>
override_auth = None
auth_user = CurrentUser(id=UUID('2b80e717-be18-4a5e-a6a7-7edc5c838537'), email='test@valdrix.io', tenant_id=UUID('161ea7b2-b335-4937-adb7-d179ec4014c5'), role=<UserRole.ADMIN: 'admin'>, tier=<PricingTier.GROWTH: 'growth'>)

    @pytest.mark.asyncio
    async def test_create_gcp_connection_success_on_growth(ac, db, override_auth, auth_user):
        # Upgrade tenant
        tenant = await db.get(Tenant, auth_user.tenant_id)
        tenant.plan = PricingTier.GROWTH.value
        await db.commit()
        auth_user.tier = PricingTier.GROWTH
    
        payload = {
            "name": "GCP Project",
            "project_id": "test-project-123",
            "service_account_json": "{}",
            "auth_method": "secret"
        }
>       resp = await ac.post("/api/v1/settings/connections/gcp", json=payload)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/test_connections_api.py:297: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/connections.py:386: in create_gcp_connection
    await check_growth_tier(current_user, db)
app/modules/governance/api/v1/settings/connections.py:52: in check_growth_tier
    result = await db.execute(select(Tenant).where(Tenant.id == user.tenant_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x78760331efe0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: tenants
E               [SQL: SELECT tenants.id, tenants.name, tenants.name_bidx, tenants."plan", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at 
E               FROM tenants 
E               WHERE tenants.id = ?]
E               [parameters: ('161ea7b2b3354937adb7d179ec4014c5',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:45,352 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:45,354 INFO sqlalchemy.engine.Engine SELECT tenants.id, tenants.name, tenants.name_bidx, tenants."plan", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at 
FROM tenants 
WHERE tenants.id = ?
2026-02-08 18:05:45,354 INFO sqlalchemy.engine.Engine [cached since 47.59s ago] ('161ea7b2b3354937adb7d179ec4014c5',)
2026-02-08 18:05:45,355 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/connections/gcp", "method": "POST", "error_id": "10f829ba-d66f-477f-b6ef-4e24e2f10f12", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: tenants\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 386, in create_gcp_connection\n    await check_growth_tier(current_user, db)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 52, in check_growth_tier\n    result = await db.execute(select(Tenant).where(Tenant.id == user.tenant_id))\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: tenants\n[SQL: SELECT tenants.id, tenants.name, tenants.name_bidx, tenants.\"plan\", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at \nFROM tenants \nWHERE tenants.id = ?]\n[parameters: ('161ea7b2b[PHONE_REDACTED]adb7d179ec4014c5',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT tenants.id, tenants.name, tenants.name_bidx, tenants."plan", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at 
FROM tenants 
WHERE tenants.id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 47.59s ago] ('161ea7b2b3354937adb7d179ec4014c5',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
__________________________ test_list_gcp_connections ___________________________

self = <sqlalchemy.engine.base.Connection object at 0x78761955d310>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x78761955d3d0>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x7876195b4050>
parameters = [('a38e659444854fc88ea2bbb4f1124874',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x7876038e9360>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: gcp_connections

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

ac = <httpx.AsyncClient object at 0x7876087d5cd0>
db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7876087b1b70>
override_auth = None
auth_user = CurrentUser(id=UUID('4f581fb0-50f4-442b-94db-cd0eca1c8522'), email='test@valdrix.io', tenant_id=UUID('a38e6594-4485-4fc8-8ea2-bbb4f1124874'), role=<UserRole.ADMIN: 'admin'>, tier=<PricingTier.FREE: 'free'>)

    @pytest.mark.asyncio
    async def test_list_gcp_connections(ac, db, override_auth, auth_user):
>       resp = await ac.get("/api/v1/settings/connections/gcp")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/test_connections_api.py:303: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1768: in get
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:380: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/connections.py:436: in list_gcp_connections
    result = await db.execute(select(GCPConnection).where(GCPConnection.tenant_id == current_user.tenant_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x7876038e9360>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: gcp_connections
E               [SQL: SELECT gcp_connections.id, gcp_connections.tenant_id, gcp_connections.name, gcp_connections.project_id, gcp_connections.service_account_json, gcp_connections.auth_method, gcp_connections.billing_project_id, gcp_connections.billing_dataset, gcp_connections.billing_table, gcp_connections.is_active, gcp_connections.last_synced_at, gcp_connections.last_ingested_at, gcp_connections.error_message, gcp_connections.created_at, gcp_connections.updated_at 
E               FROM gcp_connections 
E               WHERE gcp_connections.tenant_id = ?]
E               [parameters: ('a38e659444854fc88ea2bbb4f1124874',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:47,735 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:47,737 INFO sqlalchemy.engine.Engine SELECT gcp_connections.id, gcp_connections.tenant_id, gcp_connections.name, gcp_connections.project_id, gcp_connections.service_account_json, gcp_connections.auth_method, gcp_connections.billing_project_id, gcp_connections.billing_dataset, gcp_connections.billing_table, gcp_connections.is_active, gcp_connections.last_synced_at, gcp_connections.last_ingested_at, gcp_connections.error_message, gcp_connections.created_at, gcp_connections.updated_at 
FROM gcp_connections 
WHERE gcp_connections.tenant_id = ?
2026-02-08 18:05:47,738 INFO sqlalchemy.engine.Engine [generated in 0.00034s] ('a38e659444854fc88ea2bbb4f1124874',)
2026-02-08 18:05:47,738 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/connections/gcp", "method": "GET", "error_id": "bc8f[PHONE_REDACTED]-[PHONE_REDACTED]e88ae1c1", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: gcp_connections\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 380, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 436, in list_gcp_connections\n    result = await db.execute(select(GCPConnection).where(GCPConnection.tenant_id == current_user.tenant_id))\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: gcp_connections\n[SQL: SELECT gcp_connections.id, gcp_connections.tenant_id, gcp_connections.name, gcp_connections.project_id, gcp_connections.service_account_json, gcp_connections.auth_method, gcp_connections.billing_project_id, gcp_connections.billing_dataset, gcp_connections.billing_table, gcp_connections.is_active, gcp_connections.last_synced_at, gcp_connections.last_ingested_at, gcp_connections.error_message, gcp_connections.created_at, gcp_connections.updated_at \nFROM gcp_connections \nWHERE gcp_connections.tenant_id = ?]\n[parameters: ('a38e[PHONE_REDACTED]fc88ea2bbb4f[PHONE_REDACTED]',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT gcp_connections.id, gcp_connections.tenant_id, gcp_connections.name, gcp_connections.project_id, gcp_connections.service_account_json, gcp_connections.auth_method, gcp_connections.billing_project_id, gcp_connections.billing_dataset, gcp_connections.billing_table, gcp_connections.is_active, gcp_connections.last_synced_at, gcp_connections.last_ingested_at, gcp_connections.error_message, gcp_connections.created_at, gcp_connections.updated_at 
FROM gcp_connections 
WHERE gcp_connections.tenant_id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00034s] ('a38e659444854fc88ea2bbb4f1124874',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
__________________________ test_delete_gcp_connection __________________________

self = <sqlalchemy.engine.base.Connection object at 0x78761955f410>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x78761955f4d0>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x7876195b6050>
parameters = [('aecaa0d329f941ccbe6dc5e4b1432dc3', '1829c25a4438491f9a2508de8be07830')]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x7876059c0a60>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: gcp_connections

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

ac = <httpx.AsyncClient object at 0x7876087d6f90>
db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7876087ffa80>
override_auth = None
auth_user = CurrentUser(id=UUID('f4ca1c4a-a3b7-4b11-af7b-f3335f689724'), email='test@valdrix.io', tenant_id=UUID('1829c25a-4438-491f-9a25-08de8be07830'), role=<UserRole.ADMIN: 'admin'>, tier=<PricingTier.FREE: 'free'>)

    @pytest.mark.asyncio
    async def test_delete_gcp_connection(ac, db, override_auth, auth_user):
        conn = GCPConnection(tenant_id=auth_user.tenant_id, name="g", project_id="p")
        db.add(conn)
        await db.commit()
>       resp = await ac.delete(f"/api/v1/settings/connections/gcp/{conn.id}")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/test_connections_api.py:311: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1966: in delete
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/connections.py:446: in delete_gcp_connection
    result = await db.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x7876059c0a60>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: gcp_connections
E               [SQL: SELECT gcp_connections.id, gcp_connections.tenant_id, gcp_connections.name, gcp_connections.project_id, gcp_connections.service_account_json, gcp_connections.auth_method, gcp_connections.billing_project_id, gcp_connections.billing_dataset, gcp_connections.billing_table, gcp_connections.is_active, gcp_connections.last_synced_at, gcp_connections.last_ingested_at, gcp_connections.error_message, gcp_connections.created_at, gcp_connections.updated_at 
E               FROM gcp_connections 
E               WHERE gcp_connections.id = ? AND gcp_connections.tenant_id = ?]
E               [parameters: ('aecaa0d329f941ccbe6dc5e4b1432dc3', '1829c25a4438491f9a2508de8be07830')]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:49,542 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:49,543 INFO sqlalchemy.engine.Engine SELECT gcp_connections.id, gcp_connections.tenant_id, gcp_connections.name, gcp_connections.project_id, gcp_connections.service_account_json, gcp_connections.auth_method, gcp_connections.billing_project_id, gcp_connections.billing_dataset, gcp_connections.billing_table, gcp_connections.is_active, gcp_connections.last_synced_at, gcp_connections.last_ingested_at, gcp_connections.error_message, gcp_connections.created_at, gcp_connections.updated_at 
FROM gcp_connections 
WHERE gcp_connections.id = ? AND gcp_connections.tenant_id = ?
2026-02-08 18:05:49,543 INFO sqlalchemy.engine.Engine [generated in 0.00029s] ('aecaa0d329f941ccbe6dc5e4b1432dc3', '1829c25a4438491f9a2508de8be07830')
2026-02-08 18:05:49,544 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/connections/gcp/aecaa0d3-29f9-41cc-be6d-c5e4b1432dc3", "method": "DELETE", "error_id": "27eb4c79-da97-4a5b-b76f-f[PHONE_REDACTED]c114d7", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: gcp_connections\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 446, in delete_gcp_connection\n    result = await db.execute(\n             ^^^^^^^^^^^^^^^^^\n    ...<4 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: gcp_connections\n[SQL: SELECT gcp_connections.id, gcp_connections.tenant_id, gcp_connections.name, gcp_connections.project_id, gcp_connections.service_account_json, gcp_connections.auth_method, gcp_connections.billing_project_id, gcp_connections.billing_dataset, gcp_connections.billing_table, gcp_connections.is_active, gcp_connections.last_synced_at, gcp_connections.last_ingested_at, gcp_connections.error_message, gcp_connections.created_at, gcp_connections.updated_at \nFROM gcp_connections \nWHERE gcp_connections.id = ? AND gcp_connections.tenant_id = ?]\n[parameters: ('aecaa0d329f941ccbe6dc5e4b1432dc3', '1829c25a[PHONE_REDACTED]f9a2508de8be[PHONE_REDACTED]')]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT gcp_connections.id, gcp_connections.tenant_id, gcp_connections.name, gcp_connections.project_id, gcp_connections.service_account_json, gcp_connections.auth_method, gcp_connections.billing_project_id, gcp_connections.billing_dataset, gcp_connections.billing_table, gcp_connections.is_active, gcp_connections.last_synced_at, gcp_connections.last_ingested_at, gcp_connections.error_message, gcp_connections.created_at, gcp_connections.updated_at 
FROM gcp_connections 
WHERE gcp_connections.id = ? AND gcp_connections.tenant_id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00029s] ('aecaa0d329f941ccbe6dc5e4b1432dc3', '1829c25a4438491f9a2508de8be07830')
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
_________________________ test_link_discovered_account _________________________

self = <sqlalchemy.engine.base.Connection object at 0x787608081f10>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x7876080822d0>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x787607354950>
parameters = [('c052b8fe860647e7be847ea9ae6ee3ab', 'bf648f70e7994d00ac0770585612bd0c')]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x7876043cece0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: discovered_accounts

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

ac = <httpx.AsyncClient object at 0x78761955fe90>
db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x787619592f20>
override_auth = None
auth_user = CurrentUser(id=UUID('e64e34a2-5547-4d19-aa02-908800cb657b'), email='test@valdrix.io', tenant_id=UUID('bf648f70-e799-4d00-ac07-70585612bd0c'), role=<UserRole.ADMIN: 'admin'>, tier=<PricingTier.FREE: 'free'>)

    @pytest.mark.asyncio
    async def test_link_discovered_account(ac, db, override_auth, auth_user):
        # 1. Create management connection
        mgmt = AWSConnection(
            tenant_id=auth_user.tenant_id,
            aws_account_id="111122223333",
            role_arn="arn:aws:iam::111122223333:role/Valdrix",
            external_id="vx-11112222333311112222333311112222",
            is_management_account=True,
            status="active"
        )
        db.add(mgmt)
        await db.commit()
    
        # 2. Create discovered account
        disc = DiscoveredAccount(
            management_connection_id=mgmt.id,
            account_id="444455556666",
            name="Member Account",
            status="discovered"
        )
        db.add(disc)
        await db.commit()
    
        # 3. Link it
>       resp = await ac.post(f"/api/v1/settings/connections/aws/discovered/{disc.id}/link")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/test_connections_api.py:341: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/connections.py:251: in link_discovered_account
    res = await db.execute(stmt)
          ^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x7876043cece0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: discovered_accounts
E               [SQL: SELECT discovered_accounts.id, discovered_accounts.management_connection_id, discovered_accounts.account_id, discovered_accounts.name, discovered_accounts.email, discovered_accounts.status, discovered_accounts.last_discovered_at, aws_connections.id AS id_1, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status AS status_1, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
E               FROM discovered_accounts JOIN aws_connections ON discovered_accounts.management_connection_id = aws_connections.id 
E               WHERE discovered_accounts.id = ? AND aws_connections.tenant_id = ?]
E               [parameters: ('c052b8fe860647e7be847ea9ae6ee3ab', 'bf648f70e7994d00ac0770585612bd0c')]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:51,132 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:51,139 INFO sqlalchemy.engine.Engine SELECT discovered_accounts.id, discovered_accounts.management_connection_id, discovered_accounts.account_id, discovered_accounts.name, discovered_accounts.email, discovered_accounts.status, discovered_accounts.last_discovered_at, aws_connections.id AS id_1, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status AS status_1, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
FROM discovered_accounts JOIN aws_connections ON discovered_accounts.management_connection_id = aws_connections.id 
WHERE discovered_accounts.id = ? AND aws_connections.tenant_id = ?
2026-02-08 18:05:51,139 INFO sqlalchemy.engine.Engine [generated in 0.00065s] ('c052b8fe860647e7be847ea9ae6ee3ab', 'bf648f70e7994d00ac0770585612bd0c')
2026-02-08 18:05:51,142 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/connections/aws/discovered/c052b8fe-[PHONE_REDACTED]e7-be84-7ea9ae6ee3ab/link", "method": "POST", "error_id": "[PHONE_REDACTED]-c2c4-41e5-b232-f8a9d127e80d", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: discovered_accounts\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 251, in link_discovered_account\n    res = await db.execute(stmt)\n          ^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: discovered_accounts\n[SQL: SELECT discovered_accounts.id, discovered_accounts.management_connection_id, discovered_accounts.account_id, discovered_accounts.name, discovered_accounts.email, discovered_accounts.status, discovered_accounts.last_discovered_at, aws_connections.id AS id_1, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status AS status_1, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at \nFROM discovered_accounts JOIN aws_connections ON discovered_accounts.management_connection_id = aws_connections.id \nWHERE discovered_accounts.id = ? AND aws_connections.tenant_id = ?]\n[parameters: ('c052b8fe[PHONE_REDACTED]e7be847ea9ae6ee3ab', 'bf648f70e7994d00ac[PHONE_REDACTED]bd0c')]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT discovered_accounts.id, discovered_accounts.management_connection_id, discovered_accounts.account_id, discovered_accounts.name, discovered_accounts.email, discovered_accounts.status, discovered_accounts.last_discovered_at, aws_connections.id AS id_1, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status AS status_1, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
FROM discovered_accounts JOIN aws_connections ON discovered_accounts.management_connection_id = aws_connections.id 
WHERE discovered_accounts.id = ? AND aws_connections.tenant_id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00065s] ('c052b8fe860647e7be847ea9ae6ee3ab', 'bf648f70e7994d00ac0770585612bd0c')
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
___________________ test_link_discovered_account_idempotent ____________________

self = <sqlalchemy.engine.base.Connection object at 0x78760732d6d0>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x78760732d790>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x787607354950>
parameters = [('c993cc2011a249cc977c5992ae0e981a', '5401f6f49ea64b11aa01d8959734fc02')]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787603dd9e40>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: discovered_accounts

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

ac = <httpx.AsyncClient object at 0x787608082f90>
db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7876087ff850>
override_auth = None
auth_user = CurrentUser(id=UUID('c71d61b4-e081-48b7-a893-0e4a2087ca44'), email='test@valdrix.io', tenant_id=UUID('5401f6f4-9ea6-4b11-aa01-d8959734fc02'), role=<UserRole.ADMIN: 'admin'>, tier=<PricingTier.FREE: 'free'>)

    @pytest.mark.asyncio
    async def test_link_discovered_account_idempotent(ac, db, override_auth, auth_user):
        # 1. Management connection
        mgmt = AWSConnection(
            tenant_id=auth_user.tenant_id,
            aws_account_id="888888888888",
            role_arn="arn",
            external_id="vx-unique-test-id-888",
            is_management_account=True,
            status="active"
        )
        db.add(mgmt)
        await db.commit()
        await db.refresh(mgmt)
    
        # 2. Discovered account
        disc = DiscoveredAccount(
            management_connection_id=mgmt.id,
            account_id="777777777777",
            name="Linked Member",
            status="linked"
        )
        db.add(disc)
        await db.commit()
        await db.refresh(disc)
    
        # 3. Existing connection
        conn = AWSConnection(
            tenant_id=auth_user.tenant_id,
            aws_account_id="777777777777",
            role_arn="arn",
            external_id=mgmt.external_id, # Sharing external ID
            status="active"
        )
        db.add(conn)
        await db.commit()
    
        # 4. Try to link again (should return existing)
>       resp = await ac.post(f"/api/v1/settings/connections/aws/discovered/{disc.id}/link")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/test_connections_api.py:390: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/connections.py:251: in link_discovered_account
    res = await db.execute(stmt)
          ^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787603dd9e40>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: discovered_accounts
E               [SQL: SELECT discovered_accounts.id, discovered_accounts.management_connection_id, discovered_accounts.account_id, discovered_accounts.name, discovered_accounts.email, discovered_accounts.status, discovered_accounts.last_discovered_at, aws_connections.id AS id_1, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status AS status_1, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
E               FROM discovered_accounts JOIN aws_connections ON discovered_accounts.management_connection_id = aws_connections.id 
E               WHERE discovered_accounts.id = ? AND aws_connections.tenant_id = ?]
E               [parameters: ('c993cc2011a249cc977c5992ae0e981a', '5401f6f49ea64b11aa01d8959734fc02')]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:52,651 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:52,652 INFO sqlalchemy.engine.Engine SELECT discovered_accounts.id, discovered_accounts.management_connection_id, discovered_accounts.account_id, discovered_accounts.name, discovered_accounts.email, discovered_accounts.status, discovered_accounts.last_discovered_at, aws_connections.id AS id_1, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status AS status_1, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
FROM discovered_accounts JOIN aws_connections ON discovered_accounts.management_connection_id = aws_connections.id 
WHERE discovered_accounts.id = ? AND aws_connections.tenant_id = ?
2026-02-08 18:05:52,652 INFO sqlalchemy.engine.Engine [cached since 1.513s ago] ('c993cc2011a249cc977c5992ae0e981a', '5401f6f49ea64b11aa01d8959734fc02')
2026-02-08 18:05:52,653 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/connections/aws/discovered/c993cc20-11a2-49cc-977c-5992ae0e981a/link", "method": "POST", "error_id": "babe100f-8fe5-44fa-b14e-178b473a8203", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: discovered_accounts\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 251, in link_discovered_account\n    res = await db.execute(stmt)\n          ^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: discovered_accounts\n[SQL: SELECT discovered_accounts.id, discovered_accounts.management_connection_id, discovered_accounts.account_id, discovered_accounts.name, discovered_accounts.email, discovered_accounts.status, discovered_accounts.last_discovered_at, aws_connections.id AS id_1, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status AS status_1, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at \nFROM discovered_accounts JOIN aws_connections ON discovered_accounts.management_connection_id = aws_connections.id \nWHERE discovered_accounts.id = ? AND aws_connections.tenant_id = ?]\n[parameters: ('c993cc2011a249cc977c5992ae0e981a', '5401f6f49ea64b11aa01d[PHONE_REDACTED]fc02')]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT discovered_accounts.id, discovered_accounts.management_connection_id, discovered_accounts.account_id, discovered_accounts.name, discovered_accounts.email, discovered_accounts.status, discovered_accounts.last_discovered_at, aws_connections.id AS id_1, aws_connections.tenant_id, aws_connections.aws_account_id, aws_connections.role_arn, aws_connections.external_id, aws_connections.region, aws_connections.status AS status_1, aws_connections.is_management_account, aws_connections.organization_id, aws_connections.last_verified_at, aws_connections.error_message, aws_connections.cur_status, aws_connections.cur_bucket_name, aws_connections.cur_report_name, aws_connections.last_ingested_at 
FROM discovered_accounts JOIN aws_connections ON discovered_accounts.management_connection_id = aws_connections.id 
WHERE discovered_accounts.id = ? AND aws_connections.tenant_id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 1.513s ago] ('c993cc2011a249cc977c5992ae0e981a', '5401f6f49ea64b11aa01d8959734fc02')
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
____________________ test_create_azure_connection_duplicate ____________________

self = <sqlalchemy.engine.base.Connection object at 0x78760367c1d0>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x78760367c350>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x7876199a9850>
parameters = [('98fdf1fa54b84dd89f6ff0d95fd4e94f',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787603fa4e20>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: tenants

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

ac = <httpx.AsyncClient object at 0x78760732e510>
db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x78760736aac0>
override_auth = None
auth_user = CurrentUser(id=UUID('a6b90af4-831a-4fa1-ae44-ce74e20b3f5a'), email='test@valdrix.io', tenant_id=UUID('98fdf1fa-54b8-4dd8-9f6f-f0d95fd4e94f'), role=<UserRole.ADMIN: 'admin'>, tier=<PricingTier.GROWTH: 'growth'>)

    @pytest.mark.asyncio
    async def test_create_azure_connection_duplicate(ac, db, override_auth, auth_user):
        # Setup Growth tier
        tenant = await db.get(Tenant, auth_user.tenant_id)
        tenant.plan = PricingTier.GROWTH.value
        await db.commit()
        auth_user.tier = PricingTier.GROWTH
    
        # Pre-create
        conn = AzureConnection(
            tenant_id=auth_user.tenant_id,
            name="Existing",
            azure_tenant_id="t-1",
            client_id="c-1",
            subscription_id="sub-duplicate"
        )
        db.add(conn)
        await db.commit()
    
        payload = {
            "name": "New",
            "azure_tenant_id": "t-2",
            "client_id": "c-2",
            "subscription_id": "sub-duplicate",
            "client_secret": "s"
        }
>       resp = await ac.post("/api/v1/settings/connections/azure", json=payload)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/test_connections_api.py:420: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/connections.py:302: in create_azure_connection
    await check_growth_tier(current_user, db)
app/modules/governance/api/v1/settings/connections.py:52: in check_growth_tier
    result = await db.execute(select(Tenant).where(Tenant.id == user.tenant_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787603fa4e20>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: tenants
E               [SQL: SELECT tenants.id, tenants.name, tenants.name_bidx, tenants."plan", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at 
E               FROM tenants 
E               WHERE tenants.id = ?]
E               [parameters: ('98fdf1fa54b84dd89f6ff0d95fd4e94f',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:54,077 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:54,077 INFO sqlalchemy.engine.Engine SELECT tenants.id, tenants.name, tenants.name_bidx, tenants."plan", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at 
FROM tenants 
WHERE tenants.id = ?
2026-02-08 18:05:54,077 INFO sqlalchemy.engine.Engine [cached since 56.31s ago] ('98fdf1fa54b84dd89f6ff0d95fd4e94f',)
2026-02-08 18:05:54,078 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/connections/azure", "method": "POST", "error_id": "8c422fb8-bea1-4c69-8c[PHONE_REDACTED]f41ae1c", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: tenants\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 302, in create_azure_connection\n    await check_growth_tier(current_user, db)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 52, in check_growth_tier\n    result = await db.execute(select(Tenant).where(Tenant.id == user.tenant_id))\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: tenants\n[SQL: SELECT tenants.id, tenants.name, tenants.name_bidx, tenants.\"plan\", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at \nFROM tenants \nWHERE tenants.id = ?]\n[parameters: ('98fdf1fa54b84dd89f6ff0d95fd4e94f',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT tenants.id, tenants.name, tenants.name_bidx, tenants."plan", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at 
FROM tenants 
WHERE tenants.id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 56.31s ago] ('98fdf1fa54b84dd89f6ff0d95fd4e94f',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
_____________________ test_create_gcp_connection_duplicate _____________________

self = <sqlalchemy.engine.base.Connection object at 0x78760367e990>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x78760367e510>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x7876199a9850>
parameters = [('981f2b97cbdc4555a84dc387c52d3f69',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787603ac07c0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: tenants

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

ac = <httpx.AsyncClient object at 0x78760732f950>
db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7876073018d0>
override_auth = None
auth_user = CurrentUser(id=UUID('97075ec8-e62e-4c8f-96b6-5a4462285b7f'), email='test@valdrix.io', tenant_id=UUID('981f2b97-cbdc-4555-a84d-c387c52d3f69'), role=<UserRole.ADMIN: 'admin'>, tier=<PricingTier.GROWTH: 'growth'>)

    @pytest.mark.asyncio
    async def test_create_gcp_connection_duplicate(ac, db, override_auth, auth_user):
        # Setup Growth tier
        tenant = await db.get(Tenant, auth_user.tenant_id)
        tenant.plan = PricingTier.GROWTH.value
        await db.commit()
        auth_user.tier = PricingTier.GROWTH
    
        # Pre-create
        conn = GCPConnection(
            tenant_id=auth_user.tenant_id,
            name="Existing",
            project_id="proj-duplicate"
        )
        db.add(conn)
        await db.commit()
    
        payload = {
            "name": "New",
            "project_id": "proj-duplicate",
            "service_account_json": "{}",
            "auth_method": "secret"
        }
>       resp = await ac.post("/api/v1/settings/connections/gcp", json=payload)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/test_connections_api.py:446: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1859: in post
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:369: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/settings/connections.py:386: in create_gcp_connection
    await check_growth_tier(current_user, db)
app/modules/governance/api/v1/settings/connections.py:52: in check_growth_tier
    result = await db.execute(select(Tenant).where(Tenant.id == user.tenant_id))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787603ac07c0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: tenants
E               [SQL: SELECT tenants.id, tenants.name, tenants.name_bidx, tenants."plan", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at 
E               FROM tenants 
E               WHERE tenants.id = ?]
E               [parameters: ('981f2b97cbdc4555a84dc387c52d3f69',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:55,446 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:55,448 INFO sqlalchemy.engine.Engine SELECT tenants.id, tenants.name, tenants.name_bidx, tenants."plan", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at 
FROM tenants 
WHERE tenants.id = ?
2026-02-08 18:05:55,448 INFO sqlalchemy.engine.Engine [cached since 57.68s ago] ('981f2b97cbdc4555a84dc387c52d3f69',)
2026-02-08 18:05:55,449 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/settings/connections/gcp", "method": "POST", "error_id": "ac[PHONE_REDACTED]a-41f0-9ce[PHONE_REDACTED]e5eb", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: tenants\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 369, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 386, in create_gcp_connection\n    await check_growth_tier(current_user, db)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/settings/connections.py\", line 52, in check_growth_tier\n    result = await db.execute(select(Tenant).where(Tenant.id == user.tenant_id))\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: tenants\n[SQL: SELECT tenants.id, tenants.name, tenants.name_bidx, tenants.\"plan\", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at \nFROM tenants \nWHERE tenants.id = ?]\n[parameters: ('981f2b97cbdc4555a84dc387c52d3f69',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT tenants.id, tenants.name, tenants.name_bidx, tenants."plan", tenants.stripe_customer_id, tenants.trial_started_at, tenants.last_accessed_at 
FROM tenants 
WHERE tenants.id = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 57.68s ago] ('981f2b97cbdc4555a84dc387c52d3f69',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
____________________________ test_get_queue_status _____________________________

self = <sqlalchemy.engine.base.Connection object at 0x78760367e8d0>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x7876194b3360>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x78760367ec90>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x787603620c50>
parameters = [('dc526c60d4f643ba98d7a9b145c1cdf6',)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787603a289a0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such table: background_jobs

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError

The above exception was the direct cause of the following exception:

async_client = <httpx.AsyncClient object at 0x78760367e690>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x78760736b690>
mock_user = <MagicMock id='132448478246432'>

    @pytest.mark.asyncio
    async def test_get_queue_status(async_client: AsyncClient, db_session, mock_user):
        """Test GET /api/v1/jobs/status."""
        now = datetime.now(timezone.utc)
        job1 = BackgroundJob(
            id=uuid.uuid4(),
            tenant_id=mock_user.tenant_id,
            job_type=JobType.ZOMBIE_SCAN.value,
            status=JobStatus.PENDING.value,
            scheduled_for=now,
            created_at=now
        )
        db_session.add(job1)
        await db_session.commit()
    
>       response = await async_client.get("/api/v1/jobs/status")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/governance/test_jobs_api.py:39: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/httpx/_client.py:1768: in get
    return await self.request(
.venv/lib/python3.13/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.13/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.13/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/main.py:380: in csrf_protect_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:81: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/middleware.py:12: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
.venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/shared/core/timeout.py:36: in dispatch
    return await asyncio.wait_for(
../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py:507: in wait_for
    return await fut
           ^^^^^^^^^
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:177: in __call__
    raise exc
.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py:175: in __call__
    await self.app(scope, receive, send_wrapper)
.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.13/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.13/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.13/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/governance/api/v1/jobs.py:78: in get_job_queue_status
    result = await db.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:182: in execute
    self._adapt_connection._handle_exception(error)
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:342: in _handle_exception
    raise error
.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:164: in execute
    self.await_(_cursor.execute(operation, parameters))
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
.venv/lib/python3.13/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/aiosqlite/core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x787603a289a0>

    def _connection_worker_thread(tx: _TxQueue):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            future, function = tx.get()
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: background_jobs
E               [SQL: SELECT background_jobs.status, count(background_jobs.id) AS count_1 
E               FROM background_jobs 
E               WHERE background_jobs.tenant_id = ? AND background_jobs.is_deleted = 0 GROUP BY background_jobs.status]
E               [parameters: ('dc526c60d4f643ba98d7a9b145c1cdf6',)]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

.venv/lib/python3.13/site-packages/aiosqlite/core.py:63: OperationalError
----------------------------- Captured stdout call -----------------------------
2026-02-08 18:05:56,842 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-02-08 18:05:56,844 INFO sqlalchemy.engine.Engine SELECT background_jobs.status, count(background_jobs.id) AS count_1 
FROM background_jobs 
WHERE background_jobs.tenant_id = ? AND background_jobs.is_deleted = 0 GROUP BY background_jobs.status
2026-02-08 18:05:56,844 INFO sqlalchemy.engine.Engine [generated in 0.00025s] ('dc526c60d4f643ba98d7a9b145c1cdf6',)
2026-02-08 18:05:56,844 INFO sqlalchemy.engine.Engine ROLLBACK
{"path": "/api/v1/jobs/status", "method": "GET", "error_id": "fe3ff[PHONE_REDACTED]a-46b7-84cc-84e[PHONE_REDACTED]f72f", "event": "unhandled_exception", "level": "error", "timestamp": "[PHONE_REDACTED]T17:05:[PHONE_REDACTED]Z", "exception": "Traceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlite3.OperationalError: no such table: background_jobs\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/main.py\", line 380, in csrf_protect_middleware\n    return await call_next(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 81, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/middleware.py\", line 12, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n                                   ~~~~~~~~~~~~~~~~~~^^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/core/timeout.py\", line 36, in dispatch\n    return await asyncio.wait_for(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"/home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/asyncio/tasks.py\", line 507, in wait_for\n    return await fut\n           ^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 177, in __call__\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/prometheus_fastapi_instrumentator/middleware.py\", line 175, in __call__\n    await self.app(scope, receive, send_wrapper)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/api/v1/jobs.py\", line 78, in get_job_queue_status\n    result = await db.execute(\n             ^^^^^^^^^^^^^^^^^\n    ...<7 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py\", line 449, in execute\n    result = await greenlet_spawn(\n             ^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 201, in greenlet_spawn\n    result = context.throw(*sys.exc_info())\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py\", line 2249, in _execute_internal\n    result: Result[Any] = compile_state_cls.orm_execute_statement(\n                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self,\n        ^^^^^\n    ...<4 lines>...\n        conn,\n        ^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py\", line 306, in orm_execute_statement\n    result = conn.execute(\n        statement, params or {}, execution_options=execution_options\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py\", line 527, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 2363, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py\", line 952, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 182, in execute\n    self._adapt_connection._handle_exception(error)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 342, in _handle_exception\n    raise error\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py\", line 164, in execute\n    self.await_(_cursor.execute(operation, parameters))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 132, in await_only\n    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501\n           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py\", line 196, in greenlet_spawn\n    value = await result\n            ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 40, in execute\n    await self._execute(self._cursor.execute, sql, parameters)\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/cursor.py\", line 32, in _execute\n    return await self._conn._execute(fn, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 160, in _execute\n    return await future\n           ^^^^^^^^^^^^\n  File \"/home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/aiosqlite/core.py\", line 63, in _connection_worker_thread\n    result = function()\nsqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: background_jobs\n[SQL: SELECT background_jobs.status, count(background_jobs.id) AS count_1 \nFROM background_jobs \nWHERE background_jobs.tenant_id = ? AND background_jobs.is_deleted = 0 GROUP BY background_jobs.status]\n[parameters: ('dc526c60d4f643ba98d7a9b145c1cdf6',)]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2710 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT background_jobs.status, count(background_jobs.id) AS count_1 
FROM background_jobs 
WHERE background_jobs.tenant_id = ? AND background_jobs.is_deleted = 0 GROUP BY background_jobs.status
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00025s] ('dc526c60d4f643ba98d7a9b145c1cdf6',)
INFO     sqlalchemy.engine.Engine:base.py:2713 ROLLBACK
______ TestCloudAccountRegistry.test_ingest_syncs_cloud_account_registry _______

self = <test_reporting_service.TestCloudAccountRegistry object at 0x78761b2ebed0>
mock_db = <AsyncMock spec='AsyncSession' id='132448311529488'>
mock_aws_connection = <MagicMock spec='AWSConnection' id='132448311532176'>

    @pytest.mark.asyncio
    async def test_ingest_syncs_cloud_account_registry(self, mock_db, mock_aws_connection):
        """Test that ingestion syncs CloudAccount registry."""
        tenant_id = mock_aws_connection.tenant_id
    
        query_result = MagicMock()
        query_result.scalars.return_value.all.side_effect = [[mock_aws_connection], [], []]
        mock_db.execute = AsyncMock(return_value=query_result)
        mock_db.commit = AsyncMock()
        mock_db.add = MagicMock()
    
        service = ReportingService(mock_db)
    
        with patch('app.modules.reporting.domain.service.AdapterFactory') as mock_factory, \
             patch('app.modules.reporting.domain.service.CostPersistenceService') as mock_persistence, \
             patch('app.modules.reporting.domain.service.AttributionEngine'):
    
            mock_adapter = AsyncMock()
            mock_factory.get_adapter.return_value = mock_adapter
    
            async def mock_stream():
                yield {"cost_usd": "50.0"}
    
            mock_adapter.stream_cost_and_usage = MagicMock(side_effect=lambda *args, **kwargs: mock_stream())
    
            mock_persistence_instance = AsyncMock()
            mock_persistence_instance.save_records_stream = AsyncMock(
                return_value={"records_saved": 1}
            )
            mock_persistence.return_value = mock_persistence_instance
    
            result = await service.ingest_costs_for_tenant(tenant_id)
    
            # Check that execute was called (for registry sync with upsert)
            assert mock_db.execute.called
            # Commit should be called for syncing
>           assert mock_db.commit.called
E           AssertionError: assert False
E            +  where False = <AsyncMock name='mock.commit' id='132448311535200'>.called
E            +    where <AsyncMock name='mock.commit' id='132448311535200'> = <AsyncMock spec='AsyncSession' id='132448311529488'>.commit

tests/unit/modules/reporting/test_reporting_service.py:315: AssertionError
----------------------------- Captured stdout call -----------------------------
{"tenant_id": "6ef6f494-a31d-4e7e-a33c-3d1c4f17d77e", "error": "object MagicMock can't be used in 'await' expression", "event": "attribution_trigger_failed", "level": "error", "timestamp": "[PHONE_REDACTED]T17:06:[PHONE_REDACTED]Z"}
______________________________ test_cleanup_loops ______________________________

persistence_service = <app.modules.reporting.domain.persistence.CostPersistenceService object at 0x78760ba00890>
mock_db = <AsyncMock id='132448348762000'>

    @pytest.mark.asyncio
    async def test_cleanup_loops(persistence_service, mock_db):
        # Test the loop in cleanup_old_records
        mock_res_ids = MagicMock()
        mock_res_ids.scalars.return_value.all.side_effect = [[uuid4()], []]
    
        mock_db.execute.return_value = mock_res_ids
    
        await persistence_service.cleanup_old_records(days_retention=30)
>       assert mock_db.commit.called
E       AssertionError: assert False
E        +  where False = <AsyncMock name='mock.commit' id='132448348756624'>.called
E        +    where <AsyncMock name='mock.commit' id='132448348756624'> = <AsyncMock id='132448348762000'>.commit

tests/unit/reporting/test_reporting_persistence_deep.py:227: AssertionError
----------------------------- Captured stdout call -----------------------------
[2m[PHONE_REDACTED]T17:06:[PHONE_REDACTED]Z[0m [[32m[1minfo     [0m] [1mcost_retention_cleanup_complete[0m [36mcutoff_date[0m=[35m'[PHONE_REDACTED] 00:00:00+00:00'[0m [36mtotal_deleted[0m=[35m1[0m
_________________________ test_finalize_batch_success __________________________

persistence_service = <app.modules.reporting.domain.persistence.CostPersistenceService object at 0x78760ba03d10>
mock_db = <AsyncMock id='132448626041120'>

    @pytest.mark.asyncio
    async def test_finalize_batch_success(persistence_service, mock_db):
        mock_res = MagicMock()
        mock_res.rowcount = 10
        mock_db.execute.return_value = mock_res
    
        result = await persistence_service.finalize_batch(days_ago=2)
        assert result["records_finalized"] == 10
>       assert mock_db.commit.called
E       AssertionError: assert False
E        +  where False = <AsyncMock name='mock.commit' id='132448348756960'>.called
E        +    where <AsyncMock name='mock.commit' id='132448348756960'> = <AsyncMock id='132448626041120'>.commit

tests/unit/reporting/test_reporting_persistence_deep.py:237: AssertionError
----------------------------- Captured stdout call -----------------------------
[2m[PHONE_REDACTED]T17:06:[PHONE_REDACTED]Z[0m [[32m[1minfo     [0m] [1mcost_batch_finalization_complete[0m [36mcutoff_date[0m=[35m[PHONE_REDACTED][0m [36mrecords_finalized[0m=[35m10[0m
_________________________ test_parse_cur_files_success _________________________

cur_adapter = <app.shared.adapters.cur_adapter.CURAdapter object at 0x787610706b50>

    @pytest.mark.asyncio
    async def test_parse_cur_files_success(cur_adapter):
        """Test _parse_cur_files reads and aggregates data."""
        files = ["f1.parquet"]
        start = date(2026, 1, 1)
        end = date(2026, 1, 31)
    
        # Mock row data
        df_data = pd.DataFrame({
            "line_item_usage_start_date": ["2026-01-01", "2026-01-01", "2026-01-02"],
            "line_item_product_code": ["S3", "EC2", "S3"],
            "line_item_blended_cost": [1.0, 2.0, 3.0]
        })
    
        with patch.object(cur_adapter.session, "client") as mock_client:
            mock_s3 = AsyncMock()
            mock_client.return_value.__aenter__.return_value = mock_s3
    
            mock_body = AsyncMock()
            mock_body.read.return_value = b"fake-parquet-content"
            mock_s3.get_object.return_value = {"Body": mock_body}
            mock_body.__aenter__.return_value = mock_body
    
            with patch("pandas.read_parquet", return_value=df_data):
                # 1. Without group_by
                results = await cur_adapter._parse_cur_files(files, start, end, group_by_service=False)
>               assert len(results) == 2  # 2 days
                ^^^^^^^^^^^^^^^^^^^^^^^^
E               assert 0 == 2
E                +  where 0 = len([])

tests/unit/services/adapters/test_cur_adapter.py:118: AssertionError
=============================== warnings summary ===============================
tests/analysis/test_zombie_coverage.py::test_scan_provider_error_handling
tests/integration/test_edge_cases.py::TestZombieServiceEdgeCases::test_scan_for_tenant_connection_failure
tests/integration/test_edge_cases.py::TestZombieServiceEdgeCases::test_scan_with_ai_analysis_enabled
  /home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/optimization/domain/service.py:155: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    logger.error("scan_provider_failed", error=str(e), provider=type(conn).__name__)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/analysis/test_zombie_orchestration.py::test_remediation_service_create_request
  /home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/optimization/domain/remediation.py:113: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    self.db.add(request)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/security/test_encryption.py::test_encryption_with_different_keys
tests/security/test_key_rotation.py::test_key_rotation_compatibility
tests/unit/core/test_security_audit.py::test_context_specific_encryption
tests/unit/core/test_security_audit.py::test_decrypt_invalid_input
  /home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/structlog/_base.py:173: UserWarning: Remove `format_exc_info` from your processor chain if you want pretty exceptions.
    event_dict = proc(self._logger, method_name, event_dict)

tests/unit/api/v1/test_billing.py::test_update_exchange_rate
  /home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/reporting/api/v1/billing.py:333: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    db.add(ExchangeRate(
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/core/test_pricing_deep.py::TestPricingDeep::test_get_tenant_tier_empty
  /home/daretechie/DevProject/GitHub/CloudSentinel-AI/tests/unit/core/test_pricing_deep.py:168: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    tier = await get_tenant_tier(uuid.uuid4(), mock_db)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/governance/jobs/test_costs.py::test_cost_ingestion_with_connection
  /home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/domain/jobs/handlers/costs.py:108: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    db.add(conn)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/llm/test_analyzer_exhaustive.py::test_analyze_force_refresh
tests/unit/llm/test_analyzer_exhaustive.py::test_analyze_with_delta_analysis_enabled
tests/unit/llm/test_budget_manager.py::test_record_usage
tests/unit/llm/test_budget_manager_exhaustive.py::test_record_usage
  /home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/llm/budget_manager.py:232: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    db.add(usage)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/modules/optimization/test_remediation_coverage.py::test_execute_remediation_error_handling
tests/unit/modules/optimization/test_remediation_coverage.py::test_remediation_with_backup_and_verify
  /home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/governance/domain/security/audit_log.py:215: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    self.db.add(entry)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/modules/reporting/test_attribution_engine_deep.py::TestAttributionEngine::test_process_cost_record_flow
  /home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/reporting/domain/attribution_engine.py:211: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    self.db.add(allocation)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/modules/reporting/test_paystack_billing_coverage.py::test_webhook_handle_charge_success
  /home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/reporting/domain/billing/paystack_billing.py:554: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    self.db.add(sub)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/reporting/test_reporting_persistence_deep.py::test_save_summary_sqlite_path
  /home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/reporting/domain/persistence.py:172: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    self.db.add(CostRecord(**val))
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/reporting/test_reporting_persistence_deep.py::test_check_for_significant_adjustments_with_audit_log
tests/unit/reporting/test_reporting_persistence_deep.py::test_check_for_significant_adjustments_significant
  /home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/modules/reporting/domain/persistence.py:255: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    self.db.add_all(audit_logs)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/services/scheduler/test_processors_expanded.py::TestAnalysisProcessorExpanded::test_process_tenant_exception
  /home/daretechie/.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/unittest/mock.py:2247: RuntimeWarning: coroutine 'AnalysisProcessor.process_tenant.<locals>._run_analysis' was never awaited
    def __init__(self, name, parent):
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.13.5-final-0 ________________

Name                                                                         Stmts   Miss Branch BrPart  Cover   Missing
------------------------------------------------------------------------------------------------------------------------
app/__init__.py                                                                  0      0      0      0   100%
app/main.py                                                                    196     22     18      4    85%   105, 113-114, 118, 169-175, 217, 257-267, 371-378
app/models/anomaly_marker.py                                                    20      1      0      0    95%   57
app/models/attribution.py                                                       33      0      0      0   100%
app/models/aws_connection.py                                                    39      0      0      0   100%
app/models/azure_connection.py                                                  32      1      0      0    97%   68
app/models/background_job.py                                                    55      4      0      0    93%   95, 104-106
app/models/carbon_settings.py                                                   20      0      0      0   100%
app/models/cloud.py                                                             40      0      0      0   100%
app/models/cost_audit.py                                                        19      0      0      0   100%
app/models/discovered_account.py                                                18      1      0      0    94%   43
app/models/gcp_connection.py                                                    33      1      0      0    97%   72
app/models/llm.py                                                               66      8      0      0    88%   97, 156, 160, 164, 168, 172, 176, 185
app/models/notification_settings.py                                             22      1      0      0    95%   61
app/models/optimization.py                                                      48      0      0      0   100%
app/models/pricing.py                                                           25      0      0      0   100%
app/models/remediation.py                                                       66      1      0      0    98%   145
app/models/remediation_settings.py                                              18      1      0      0    94%   51
app/models/security.py                                                          16      0      0      0   100%
app/models/tenant.py                                                            49      1      2      1    96%   26
app/modules/audit/__init__.py                                                    2      0      0      0   100%
app/modules/billing/__init__.py                                                  3      0      0      0   100%
app/modules/governance/__init__.py                                               3      0      0      0   100%
app/modules/governance/api/__init__.py                                           0      0      0      0   100%
app/modules/governance/api/oidc.py                                               9      0      0      0   100%
app/modules/governance/api/v1/__init__.py                                        0      0      0      0   100%
app/modules/governance/api/v1/admin.py                                          38      0      6      0   100%
app/modules/governance/api/v1/audit.py                                         141      1     14      4    97%   61->64, 164->166, 166->168, 168->172, 389
app/modules/governance/api/v1/health_dashboard.py                              102      2      2      1    97%   224-235
app/modules/governance/api/v1/jobs.py                                          109     28     12      2    70%   88-90, 149-157, 187, 192-194, 220-281
app/modules/governance/api/v1/public.py                                         30      4      2      1    84%   24-25, 51-53
app/modules/governance/api/v1/settings/__init__.py                              12      0      0      0   100%
app/modules/governance/api/v1/settings/activeops.py                             43     19      6      0    49%   57-72, 89-118
app/modules/governance/api/v1/settings/carbon.py                                49     19      6      0    55%   65-84, 103-134
app/modules/governance/api/v1/settings/connections.py                          174     78     24      1    50%   56, 123-144, 153, 179-185, 201-206, 216-232, 252-288, 304-328, 342, 360-372, 388-414, 427-428, 437, 452-458
app/modules/governance/api/v1/settings/llm.py                                   69     24     12      0    58%   76-97, 124-167
app/modules/governance/api/v1/settings/notifications.py                         74     31     10      1    52%   71-94, 113-147, 166, 177-197
app/modules/governance/api/v1/settings/onboard.py                               65     25     16      1    56%   55-101
app/modules/governance/api/v1/settings/safety.py                                47      6      0      0    87%   77-80, 123-126
app/modules/governance/domain/__init__.py                                        0      0      0      0   100%
app/modules/governance/domain/jobs/handlers/__init__.py                         16      0      2      0   100%
app/modules/governance/domain/jobs/handlers/base.py                             81      2      2      0    98%   77, 228
app/modules/governance/domain/jobs/handlers/billing.py                          28      0      8      0   100%
app/modules/governance/domain/jobs/handlers/costs.py                           116     17     18      2    84%   74-75, 117-122, 124->71, 240-265
app/modules/governance/domain/jobs/handlers/dunning.py                          16      0      2      0   100%
app/modules/governance/domain/jobs/handlers/finops.py                           29      2      4      2    88%   24, 33
app/modules/governance/domain/jobs/handlers/notifications.py                    35      1      8      1    95%   52
app/modules/governance/domain/jobs/handlers/remediation.py                      33      1      8      1    95%   44
app/modules/governance/domain/jobs/handlers/zombie.py                           35      0     20      4    93%   28->30, 30->33, 44->48, 55->54
app/modules/governance/domain/jobs/processor.py                                113     26      8      0    77%   85-92, 100-105, 189-204, 207-210
app/modules/governance/domain/scheduler/__init__.py                              3      0      0      0   100%
app/modules/governance/domain/scheduler/cohorts.py                              17      0      8      0   100%
app/modules/governance/domain/scheduler/metrics.py                               5      0      0      0   100%
app/modules/governance/domain/scheduler/orchestrator.py                         92      6      4      1    93%   43-44, 72-73, 81-82, 105->exit
app/modules/governance/domain/scheduler/processors.py                          118     20     38      3    81%   57, 78-92, 117-123, 127-128, 157->164, 161-162
app/modules/governance/domain/security/__init__.py                               0      0      0      0   100%
app/modules/governance/domain/security/audit_log.py                             85      0     10      0   100%
app/modules/governance/domain/security/iam_auditor.py                           72     16     32      9    72%   40, 44, 74-79, 89-91, 100, 104, 107->110, 111->115, 127->102, 135-137
app/modules/health_dashboard/__init__.py                                         2      0      0      0   100%
app/modules/notifications/__init__.py                                            2      0      0      0   100%
app/modules/notifications/domain/__init__.py                                     3      0      0      0   100%
app/modules/notifications/domain/email_service.py                              102     10      4      1    90%   21, 222-224, 278-280, 339-341
app/modules/notifications/domain/slack.py                                       75      4     18      2    94%   69-72, 89->94
app/modules/optimization/__init__.py                                             4      0      0      0   100%
app/modules/optimization/adapters/__init__.py                                    0      0      0      0   100%
app/modules/optimization/adapters/aws/__init__.py                                1      0      0      0   100%
app/modules/optimization/adapters/aws/detector.py                               41      0      6      0   100%
app/modules/optimization/adapters/aws/plugins/__init__.py                        9      0      0      0   100%
app/modules/optimization/adapters/aws/plugins/analytics.py                      41      4      8      1    90%   47->34, 61-64
app/modules/optimization/adapters/aws/plugins/compute.py                       112     22     48      5    74%   75->73, 77-79, 93-116, 137, 208->199, 235-236
app/modules/optimization/adapters/aws/plugins/containers.py                     36     21     12      0    31%   19-52
app/modules/optimization/adapters/aws/plugins/database.py                       84      9     26      4    88%   74->72, 76->72, 99-100, 117-119, 139->126, 153-156
app/modules/optimization/adapters/aws/plugins/high_value.py                    111     16     30      6    84%   74->54, 87-91, 121-123, 154->131, 174-178, 216, 225->209, 230->209, 249-253
app/modules/optimization/adapters/aws/plugins/infrastructure.py                125     11     28      3    91%   76-77, 87->51, 123-124, 181-195, 263-280
app/modules/optimization/adapters/aws/plugins/network.py                        81     50     24      2    33%   18-71, 86-88, 96-132
app/modules/optimization/adapters/aws/plugins/storage.py                        87     28     18      2    68%   63-66, 97-98, 120-144, 155-182
app/modules/optimization/adapters/aws/region_discovery.py                       63     31     12      2    48%   43, 54-56, 73-75, 84-132, 136, 147-148
app/modules/optimization/adapters/azure/__init__.py                              1      0      0      0   100%
app/modules/optimization/adapters/azure/detector.py                             62     24     28      5    50%   36->46, 56, 62-87, 94, 96, 98, 99->exit
app/modules/optimization/adapters/azure/plugins/__init__.py                     10      0      0      0   100%
app/modules/optimization/adapters/azure/plugins/compute.py                      43     27     10      0    30%   22, 31-70, 79, 83-92
app/modules/optimization/adapters/azure/plugins/containers.py                   55     40     16      0    21%   21, 25-63, 72, 76-117
app/modules/optimization/adapters/azure/plugins/database.py                     27     17      8      0    29%   21, 25-58
app/modules/optimization/adapters/azure/plugins/idle_vms.py                     75     18     28      5    70%   25, 40, 61-67, 73, 109-111, 126->124, 129-132, 143-144
app/modules/optimization/adapters/azure/plugins/network.py                      58     37     14      0    29%   22, 26-60, 69, 73-95, 104, 108-132
app/modules/optimization/adapters/azure/plugins/orphaned_images.py              30      5      8      1    84%   19, 32, 58-60
app/modules/optimization/adapters/azure/plugins/orphaned_ips.py                 25      2      6      1    90%   18, 30
app/modules/optimization/adapters/azure/plugins/storage.py                      51     34     10      0    28%   23, 27-64, 73, 77-109
app/modules/optimization/adapters/azure/plugins/unattached_disks.py             50      7     20      3    86%   20, 47->46, 48->47, 51-52, 75-77, 87
app/modules/optimization/adapters/gcp/__init__.py                                1      0      0      0   100%
app/modules/optimization/adapters/gcp/detector.py                               69     36     32      2    39%   36->45, 39-43, 56, 62-98
app/modules/optimization/adapters/gcp/plugins/__init__.py                       11      0      0      0   100%
app/modules/optimization/adapters/gcp/plugins/compute.py                        47      6     14      2    87%   22, 47, 51, 70-71, 82
app/modules/optimization/adapters/gcp/plugins/containers.py                     54     34     10      0    31%   21, 25-63, 72, 76-84, 93, 97-105
app/modules/optimization/adapters/gcp/plugins/database.py                       28     18      6      0    29%   21, 25-58
app/modules/optimization/adapters/gcp/plugins/idle_instances.py                 87     32     36      6    59%   20, 38->37, 43-45, 65-97, 101, 158->157, 161-164, 168-178
app/modules/optimization/adapters/gcp/plugins/machine_images.py                 26      4      4      0    87%   19, 52-54
app/modules/optimization/adapters/gcp/plugins/network.py                        32     21     10      0    26%   22, 26-64
app/modules/optimization/adapters/gcp/plugins/storage.py                        56     39     14      0    24%   23, 27-68, 77, 81-113
app/modules/optimization/adapters/gcp/plugins/unattached_disks.py               40     11     10      2    70%   18, 40-44, 66-68, 77-80
app/modules/optimization/adapters/gcp/plugins/unused_ips.py                     26      4      4      0    87%   18, 60-62
app/modules/optimization/api/__init__.py                                         0      0      0      0   100%
app/modules/optimization/api/v1/__init__.py                                      0      0      0      0   100%
app/modules/optimization/api/v1/strategies.py                                   46     17      2      0    60%   42-48, 59-62, 79-96
app/modules/optimization/api/v1/zombies.py                                      92     31      6      1    63%   55-65, 86-88, 108, 122, 149-152, 173-186, 189-191, 208-224
app/modules/optimization/domain/__init__.py                                      7      0      0      0   100%
app/modules/optimization/domain/aws_provider/__init__.py                         2      0      0      0   100%
app/modules/optimization/domain/aws_provider/detector.py                         2      0      0      0   100%
app/modules/optimization/domain/aws_provider/plugins/__init__.py                 9      0      0      0   100%
app/modules/optimization/domain/aws_provider/plugins/compute.py                  2      0      0      0   100%
app/modules/optimization/domain/azure_provider/__init__.py                       0      0      0      0   100%
app/modules/optimization/domain/azure_provider/detector.py                       2      0      0      0   100%
app/modules/optimization/domain/azure_provider/plugins/__init__.py               5      0      0      0   100%
app/modules/optimization/domain/azure_provider/plugins/orphaned_images.py        2      0      0      0   100%
app/modules/optimization/domain/azure_provider/plugins/orphaned_ips.py           2      0      0      0   100%
app/modules/optimization/domain/azure_provider/plugins/unattached_disks.py       2      0      0      0   100%
app/modules/optimization/domain/base.py                                          2      0      0      0   100%
app/modules/optimization/domain/detector.py                                      2      0      0      0   100%
app/modules/optimization/domain/factory.py                                      17      0      6      0   100%
app/modules/optimization/domain/gcp_provider/__init__.py                         0      0      0      0   100%
app/modules/optimization/domain/gcp_provider/detector.py                         2      0      0      0   100%
app/modules/optimization/domain/gcp_provider/plugins/__init__.py                 6      0      0      0   100%
app/modules/optimization/domain/gcp_provider/plugins/machine_images.py           2      0      0      0   100%
app/modules/optimization/domain/gcp_provider/plugins/unattached_disks.py         2      0      0      0   100%
app/modules/optimization/domain/gcp_provider/plugins/unused_ips.py               2      0      0      0   100%
app/modules/optimization/domain/plugin.py                                       23      2      6      0    93%   37, 47
app/modules/optimization/domain/ports.py                                        79     14     18      3    82%   62, 82, 96-101, 125-131, 146-147, 150, 161
app/modules/optimization/domain/registry.py                                     15      0      0      0   100%
app/modules/optimization/domain/remediation.py                                 293     37     72      4    88%   62->65, 338->345, 475-477, 499-501, 523-525, 618, 645-646, 709-731, 737-739
app/modules/optimization/domain/remediation_service.py                           2      0      0      0   100%
app/modules/optimization/domain/service.py                                     158     41     28      1    74%   127-128, 138->136, 204-215, 266-267, 275, 281-330, 336-359
app/modules/optimization/domain/strategies/base.py                              17      2      0      0    88%   30, 44
app/modules/optimization/domain/strategies/compute_savings.py                   22      0      4      0   100%
app/modules/optimization/domain/unified_discovery.py                            18      0      2      0   100%
app/modules/optimization/domain/zombie_plugin.py                                 2      0      0      0   100%
app/modules/reporting/__init__.py                                                5      0      0      0   100%
app/modules/reporting/api/__init__.py                                            0      0      0      0   100%
app/modules/reporting/api/v1/__init__.py                                         0      0      0      0   100%
app/modules/reporting/api/v1/billing.py                                        191     17     32      4    91%   81->79, 130, 169, 178-179, 202, 226-230, 283, 299-300, 303-305, 390
app/modules/reporting/api/v1/carbon.py                                          78      8     12      4    87%   44, 78, 94, 111, 149-156
app/modules/reporting/api/v1/costs.py                                           43     19      4      0    51%   40, 53-66, 87-111, 121-130
app/modules/reporting/api/v1/currency.py                                        21     10      2      0    48%   18-25, 36-41
app/modules/reporting/api/v1/leaderboards.py                                    43     19      6      0    49%   57-113
app/modules/reporting/api/v1/usage.py                                           89      0      0      0   100%
app/modules/reporting/domain/__init__.py                                         3      0      0      0   100%
app/modules/reporting/domain/aggregator.py                                     149     13     32      6    90%   86-87, 89-90, 130, 139, 389-390, 435-436, 444-446
app/modules/reporting/domain/attribution_engine.py                             126     10     62     10    88%   60-61, 97, 114, 136, 142->180, 167->180, 244-245, 296, 298, 300
app/modules/reporting/domain/billing/__init__.py                                 6      2      0      0    67%   11-13
app/modules/reporting/domain/billing/currency.py                                61      8     10      1    87%   47-48, 56-57, 77, 105-107
app/modules/reporting/domain/billing/dunning_service.py                        116     49     14      2    56%   71-72, 136, 148-154, 207-242, 246-272, 276-302
app/modules/reporting/domain/billing/paystack_billing.py                       301     64     74     27    75%   138, 144-150, 154, 158, 162-163, 203-204, 227, 270->275, 282-284, 298-299, 313, 329-330, 353-356, 360-381, 411->414, 419-420, 423-424, 446-447, 458-463, 466->468, 468->470, 470->478, 475-476, 491-495, 507->514, 510-511, 515-529, 532-533, 541->exit, 551->556, 561->565, 574->exit, 581->exit, 601->exit, 609->exit
app/modules/reporting/domain/billing/webhook_retry.py                           64      0     16      0   100%
app/modules/reporting/domain/budget_alerts.py                                  109     10     44     12    86%   129->134, 180->230, 194, 196, 199, 201->230, 226-227, 235->272, 243, 245, 247->272, 266-269, 272->275
app/modules/reporting/domain/calculator.py                                      80      4     26      1    95%   130-132, 161
app/modules/reporting/domain/carbon_scheduler.py                               127      7     42      1    94%   74-85, 269->272
app/modules/reporting/domain/graviton_analyzer.py                               51      8     18      4    80%   106, 146->135, 151->156, 152->151, 189-191, 204-209
app/modules/reporting/domain/persistence.py                                    119      5     40      6    93%   119-121, 123->127, 137, 167->169, 188, 225->216
app/modules/reporting/domain/pricing/service.py                                 31      7      6      1    78%   34->38, 58-79
app/modules/reporting/domain/reconciliation.py                                  18      7      0      0    61%   19, 32-70
app/modules/reporting/domain/service.py                                         61      0     10      0   100%
app/modules/usage/__init__.py                                                    2      0      0      0   100%
app/schemas/connections.py                                                      77      0      0      0   100%
app/schemas/costs.py                                                            33      0      0      0   100%
app/schemas/inventory.py                                                        18      0      0      0   100%
app/shared/__init__.py                                                           0      0      0      0   100%
app/shared/adapters/aws.py                                                       2      0      0      0   100%
app/shared/adapters/aws_cur.py                                                 150     53     32      5    58%   37, 62, 69, 102-104, 136-138, 147-148, 155, 166-169, 189, 208-209, 227, 287-301, 317-331, 344-352, 357-359, 362, 378
app/shared/adapters/aws_multitenant.py                                         148     21     34      6    83%   97-100, 104-106, 266->exit, 272->270, 302-306, 319, 330-333, 365-368, 374-384
app/shared/adapters/aws_resource_explorer.py                                    46      6     10      3    84%   72, 74, 87, 91-93
app/shared/adapters/aws_utils.py                                                31      1     14      2    93%   60, 69->72
app/shared/adapters/azure.py                                                    99     21     22      6    73%   36-42, 45-48, 51-57, 65->67, 92, 127->134, 136-142, 167, 200, 202
app/shared/adapters/base.py                                                     15      0      0      0   100%
app/shared/adapters/cost_cache.py                                              184     45     34      9    72%   114-130, 135, 138-140, 145, 148-149, 152-158, 163, 169->172, 172->167, 175-177, 180-187, 271, 296, 325-328, 356->370, 362-363
app/shared/adapters/cur_adapter.py                                             117     43     26      6    62%   72-96, 124->122, 129, 133-135, 153-155, 178-179, 186-188, 191, 198-206, 212, 224, 239-241, 253-263, 267, 271
app/shared/adapters/factory.py                                                  26      2     12      2    89%   28, 44
app/shared/adapters/gcp.py                                                     104     18     16      4    78%   45-47, 94-95, 107-110, 173-175, 190-192, 212-213, 239-241
app/shared/adapters/rate_limiter.py                                             83      6     16      3    89%   54-55, 169, 184-187
app/shared/analysis/__init__.py                                                  0      0      0      0   100%
app/shared/analysis/azure_usage_analyzer.py                                    120      1     64      9    95%   41->39, 78->54, 117->100, 156->139, 193->177, 227->214, 264->248, 288, 314->302
app/shared/analysis/carbon_data.py                                               3      0      0      0   100%
app/shared/analysis/cur_usage_analyzer.py                                      180      0     98     13    95%   52->60, 151->160, 173->169, 206->214, 226->223, 269->247, 283->278, 313->321, 334->330, 365->374, 386->383, 415->422, 433->432
app/shared/analysis/forecaster.py                                              128     55     32      5    54%   15, 41-49, 79, 83-85, 104-148, 170-172, 181-191, 216-227
app/shared/analysis/gcp_usage_analyzer.py                                      115      1     52      7    95%   63, 153->138, 187->174, 218->208, 252->240, 284->273, 320->306
app/shared/cache/__init__.py                                                     3      0      0      0   100%
app/shared/connections/__init__.py                                               6      0      0      0   100%
app/shared/connections/aws.py                                                   36      0      4      0   100%
app/shared/connections/azure.py                                                 24      0      4      0   100%
app/shared/connections/cur_automation.py                                         2      0      0      0   100%
app/shared/connections/gcp.py                                                   21      0      4      0   100%
app/shared/connections/instructions.py                                          14      0      0      0   100%
app/shared/connections/oidc.py                                                  62      0      8      0   100%
app/shared/connections/organizations.py                                         39      0     10      0   100%
app/shared/core/__init__.py                                                      0      0      0      0   100%
app/shared/core/auth.py                                                         98      0     22      2    98%   31->33, 33->36
app/shared/core/cache.py                                                       104     10     24      6    88%   47-48, 50->57, 69->76, 113, 118-120, 133, 138->141, 142-144
app/shared/core/celery_app.py                                                   11      1      4      1    87%   48
app/shared/core/cloud_connection.py                                             69      1     22      6    92%   84->86, 89->91, 92, 94->97, 110->112, 119->122
app/shared/core/config.py                                                      135      3     36      3    96%   16, 57, 63
app/shared/core/constants.py                                                    12      0      0      0   100%
app/shared/core/currency.py                                                     87      3     32      3    95%   53->58, 75->80, 78-79, 104
app/shared/core/dependencies.py                                                 25      0      2      0   100%
app/shared/core/exceptions.py                                                   44      0      4      0   100%
app/shared/core/health.py                                                       58      0     10      0   100%
app/shared/core/logging.py                                                      44      1     14      1    97%   18
app/shared/core/middleware.py                                                   42      0     18      6    90%   22->25, 25->29, 47->50, 50->53, 53->56, 56->59
app/shared/core/notifications.py                                                26      0      6      0   100%
app/shared/core/ops_metrics.py                                                  11      0      0      0   100%
app/shared/core/pricing.py                                                     129      2     22      5    95%   254->261, 258-259, 292->298, 325->331, 383->385, 397->exit
app/shared/core/pricing_defaults.py                                              2      0      0      0   100%
app/shared/core/rate_limit.py                                                  111      6     34      4    93%   53-54, 88->93, 93->95, 112, 132-133, 164
app/shared/core/safety_service.py                                               52      0      8      1    98%   94->exit
app/shared/core/security.py                                                    120      7     32      2    93%   119-121, 125-127, 171
app/shared/core/security_metrics.py                                              5      0      0      0   100%
app/shared/core/sentry.py                                                       53      9     18      5    80%   27-30, 107->112, 109-110, 120, 133, 147, 150->exit
app/shared/core/timeout.py                                                      19      2      0      0    89%   41-47
app/shared/core/tracing.py                                                      41      0     10      1    98%   57->exit
app/shared/db/__init__.py                                                        0      0      0      0   100%
app/shared/db/base.py                                                           10      0      2      0   100%
app/shared/db/session.py                                                       126      9     52      6    92%   30, 59-61, 73->98, 83->85, 203-204, 238->243, 240-241, 260
app/shared/health/__init__.py                                                    2      0      0      0   100%
app/shared/lead_gen/__init__.py                                                  2      0      0      0   100%
app/shared/lead_gen/assessment.py                                                9      1      2      1    82%   10
app/shared/llm/__init__.py                                                       5      0      0      0   100%
app/shared/llm/analyzer.py                                                     236     15     62      8    92%   70-71, 166->170, 191-193, 257, 289-290, 327->330, 340->344, 385, 394-401, 460->exit
app/shared/llm/budget_manager.py                                               153     16     38      7    88%   111-116, 152-153, 181-189, 242-243, 283, 285, 319, 324, 328, 370->382, 379-380
app/shared/llm/circuit_breaker.py                                               95      8     30      6    87%   99->110, 112-116, 136->exit, 157-158, 164->exit, 189-191, 208->exit
app/shared/llm/delta_analysis.py                                               137      0     38      3    98%   228->204, 249->252, 362->369
app/shared/llm/factory.py                                                       82      0     32      0   100%
app/shared/llm/guardrails.py                                                   111      4     24      1    95%   92-95
app/shared/llm/hybrid_scheduler.py                                              87      0     22      2    98%   251->254, 254->258
app/shared/llm/pricing_data.py                                                   9      0      0      0   100%
app/shared/llm/providers/__init__.py                                             5      0      0      0   100%
app/shared/llm/providers/anthropic.py                                           10      0      0      0   100%
app/shared/llm/providers/base.py                                                14      0      6      0   100%
app/shared/llm/providers/google.py                                              10      0      0      0   100%
app/shared/llm/providers/groq.py                                                10      0      0      0   100%
app/shared/llm/providers/openai.py                                              10      0      0      0   100%
app/shared/llm/usage_tracker.py                                                 45      1      0      0    98%   164
app/shared/llm/zombie_analyzer.py                                               93      0     30      3    98%   107->104, 109->108, 203->206
app/shared/remediation/autonomous.py                                            22      2      2      0    92%   55-57
app/shared/remediation/circuit_breaker.py                                      104      1     22      1    98%   52
app/shared/remediation/hard_cap_service.py                                      16      0      0      0   100%
app/tasks/scheduler_tasks.py                                                   175     24     38      9    83%   25, 33-34, 49->127, 61, 76->80, 98->85, 117->123, 132, 141->195, 161->164, 176->154, 187-193, 200, 236->223, 245-247, 254, 267-268, 277-278, 284-288
------------------------------------------------------------------------------------------------------------------------
TOTAL                                                                        12115   1802   2628    355    83%
Coverage HTML written to dir htmlcov
FAIL Required test coverage of 95% not reached. Total coverage: 82.56%
=========================== short test summary info ============================
FAILED tests/adapters/test_aws_cur.py::test_ingest_latest_parquet - pydantic_...
FAILED tests/adapters/test_aws_cur_streaming.py::test_ingest_latest_parquet_streaming
FAILED tests/analysis/test_forecaster_markers.py::test_forecast_with_anomaly_markers
FAILED tests/analysis/test_forecaster_markers.py::test_holt_winters_confidence_bands
FAILED tests/analysis/test_forecasting_realism.py::test_outlier_detection_logic
FAILED tests/analysis/test_forecasting_realism.py::test_interval_growth_over_time
FAILED tests/analysis/test_forecasting_realism.py::test_forecast_edge_cases_zero_cost
FAILED tests/analysis/test_prophet_forecaster.py::test_forecaster_prophet_success
FAILED tests/analysis/test_prophet_forecaster.py::test_forecaster_fallback_holt_winters
FAILED tests/unit/core/test_config_audit.py::test_settings_production_validation
FAILED tests/unit/core/test_config_validation.py::TestSettingsValidation::test_settings_missing_required_fields
FAILED tests/unit/core/test_forecaster_audit.py::test_forecaster_prophet_trigger
FAILED tests/unit/core/test_forecaster_audit.py::test_outlier_detection_3sigma
FAILED tests/unit/governance/settings/test_activeops.py::test_get_activeops_settings_creates_default
FAILED tests/unit/governance/settings/test_activeops.py::test_update_activeops_settings
FAILED tests/unit/governance/settings/test_activeops_deep.py::test_activeops_settings_full_lifecycle
FAILED tests/unit/governance/settings/test_activeops_deep.py::test_update_activeops_settings_creates_if_missing
FAILED tests/unit/governance/settings/test_carbon.py::test_get_carbon_settings_creates_default
FAILED tests/unit/governance/settings/test_carbon.py::test_update_carbon_settings
FAILED tests/unit/governance/settings/test_carbon.py::test_update_carbon_settings_creates_if_missing
FAILED tests/unit/governance/settings/test_connections.py::test_create_aws_connection
FAILED tests/unit/governance/settings/test_connections.py::test_create_azure_connection_denied_on_free_tier
FAILED tests/unit/governance/settings/test_connections.py::test_create_azure_connection_allowed_on_pro_tier
FAILED tests/unit/governance/settings/test_governance_deep.py::test_carbon_settings_lifecycle
FAILED tests/unit/governance/settings/test_governance_deep.py::test_notifications_settings_lifecycle
FAILED tests/unit/governance/settings/test_llm_settings.py::test_get_llm_settings_creates_default
FAILED tests/unit/governance/settings/test_llm_settings.py::test_update_llm_settings
FAILED tests/unit/governance/settings/test_notifications.py::test_get_notification_settings_creates_default
FAILED tests/unit/governance/settings/test_notifications.py::test_update_notification_settings
FAILED tests/unit/governance/settings/test_notifications.py::test_test_slack_notification
FAILED tests/unit/governance/settings/test_onboard.py::test_onboard_success
FAILED tests/unit/governance/settings/test_onboard.py::test_onboard_already_onboarded
FAILED tests/unit/governance/settings/test_onboard.py::test_onboard_with_cloud_verification_success
FAILED tests/unit/governance/settings/test_onboard.py::test_onboard_with_cloud_verification_failure
FAILED tests/unit/governance/settings/test_onboard_deep.py::test_onboard_lifecycle
FAILED tests/unit/governance/settings/test_onboard_deep.py::test_onboard_endpoint
FAILED tests/unit/governance/settings/test_onboard_deep.py::test_onboard_duplicate
FAILED tests/unit/governance/settings/test_onboard_deep.py::test_onboard_with_cloud_config_multi
FAILED tests/unit/governance/settings/test_onboard_deep.py::test_onboard_invalid_platform
FAILED tests/unit/governance/settings/test_onboard_deep.py::test_onboard_connection_fail
FAILED tests/unit/governance/settings/test_onboard_deep.py::test_onboard_exception_handler
FAILED tests/unit/governance/test_connections_api.py::test_create_aws_connection
FAILED tests/unit/governance/test_connections_api.py::test_duplicate_aws_connection
FAILED tests/unit/governance/test_connections_api.py::test_sync_aws_org - sql...
FAILED tests/unit/governance/test_connections_api.py::test_sync_aws_org_not_management
FAILED tests/unit/governance/test_connections_api.py::test_list_aws_connections
FAILED tests/unit/governance/test_connections_api.py::test_delete_aws_connection
FAILED tests/unit/governance/test_connections_api.py::test_create_azure_connection_denied_on_free
FAILED tests/unit/governance/test_connections_api.py::test_create_azure_connection_success_on_growth
FAILED tests/unit/governance/test_connections_api.py::test_verify_azure_connection
FAILED tests/unit/governance/test_connections_api.py::test_list_azure_connections
FAILED tests/unit/governance/test_connections_api.py::test_create_gcp_connection_success_on_growth
FAILED tests/unit/governance/test_connections_api.py::test_list_gcp_connections
FAILED tests/unit/governance/test_connections_api.py::test_delete_gcp_connection
FAILED tests/unit/governance/test_connections_api.py::test_link_discovered_account
FAILED tests/unit/governance/test_connections_api.py::test_link_discovered_account_idempotent
FAILED tests/unit/governance/test_connections_api.py::test_create_azure_connection_duplicate
FAILED tests/unit/governance/test_connections_api.py::test_create_gcp_connection_duplicate
FAILED tests/unit/governance/test_jobs_api.py::test_get_queue_status - sqlalc...
FAILED tests/unit/modules/reporting/test_reporting_service.py::TestCloudAccountRegistry::test_ingest_syncs_cloud_account_registry
FAILED tests/unit/reporting/test_reporting_persistence_deep.py::test_cleanup_loops
FAILED tests/unit/reporting/test_reporting_persistence_deep.py::test_finalize_batch_success
FAILED tests/unit/services/adapters/test_cur_adapter.py::test_parse_cur_files_success
= 63 failed, 1785 passed, 2 skipped, 21 xfailed, 23 warnings in 296.77s (0:04:56) =
