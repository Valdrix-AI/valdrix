groups:
  - name: valdrics-enforcement-control-plane
    interval: 30s
    rules:
      - record: valdrics:enforcement_gate_error_ratio_5m
        expr: |
          sum by (source) (rate(valdrics_ops_enforcement_gate_failures_total[5m]))
          /
          clamp_min(
            sum by (source) (rate(valdrics_ops_enforcement_gate_decisions_total[5m])),
            0.001
          )

      - record: valdrics:enforcement_gate_error_ratio_30m
        expr: |
          sum by (source) (rate(valdrics_ops_enforcement_gate_failures_total[30m]))
          /
          clamp_min(
            sum by (source) (rate(valdrics_ops_enforcement_gate_decisions_total[30m])),
            0.001
          )

      - record: valdrics:enforcement_gate_error_ratio_1h
        expr: |
          sum by (source) (rate(valdrics_ops_enforcement_gate_failures_total[1h]))
          /
          clamp_min(
            sum by (source) (rate(valdrics_ops_enforcement_gate_decisions_total[1h])),
            0.001
          )

      - record: valdrics:enforcement_gate_error_ratio_6h
        expr: |
          sum by (source) (rate(valdrics_ops_enforcement_gate_failures_total[6h]))
          /
          clamp_min(
            sum by (source) (rate(valdrics_ops_enforcement_gate_decisions_total[6h])),
            0.001
          )

      - alert: ValdricsEnforcementErrorBudgetBurnFast
        expr: |
          valdrics:enforcement_gate_error_ratio_1h > (14.4 * 0.001)
          and
          valdrics:enforcement_gate_error_ratio_5m > (14.4 * 0.001)
          and
          sum by (source) (increase(valdrics_ops_enforcement_gate_decisions_total[1h])) >= 200
        for: 2m
        labels:
          severity: critical
          service: enforcement
          slo: gate-availability
        annotations:
          summary: "Enforcement error-budget burn is critically high"
          description: "1h and 5m burn-rate windows exceeded the 14.4x threshold for a 99.9% SLO."
          runbook: "docs/runbooks/enforcement_incident_response.md"

      - alert: ValdricsEnforcementErrorBudgetBurnSlow
        expr: |
          valdrics:enforcement_gate_error_ratio_6h > (6 * 0.001)
          and
          valdrics:enforcement_gate_error_ratio_30m > (6 * 0.001)
          and
          sum by (source) (increase(valdrics_ops_enforcement_gate_decisions_total[6h])) >= 600
        for: 15m
        labels:
          severity: warning
          service: enforcement
          slo: gate-availability
        annotations:
          summary: "Enforcement error-budget burn is sustained"
          description: "6h and 30m burn-rate windows exceeded the 6x threshold for a 99.9% SLO."
          runbook: "docs/runbooks/enforcement_incident_response.md"

      - alert: ValdricsEnforcementGateTimeoutSpike
        expr: increase(valdrics_ops_enforcement_gate_failures_total{failure_type="timeout"}[10m]) > 5
        for: 5m
        labels:
          severity: warning
          service: enforcement
        annotations:
          summary: "Enforcement gate timeout fallback spike"
          description: "Gate timeout fallback triggered more than 5 times in 10 minutes."
          runbook: "docs/runbooks/enforcement_incident_response.md"

      - alert: ValdricsEnforcementGateLockContentionSpike
        expr: increase(valdrics_ops_enforcement_gate_lock_events_total{event=~"contended|timeout|not_acquired"}[10m]) > 20
        for: 5m
        labels:
          severity: warning
          service: enforcement
        annotations:
          summary: "Enforcement gate lock contention spike"
          description: "Gate lock contention/timeout events exceeded 20 in 10 minutes."
          runbook: "docs/runbooks/enforcement_incident_response.md"

      - alert: ValdricsEnforcementGateLatencyP95High
        expr: histogram_quantile(0.95, sum by (le, source, path) (rate(valdrics_ops_enforcement_gate_latency_seconds_bucket[10m]))) > 2
        for: 10m
        labels:
          severity: warning
          service: enforcement
        annotations:
          summary: "Enforcement gate p95 latency high"
          description: "p95 gate evaluation latency exceeded 2 seconds for 10 minutes."
          runbook: "docs/runbooks/enforcement_incident_response.md"

      - alert: ValdricsEnforcementGlobalThrottleHits
        expr: increase(valdrics_security_rate_limit_exceeded_total{path=~"/api/v1/enforcement/gate.*"}[10m]) > 50
        for: 5m
        labels:
          severity: warning
          service: enforcement
        annotations:
          summary: "Enforcement global throttle pressure"
          description: "Rate-limit exceeded events on enforcement gate endpoints exceeded 50 in 10 minutes."
          runbook: "docs/runbooks/enforcement_incident_response.md"

      - alert: ValdricsEnforcementApprovalQueueBacklogHigh
        expr: max by (viewer_role) (valdrics_ops_enforcement_approval_queue_backlog) > 100
        for: 15m
        labels:
          severity: warning
          service: enforcement
        annotations:
          summary: "Approval queue backlog high"
          description: "Visible approval backlog exceeded 100 for at least 15 minutes."
          runbook: "docs/runbooks/enforcement_incident_response.md"

      - alert: ValdricsEnforcementExportParityMismatch
        expr: increase(valdrics_ops_enforcement_export_events_total{artifact=~"bundle|parity|archive",outcome="mismatch"}[15m]) > 0
        for: 1m
        labels:
          severity: critical
          service: enforcement
        annotations:
          summary: "Export parity mismatch detected"
          description: "At least one export parity mismatch was observed in the last 15 minutes."
          runbook: "docs/runbooks/enforcement_incident_response.md"

      - alert: ValdricsLLMFairUseDenialsSpike
        expr: increase(valdrics_ops_llm_fair_use_denials_total{gate=~"global_abuse|daily_user|daily_tenant"}[15m]) > 100
        for: 10m
        labels:
          severity: warning
          service: llm
        annotations:
          summary: "LLM fair-use denials spike"
          description: "Fair-use denials exceeded 100 over 15 minutes."
          runbook: "docs/runbooks/enforcement_incident_response.md"
