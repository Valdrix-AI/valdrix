============================= test session starts ==============================
platform linux -- Python 3.13.5, pytest-9.0.2, pluggy-1.6.0
rootdir: /home/daretechie/DevProject/GitHub/CloudSentinel-AI
configfile: pyproject.toml
plugins: anyio-4.12.1, mock-3.15.1, langsmith-0.6.2, respx-0.22.0, cov-7.0.0, asyncio-1.3.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 388 items

tests/unit/core/test_analyzer_audit.py ...                               [  0%]
tests/unit/core/test_auth_audit.py ................                      [  4%]
tests/unit/core/test_auth_core.py ...................                    [  9%]
tests/unit/core/test_budget_manager_audit.py .....                       [ 11%]
tests/unit/core/test_cache.py ...                                        [ 11%]
tests/unit/core/test_cache_deep.py ..........                            [ 14%]
tests/unit/core/test_cache_resilience.py ..                              [ 14%]
tests/unit/core/test_celery_app.py .                                     [ 15%]
tests/unit/core/test_circuit_breaker_resilience.py ....                  [ 16%]
tests/unit/core/test_cloud_connection.py ......                          [ 17%]
tests/unit/core/test_cloud_connection_audit.py .......                   [ 19%]
tests/unit/core/test_config_audit.py .......                             [ 21%]
tests/unit/core/test_config_validation.py ............                   [ 24%]
tests/unit/core/test_currency.py FF.                                     [ 25%]
tests/unit/core/test_currency_deep.py .......F.......                    [ 29%]
tests/unit/core/test_db_resilience.py ..                                 [ 29%]
tests/unit/core/test_db_session_deep.py ..............                   [ 33%]
tests/unit/core/test_dependencies.py ........                            [ 35%]
tests/unit/core/test_exceptions.py ........                              [ 37%]
tests/unit/core/test_forecaster_audit.py ....                            [ 38%]
tests/unit/core/test_guardrails_audit.py .....                           [ 39%]
tests/unit/core/test_health_missing_coverage.py ....                     [ 40%]
tests/unit/core/test_logging_audit.py .....                              [ 42%]
tests/unit/core/test_main.py ....                                        [ 43%]
tests/unit/core/test_middleware.py ..                                    [ 43%]
tests/unit/core/test_middleware_audit.py ....                            [ 44%]
tests/unit/core/test_models.py ..                                        [ 45%]
tests/unit/core/test_notifications_coverage.py ........                  [ 47%]
tests/unit/core/test_observability_deep.py ........                      [ 49%]
tests/unit/core/test_pricing_deep.py ...............                     [ 53%]
tests/unit/core/test_rate_limit.py ...                                   [ 53%]
tests/unit/core/test_rate_limit_audit.py ..........                      [ 56%]
tests/unit/core/test_rate_limit_expanded.py ............                 [ 59%]
tests/unit/core/test_safety_service_audit.py .....                       [ 60%]
tests/unit/core/test_security.py .....                                   [ 62%]
tests/unit/core/test_security_audit.py .................                 [ 66%]
tests/unit/core/test_security_gates_audit.py ....                        [ 67%]
tests/unit/core/test_sentry_deep.py ........                             [ 69%]
tests/unit/core/test_session.py ....                                     [ 70%]
tests/unit/core/test_session_audit.py ...........                        [ 73%]
tests/unit/core/test_tracing_deep.py .......                             [ 75%]
tests/unit/llm/test_analyzer.py ..                                       [ 75%]
tests/unit/llm/test_analyzer_exhaustive.py ..................            [ 80%]
tests/unit/llm/test_budget_manager.py ...                                [ 81%]
tests/unit/llm/test_budget_manager_exhaustive.py .....                   [ 82%]
tests/unit/llm/test_circuit_breaker.py ...                               [ 83%]
tests/unit/llm/test_delta_analysis.py ...                                [ 84%]
tests/unit/llm/test_factory.py ....                                      [ 85%]
tests/unit/llm/test_factory_audit.py ..............                      [ 88%]
tests/unit/llm/test_factory_modular.py .....                             [ 89%]
tests/unit/llm/test_guardrails_audit.py .........                        [ 92%]
tests/unit/llm/test_hybrid_scheduler.py ..                               [ 92%]
tests/unit/llm/test_providers.py ....                                    [ 93%]
tests/unit/llm/test_usage_tracker_audit.py .........                     [ 96%]
tests/unit/llm/test_zombie_analyzer.py ...                               [ 96%]
tests/unit/db/test_session.py ....                                       [ 97%]
tests/unit/db/test_session_deep.py .......                               [ 99%]
tests/unit/db/test_session_missing_coverage.py .
ERROR: Coverage failure: total of 44 is less than fail-under=95
                                                                         [100%]

=================================== FAILURES ===================================
___________________ test_convert_usd_to_ngn_paystack_success ___________________

    @pytest.mark.asyncio
    async def test_convert_usd_to_ngn_paystack_success():
        """Test converting USD to NGN using a successful Paystack mock."""
        mock_response = MagicMock()
        mock_response.status_code = 200
        mock_response.json.return_value = {
            "status": True,
            "data": {"rate": 1500.5}
        }
    
        with patch("app.shared.core.currency.get_settings") as mock_settings:
            # Mock Paystack key to enable API call
            mock_settings.return_value.PAYSTACK_SECRET_KEY = "test-secret-key"
    
            with patch("httpx.AsyncClient.get", return_value=mock_response):
                with patch("app.shared.core.currency._RATES_CACHE", {}): # Clear cache
>                   rate = await get_exchange_rate("NGN")
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/core/test_currency.py:22: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

to_currency = 'NGN'

    async def get_exchange_rate(to_currency: str) -> Decimal:
        """
        Returns the exchange rate for USD to to_currency.
        Uses Redis-backed cache for cross-service consistency.
        """
        settings = get_settings()
        to_currency = to_currency.upper()
    
        if to_currency == "USD":
            return Decimal("1.0")
    
        now = time.time()
    
        # 1. Try In-Memory Cache (Short-lived L1)
        cached_rate, last_updated = _RATES_CACHE.get(to_currency, (None, 0))
        # sync_interval_sec unused
        if cached_rate and (now - last_updated < 300): # 5 min in-memory stickiness
            return cached_rate
    
        # 2. Try Redis Cache (L2)
        from app.shared.core.cache import get_cache_service
        cache = get_cache_service()
        if cache.enabled:
            redis_key = f"currency_rate:{to_currency}"
            redis_data = await cache._get(redis_key)
            if redis_data:
>               rate = Decimal(str(redis_data["rate"]))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E               decimal.InvalidOperation: [<class 'decimal.ConversionSyntax'>]

app/shared/core/currency.py:121: InvalidOperation
----------------------------- Captured stdout call -----------------------------
2026-02-07 06:51:33 [debug    ] cache_hit                      key=currency_rate:NGN
_______________________ test_convert_usd_fallback_rates ________________________

    @pytest.mark.asyncio
    async def test_convert_usd_fallback_rates():
        """Test switching to fallback rates if Paystack fails."""
        mock_response = MagicMock()
        mock_response.status_code = 401 # Unauthorized or generic failure
    
        with patch("httpx.AsyncClient.get", return_value=mock_response):
            with patch("app.shared.core.currency._RATES_CACHE", {}):
>               rate = await get_exchange_rate("EUR")
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/core/test_currency.py:39: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

to_currency = 'EUR'

    async def get_exchange_rate(to_currency: str) -> Decimal:
        """
        Returns the exchange rate for USD to to_currency.
        Uses Redis-backed cache for cross-service consistency.
        """
        settings = get_settings()
        to_currency = to_currency.upper()
    
        if to_currency == "USD":
            return Decimal("1.0")
    
        now = time.time()
    
        # 1. Try In-Memory Cache (Short-lived L1)
        cached_rate, last_updated = _RATES_CACHE.get(to_currency, (None, 0))
        # sync_interval_sec unused
        if cached_rate and (now - last_updated < 300): # 5 min in-memory stickiness
            return cached_rate
    
        # 2. Try Redis Cache (L2)
        from app.shared.core.cache import get_cache_service
        cache = get_cache_service()
        if cache.enabled:
            redis_key = f"currency_rate:{to_currency}"
            redis_data = await cache._get(redis_key)
            if redis_data:
>               rate = Decimal(str(redis_data["rate"]))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E               decimal.InvalidOperation: [<class 'decimal.ConversionSyntax'>]

app/shared/core/currency.py:121: InvalidOperation
----------------------------- Captured stdout call -----------------------------
2026-02-07 06:51:34 [debug    ] cache_hit                      key=currency_rate:EUR
______ TestCurrencyDeep.test_get_exchange_rate_total_failure_returns_one _______

self = <tests.unit.core.test_currency_deep.TestCurrencyDeep object at 0x7be13a521950>

    @pytest.mark.asyncio
    async def test_get_exchange_rate_total_failure_returns_one(self):
        """Test fallback to 1.0 when all sources fail."""
        with patch("app.shared.core.currency.fetch_paystack_ngn_rate", AsyncMock(return_value=None)), \
             patch("app.shared.core.currency.fetch_fallback_rates", AsyncMock(return_value={})):
>           rate = await get_exchange_rate("UNKNOWN")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/core/test_currency_deep.py:92: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

to_currency = 'UNKNOWN'

    async def get_exchange_rate(to_currency: str) -> Decimal:
        """
        Returns the exchange rate for USD to to_currency.
        Uses Redis-backed cache for cross-service consistency.
        """
        settings = get_settings()
        to_currency = to_currency.upper()
    
        if to_currency == "USD":
            return Decimal("1.0")
    
        now = time.time()
    
        # 1. Try In-Memory Cache (Short-lived L1)
        cached_rate, last_updated = _RATES_CACHE.get(to_currency, (None, 0))
        # sync_interval_sec unused
        if cached_rate and (now - last_updated < 300): # 5 min in-memory stickiness
            return cached_rate
    
        # 2. Try Redis Cache (L2)
        from app.shared.core.cache import get_cache_service
        cache = get_cache_service()
        if cache.enabled:
            redis_key = f"currency_rate:{to_currency}"
            redis_data = await cache._get(redis_key)
            if redis_data:
>               rate = Decimal(str(redis_data["rate"]))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E               decimal.InvalidOperation: [<class 'decimal.ConversionSyntax'>]

app/shared/core/currency.py:121: InvalidOperation
----------------------------- Captured stdout call -----------------------------
2026-02-07 06:51:34 [debug    ] cache_hit                      key=currency_rate:UNKNOWN
=============================== warnings summary ===============================
tests/unit/core/test_main.py::test_root_endpoint
  /home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/codecarbon/core/gpu.py:4: FutureWarning: The pynvml package is deprecated. Please install nvidia-ml-py instead. If you did not install pynvml directly, please report this to the maintainers of the package that installed pynvml for you.
    import pynvml

tests/unit/core/test_pricing_deep.py::TestPricingDeep::test_get_tenant_tier_empty
  /home/daretechie/DevProject/GitHub/CloudSentinel-AI/tests/unit/core/test_pricing_deep.py:168: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    tier = await get_tenant_tier(uuid.uuid4(), mock_db)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/core/test_security_audit.py::test_context_specific_encryption
tests/unit/core/test_security_audit.py::test_decrypt_invalid_input
  /home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/lib/python3.13/site-packages/structlog/_base.py:173: UserWarning: Remove `format_exc_info` from your processor chain if you want pretty exceptions.
    event_dict = proc(self._logger, method_name, event_dict)

tests/unit/llm/test_analyzer_exhaustive.py::test_analyze_force_refresh
tests/unit/llm/test_analyzer_exhaustive.py::test_analyze_with_delta_analysis_enabled
tests/unit/llm/test_budget_manager.py::test_record_usage
tests/unit/llm/test_budget_manager_exhaustive.py::test_record_usage
  /home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/llm/budget_manager.py:232: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    db.add(usage)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.13.5-final-0 ________________

Name                                                                  Stmts   Miss Branch BrPart  Cover   Missing
-----------------------------------------------------------------------------------------------------------------
app/__init__.py                                                           0      0      0      0   100%
app/main.py                                                             196     53     18      2    68%   91-130, 151-156, 169-175, 187-192, 204, 217, 234, 245, 257-267, 278-288, 332, 368-378
app/models/anomaly_marker.py                                             21      1      0      0    95%   57
app/models/attribution.py                                                33      0      0      0   100%
app/models/aws_connection.py                                             40      2      0      0    95%   126, 134
app/models/azure_connection.py                                           33      1      0      0    97%   68
app/models/background_job.py                                             55      4      0      0    93%   94, 103-105
app/models/carbon_settings.py                                            21      0      0      0   100%
app/models/cloud.py                                                      40      0      0      0   100%
app/models/cost_audit.py                                                 20      0      0      0   100%
app/models/discovered_account.py                                         19      1      0      0    95%   43
app/models/gcp_connection.py                                             34      1      0      0    97%   72
app/models/llm.py                                                        67      8      0      0    88%   97, 156, 160, 164, 168, 172, 176, 185
app/models/notification_settings.py                                      23      1      0      0    96%   61
app/models/optimization.py                                               48      0      0      0   100%
app/models/pricing.py                                                    25      0      0      0   100%
app/models/remediation.py                                                67      1      0      0    99%   145
app/models/remediation_settings.py                                       19      1      0      0    95%   51
app/models/security.py                                                   17      0      0      0   100%
app/models/tenant.py                                                     50      3      2      1    92%   26, 83, 87
app/modules/governance/__init__.py                                        3      0      0      0   100%
app/modules/governance/api/__init__.py                                    0      0      0      0   100%
app/modules/governance/api/oidc.py                                        9      2      0      0    78%   16, 21
app/modules/governance/api/v1/__init__.py                                 0      0      0      0   100%
app/modules/governance/api/v1/admin.py                                   38     20      6      0    41%   19-45, 55-58, 76-80
app/modules/governance/api/v1/audit.py                                  141    108     14      0    21%   53-85, 95-128, 136-138, 155-213, 228-393
app/modules/governance/api/v1/health_dashboard.py                       102     44      2      0    56%   106-128, 142-175, 188-248, 262-291, 302-311
app/modules/governance/api/v1/jobs.py                                   109     54     12      0    45%   78-90, 113-116, 138-157, 177-194, 219-283, 296-311
app/modules/governance/api/v1/public.py                                  30     18      2      0    38%   17-30, 39-53
app/modules/governance/api/v1/settings/__init__.py                       12      0      0      0   100%
app/modules/governance/api/v1/settings/activeops.py                      43     21      6      0    45%   52-72, 84-118
app/modules/governance/api/v1/settings/carbon.py                         49     21      6      0    51%   60-84, 98-134
app/modules/governance/api/v1/settings/connections.py                   174    107     24      0    34%   52-74, 86-88, 96, 104, 117-144, 152-153, 164, 173-185, 195-206, 216-232, 243-288, 302-328, 341-342, 351, 360-372, 386-414, 427-428, 436-437, 446-458
app/modules/governance/api/v1/settings/llm.py                            69     31     12      0    47%   71-97, 119-167, 183-189
app/modules/governance/api/v1/settings/notifications.py                  74     38     10      0    43%   66-94, 108-147, 160-197
app/modules/governance/api/v1/settings/onboard.py                        65     39     16      0    32%   39-119
app/modules/governance/api/v1/settings/safety.py                         47     24      0      0    49%   54-80, 103-126
app/modules/governance/domain/__init__.py                                 0      0      0      0   100%
app/modules/governance/domain/jobs/handlers/__init__.py                  16      4      2      0    67%   37-40
app/modules/governance/domain/jobs/handlers/base.py                      81     60      2      0    25%   23, 77, 101-174, 178-184, 194-201, 211-232, 239-271
app/modules/governance/domain/jobs/handlers/billing.py                   28     20      8      0    22%   16-52
app/modules/governance/domain/jobs/handlers/costs.py                    116    100     18      0    12%   19-139, 150-177, 188-227, 238-263
app/modules/governance/domain/jobs/handlers/dunning.py                   16      9      2      0    39%   21-33
app/modules/governance/domain/jobs/handlers/finops.py                    29     21      4      0    24%   16-49
app/modules/governance/domain/jobs/handlers/notifications.py             35     27      8      0    19%   14-30, 37-58
app/modules/governance/domain/jobs/handlers/remediation.py               33     25      8      0    20%   16-63
app/modules/governance/domain/jobs/handlers/zombie.py                    35     27     20      0    15%   17-61
app/modules/governance/domain/jobs/processor.py                         113     92      8      0    17%   50, 58-107, 114-130, 135-231, 256-277
app/modules/governance/domain/scheduler/__init__.py                       3      0      0      0   100%
app/modules/governance/domain/scheduler/cohorts.py                       17      9      8      0    32%   22-36
app/modules/governance/domain/scheduler/orchestrator.py                  92     66      4      0    27%   26-31, 37-47, 58-64, 68-73, 77-82, 90-118, 122-124, 140-191, 194, 197, 212-213, 217-223
app/modules/governance/domain/scheduler/processors.py                   118     97     38      0    13%   25, 29-128, 135-182, 185-203
app/modules/governance/domain/security/__init__.py                        0      0      0      0   100%
app/modules/governance/domain/security/audit_log.py                      85     21     10      0    67%   175-178, 197-229, 236-252
app/modules/notifications/__init__.py                                     2      0      0      0   100%
app/modules/notifications/domain/__init__.py                              3      0      0      0   100%
app/modules/notifications/domain/email_service.py                       102     86      4      0    15%   20-22, 41-45, 62-93, 97-105, 164-224, 228-280, 284-341
app/modules/notifications/domain/slack.py                                75     52     18      0    25%   33-35, 53-72, 83-103, 128, 164-181, 201-209, 221-226
app/modules/optimization/__init__.py                                      4      0      0      0   100%
app/modules/optimization/adapters/__init__.py                             0      0      0      0   100%
app/modules/optimization/adapters/aws/__init__.py                         1      0      0      0   100%
app/modules/optimization/adapters/aws/detector.py                        41     25      6      0    34%   21-28, 32, 36, 42-58, 65-79
app/modules/optimization/adapters/aws/plugins/__init__.py                 9      0      0      0   100%
app/modules/optimization/adapters/aws/plugins/analytics.py               41     27      8      0    29%   16, 19-65
app/modules/optimization/adapters/aws/plugins/compute.py                112     90     48      0    14%   18, 22-52, 58, 64-79, 82-238
app/modules/optimization/adapters/aws/plugins/containers.py              36     22     12      0    29%   16, 19-52
app/modules/optimization/adapters/aws/plugins/database.py                84     65     26      0    17%   16, 19-102, 108, 111-157
app/modules/optimization/adapters/aws/plugins/high_value.py             111     87     30      0    17%   31, 41-93, 105, 115-180, 192, 202-255
app/modules/optimization/adapters/aws/plugins/infrastructure.py         123    100     28      0    15%   30, 40-123, 136, 146-197, 209, 219-282
app/modules/optimization/adapters/aws/plugins/network.py                 81     63     24      0    17%   15, 18-71, 77, 80-133
app/modules/optimization/adapters/aws/plugins/storage.py                 87     64     18      0    22%   15, 18-100, 106, 109-146, 152, 155-182
app/modules/optimization/adapters/azure/__init__.py                       1      0      0      0   100%
app/modules/optimization/adapters/azure/detector.py                      62     43     28      0    21%   23-48, 52, 56, 62-87, 90, 93-100
app/modules/optimization/adapters/azure/plugins/__init__.py              10      0      0      0   100%
app/modules/optimization/adapters/azure/plugins/compute.py               43     27     10      0    30%   22, 31-70, 79, 83-92
app/modules/optimization/adapters/azure/plugins/containers.py            55     40     16      0    21%   21, 25-63, 72, 76-117
app/modules/optimization/adapters/azure/plugins/database.py              27     17      8      0    29%   21, 25-58
app/modules/optimization/adapters/azure/plugins/idle_vms.py              75     58     28      0    17%   20-21, 25, 35-111, 117-132, 136-146
app/modules/optimization/adapters/azure/plugins/network.py               58     37     14      0    29%   22, 26-60, 69, 73-95, 104, 108-132
app/modules/optimization/adapters/azure/plugins/orphaned_images.py       30     18      8      0    32%   19, 27-60
app/modules/optimization/adapters/azure/plugins/orphaned_ips.py          25     13      6      0    39%   18, 24-50
app/modules/optimization/adapters/azure/plugins/storage.py               51     34     10      0    28%   23, 27-64, 73, 77-109
app/modules/optimization/adapters/azure/plugins/unattached_disks.py      50     35     20      0    21%   20, 26-77, 84-91
app/modules/optimization/adapters/gcp/__init__.py                         1      0      0      0   100%
app/modules/optimization/adapters/gcp/detector.py                        69     53     32      0    16%   24-48, 52, 56, 62-98
app/modules/optimization/adapters/gcp/plugins/__init__.py                11      0      0      0   100%
app/modules/optimization/adapters/gcp/plugins/compute.py                 47     31     14      0    26%   22, 31-73, 82, 86-96
app/modules/optimization/adapters/gcp/plugins/containers.py              54     34     10      0    31%   21, 25-63, 72, 76-84, 93, 97-105
app/modules/optimization/adapters/gcp/plugins/database.py                28     18      6      0    29%   21, 25-58
app/modules/optimization/adapters/gcp/plugins/idle_instances.py          87     72     36      0    12%   20, 30-139, 145-164, 168-178
app/modules/optimization/adapters/gcp/plugins/machine_images.py          26     14      4      0    40%   19, 25-54
app/modules/optimization/adapters/gcp/plugins/network.py                 32     21     10      0    26%   22, 26-64
app/modules/optimization/adapters/gcp/plugins/storage.py                 56     39     14      0    24%   23, 27-68, 77, 81-113
app/modules/optimization/adapters/gcp/plugins/unattached_disks.py        40     27     10      0    26%   18, 24-68, 75-82
app/modules/optimization/adapters/gcp/plugins/unused_ips.py              26     15      4      0    37%   18, 24-62
app/modules/optimization/api/__init__.py                                  0      0      0      0   100%
app/modules/optimization/api/v1/__init__.py                               0      0      0      0   100%
app/modules/optimization/api/v1/strategies.py                            46     17      2      0    60%   42-48, 59-62, 79-96
app/modules/optimization/api/v1/zombies.py                               92     48      6      0    45%   54-68, 84-108, 120-122, 146-152, 169-191, 208-224
app/modules/optimization/domain/__init__.py                               7      0      0      0   100%
app/modules/optimization/domain/aws_provider/__init__.py                  2      0      0      0   100%
app/modules/optimization/domain/aws_provider/plugins/__init__.py          9      0      0      0   100%
app/modules/optimization/domain/detector.py                               2      0      0      0   100%
app/modules/optimization/domain/factory.py                               17      8      6      0    39%   14-25
app/modules/optimization/domain/plugin.py                                23     12      6      0    38%   37, 47, 51-63
app/modules/optimization/domain/ports.py                                 79     57     18      0    23%   36-40, 61-133, 137-153, 161
app/modules/optimization/domain/registry.py                              15      1      0      0    93%   24
app/modules/optimization/domain/remediation.py                          293    259     72      0     9%   48-51, 55-65, 85-125, 129-137, 150-176, 186-209, 224-442, 450-477, 485-501, 509-525, 533-602, 612-648, 657-733, 737-739
app/modules/optimization/domain/service.py                              158    136     28      0    12%   33, 47-227, 231-255, 262-267, 275, 281-330, 336-359
app/modules/reporting/__init__.py                                         5      0      0      0   100%
app/modules/reporting/api/__init__.py                                     0      0      0      0   100%
app/modules/reporting/api/v1/__init__.py                                  0      0      0      0   100%
app/modules/reporting/api/v1/billing.py                                 191    142     32      0    22%   54-99, 110-133, 146-151, 168-205, 214-230, 241-305, 316-341, 349-363, 379-395
app/modules/reporting/api/v1/carbon.py                                   78     48     12      0    33%   35-51, 60-96, 105-119, 128-135, 149-156
app/modules/reporting/api/v1/costs.py                                    43     20      4      0    49%   27, 40, 53-66, 87-111, 121-130
app/modules/reporting/api/v1/currency.py                                 21     10      2      0    48%   18-25, 36-41
app/modules/reporting/api/v1/leaderboards.py                             43     19      6      0    49%   57-113
app/modules/reporting/api/v1/usage.py                                    74     30      0      0    59%   81-93, 111-140, 159-189, 199-223
app/modules/reporting/domain/__init__.py                                  3      0      0      0   100%
app/modules/reporting/domain/aggregator.py                              149    118     32      0    17%   31-40, 54-95, 114-158, 179-211, 229-279, 298-336, 360-421, 431-446
app/modules/reporting/domain/attribution_engine.py                      126    107     62      0    10%   27, 34-41, 49-71, 82-196, 206-221, 234-263, 279-317, 328-357
app/modules/reporting/domain/budget_alerts.py                           109     95     44      0     9%   33, 52-79, 92-106, 117-134, 138-145, 157-275
app/modules/reporting/domain/calculator.py                               80     65     26      0    14%   95-134, 145-173, 183-249, 257, 278-294, 314-319
app/modules/reporting/domain/carbon_scheduler.py                        125     89     42      0    22%   73-84, 111-113, 117-135, 139-158, 166-187, 190-198, 202, 216-232, 245-271, 286-295, 309-325
app/modules/reporting/domain/graviton_analyzer.py                        51     39     18      0    17%   99-101, 105-113, 122-191, 204-209
app/modules/reporting/domain/persistence.py                             119     99     40      0    13%   23, 36-88, 100-132, 136-174, 187-256, 260-265, 272-296, 302-324
app/modules/reporting/domain/pricing/service.py                          31     21      6      0    27%   28-49, 58-79, 90-91
app/modules/reporting/domain/service.py                                  63     45     10      0    25%   24, 28-32, 38-120
app/schemas/connections.py                                               77      0      0      0   100%
app/schemas/costs.py                                                     33      0      0      0   100%
app/shared/__init__.py                                                    0      0      0      0   100%
app/shared/adapters/aws_cur.py                                          150    121     32      0    16%   30-33, 37, 43-138, 147-148, 155, 166-169, 189, 195-238, 245-303, 317-331, 344-352, 357-359, 362, 378
app/shared/adapters/aws_multitenant.py                                  148    106     34      0    24%   66-70, 76, 85-88, 93-106, 111-145, 165-173, 196-223, 244-294, 302-306, 319, 327-384
app/shared/adapters/aws_utils.py                                         31     22     14      0    20%   28-36, 40, 52-72
app/shared/adapters/azure.py                                             99     74     22      0    21%   30-33, 36-42, 45-48, 51-57, 63-70, 80-96, 102, 123-146, 167, 181-183, 189-214
app/shared/adapters/base.py                                              15      1      0      0    93%   52
app/shared/adapters/factory.py                                           26     14     12      0    32%   24-46
app/shared/adapters/gcp.py                                              104     76     16      0    23%   30, 41-49, 53-59, 62, 68, 72-80, 93-131, 135, 153, 173-175, 190-192, 198-241
app/shared/adapters/rate_limiter.py                                      83     58     16      0    25%   46-74, 84-86, 96-98, 124-187, 199-204
app/shared/analysis/__init__.py                                           0      0      0      0   100%
app/shared/analysis/azure_usage_analyzer.py                             120    120     64      0     0%   7-327
app/shared/analysis/carbon_data.py                                        3      0      0      0   100%
app/shared/analysis/cur_usage_analyzer.py                               180    180     98      0     0%   11-447
app/shared/analysis/forecaster.py                                       128     64     32      3    48%   15, 36-37, 83-85, 90-92, 104-148, 163-191, 206, 216-227
app/shared/analysis/gcp_usage_analyzer.py                               115    115     52      0     0%   7-333
app/shared/cache/__init__.py                                              3      3      0      0     0%   1-4
app/shared/connections/__init__.py                                        6      0      0      0   100%
app/shared/connections/aws.py                                            36     23      4      0    32%   13, 21, 34-61
app/shared/connections/azure.py                                          24     14      4      0    36%   10, 13-16, 19-36
app/shared/connections/cur_automation.py                                  2      2      0      0     0%   1-3
app/shared/connections/gcp.py                                            21     12      4      0    36%   10, 13-30
app/shared/connections/instructions.py                                   14      8      0      0    43%   12-26, 36-49
app/shared/connections/oidc.py                                           62     37      8      0    36%   20-22, 34-41, 45-65, 76-80, 84-114, 121-122
app/shared/connections/organizations.py                                  39     29     10      0    20%   20-81
app/shared/core/__init__.py                                               0      0      0      0   100%
app/shared/core/auth.py                                                  98      0     22      2    98%   31->33, 33->36
app/shared/core/cache.py                                                104     14     24      6    84%   47-48, 50->57, 69->76, 102-103, 107-108, 113, 118-120, 133, 138->141, 142-144
app/shared/core/celery_app.py                                            11      1      4      2    80%   38->47, 48
app/shared/core/cloud_connection.py                                      69      1     22      6    92%   84->86, 89->91, 92, 94->97, 110->112, 119->122
app/shared/core/config.py                                               131      3     34      3    96%   46, 50, 52
app/shared/core/constants.py                                             12      0      0      0   100%
app/shared/core/currency.py                                              87      7     32      9    87%   53->58, 75->80, 78-79, 93, 104, 117->126, 129->132, 133-134, 139->145, 147
app/shared/core/dependencies.py                                          25      0      2      0   100%
app/shared/core/exceptions.py                                            44     13      4      0    65%   28-29, 34-42, 47, 52, 57, 62
app/shared/core/health.py                                                58     29     10      3    47%   24, 25->28, 37-45, 49-65, 76-79
app/shared/core/logging.py                                               44      1     14      1    97%   18
app/shared/core/middleware.py                                            42      1     18      7    87%   22->25, 25->29, 30, 47->50, 50->53, 53->56, 56->59
app/shared/core/notifications.py                                         26      0      6      0   100%
app/shared/core/ops_metrics.py                                           11      0      0      0   100%
app/shared/core/pricing.py                                              129      2     22      5    95%   254->261, 258-259, 292->298, 325->331, 383->385, 397->exit
app/shared/core/pricing_defaults.py                                       2      0      0      0   100%
app/shared/core/rate_limit.py                                           111      8     34      5    91%   53-54, 61->70, 88->93, 90-91, 93->95, 112, 132-133, 164
app/shared/core/safety_service.py                                        52      1      8      3    93%   78, 94->exit, 129->exit
app/shared/core/security.py                                             120      7     32      2    93%   119-121, 125-127, 171
app/shared/core/security_metrics.py                                       5      0      0      0   100%
app/shared/core/sentry.py                                                53      8     18      5    82%   31-33, 107->112, 109-110, 120, 133, 147, 150->exit
app/shared/core/timeout.py                                               19      3      0      0    84%   40-47
app/shared/core/tracing.py                                               41      1     10      1    96%   52, 57->exit
app/shared/db/__init__.py                                                 0      0      0      0   100%
app/shared/db/base.py                                                    10      1      2      1    83%   21
app/shared/db/session.py                                                123     38     50      9    64%   21-23, 33, 40-77, 90-94, 99, 121->exit, 196-197, 231->236, 233-234, 253
app/shared/health/__init__.py                                             2      2      0      0     0%   1-3
app/shared/lead_gen/__init__.py                                           2      0      0      0   100%
app/shared/lead_gen/assessment.py                                         9      6      2      0    27%   8-17
app/shared/llm/__init__.py                                                5      0      0      0   100%
app/shared/llm/analyzer.py                                              236     27     62     11    85%   68->74, 70-71, 166->170, 191-193, 196->214, 257, 283->306, 289-290, 319-328, 340->344, 385, 394-401, 425-427, 460->exit
app/shared/llm/budget_manager.py                                        153     25     38      7    81%   57-59, 111-116, 152-153, 181-189, 242-243, 281-292, 319, 324, 328, 359->exit, 370->382, 379-380
app/shared/llm/circuit_breaker.py                                        95     12     30      6    82%   99->110, 112-116, 136->exit, 157-158, 164->exit, 189-191, 195, 208->exit, 230-232
app/shared/llm/delta_analysis.py                                        133     26     34      8    75%   98, 137, 197->201, 210-216, 220-225, 228->204, 235, 249->252, 294, 303->301, 352-407
app/shared/llm/factory.py                                                82      9     32      3    84%   88-91, 97-100, 106-109
app/shared/llm/guardrails.py                                            111      5     24      2    93%   92-95, 176
app/shared/llm/hybrid_scheduler.py                                       87     33     22      3    61%   122, 124, 151->154, 169-188, 198-238, 248-263, 281-282
app/shared/llm/pricing_data.py                                            9      0      0      0   100%
app/shared/llm/providers/__init__.py                                      5      0      0      0   100%
app/shared/llm/providers/anthropic.py                                    10      0      0      0   100%
app/shared/llm/providers/base.py                                         14      0      6      0   100%
app/shared/llm/providers/google.py                                       10      0      0      0   100%
app/shared/llm/providers/groq.py                                         10      0      0      0   100%
app/shared/llm/providers/openai.py                                       10      1      0      0    90%   12
app/shared/llm/usage_tracker.py                                          45      9      0      0    80%   44-46, 138-150, 160, 164
app/shared/llm/zombie_analyzer.py                                        93     37     30      5    56%   107->104, 109->108, 126, 143-144, 155->159, 164-166, 183-209, 221-240
-----------------------------------------------------------------------------------------------------------------
TOTAL                                                                 10607   5404   2324    121    44%
Coverage HTML written to dir htmlcov
FAIL Required test coverage of 95% not reached. Total coverage: 43.89%
=========================== short test summary info ============================
FAILED tests/unit/core/test_currency.py::test_convert_usd_to_ngn_paystack_success
FAILED tests/unit/core/test_currency.py::test_convert_usd_fallback_rates - de...
FAILED tests/unit/core/test_currency_deep.py::TestCurrencyDeep::test_get_exchange_rate_total_failure_returns_one
================== 3 failed, 385 passed, 8 warnings in 36.82s ==================
