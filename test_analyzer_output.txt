============================= test session starts ==============================
platform linux -- Python 3.13.5, pytest-9.0.2, pluggy-1.6.0 -- /home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/bin/python3
cachedir: .pytest_cache
rootdir: /home/daretechie/DevProject/GitHub/CloudSentinel-AI
configfile: pyproject.toml
plugins: anyio-4.12.1, mock-3.15.1, langsmith-0.6.2, respx-0.22.0, cov-7.0.0, asyncio-1.3.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 13 items

tests/unit/llm/test_analyzer_exhaustive.py::test_load_system_prompt_success PASSED [  7%]
tests/unit/llm/test_analyzer_exhaustive.py::test_load_system_prompt_fallback PASSED [ 15%]
tests/unit/llm/test_analyzer_exhaustive.py::test_strip_markdown PASSED   [ 23%]
tests/unit/llm/test_analyzer_exhaustive.py::test_analyze_cache_hit_full PASSED [ 30%]
tests/unit/llm/test_analyzer_exhaustive.py::test_analyze_budget_exceeded PASSED [ 38%]
tests/unit/llm/test_analyzer_exhaustive.py::test_analyze_budget_error_unexpected PASSED [ 46%]
tests/unit/llm/test_analyzer_exhaustive.py::test_analyze_flow_success PASSED [ 53%]
tests/unit/llm/test_analyzer_exhaustive.py::test_llm_invocation_primary_failure_fallback PASSED [ 61%]
tests/unit/llm/test_analyzer_exhaustive.py::test_process_results_fallback PASSED [ 69%]
tests/unit/llm/test_analyzer_exhaustive.py::test_analyze_force_refresh FAILED [ 76%]
tests/unit/llm/test_analyzer_exhaustive.py::test_analyze_with_delta_analysis_stable FAILED [ 84%]
tests/unit/llm/test_analyzer_exhaustive.py::test_analyze_internal_llm_all_fail FAILED [ 92%]
tests/unit/llm/test_analyzer_exhaustive.py::test_process_results_with_slack_alert FAILED [100%]
ERROR: Coverage failure: total of 25 is less than fail-under=80


=================================== FAILURES ===================================
__________________________ test_analyze_force_refresh __________________________

mock_llm = RunnableLambda(afunc=_ainvoke)
usage_summary = CloudUsageSummary(tenant_id='1b9e194b-a279-48c4-be16-d8834aefdb43', provider='aws', start_date=datetime.date(2026, 2, ...atetime.date(2026, 2, 5), total_cost=Decimal('100.0'), records=[], by_service={}, by_region={}, by_tag={}, metadata={})
mock_db = <AsyncMock id='128078257732784'>

    @pytest.mark.asyncio
    async def test_analyze_force_refresh(mock_llm, usage_summary, mock_db):
        analyzer = FinOpsAnalyzer(mock_llm, mock_db)
        tenant_id = uuid4()
        mock_cache = MagicMock()
        mock_cache.get_analysis = AsyncMock(return_value={"cached": True})
    
        with patch("app.shared.llm.analyzer.get_cache_service", return_value=mock_cache), \
             patch("app.shared.llm.analyzer.get_settings") as mock_settings, \
>            patch.object(analyzer, "_analyze_internal", new_callable=AsyncMock) as mock_internal:
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/llm/test_analyzer_exhaustive.py:233: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x747c8b02c910>

    def __enter__(self):
        """Perform the patch."""
        if self.is_started:
            raise RuntimeError("Patch is already started")
    
        new, spec, spec_set = self.new, self.spec, self.spec_set
        autospec, kwargs = self.autospec, self.kwargs
        new_callable = self.new_callable
        self.target = self.getter()
    
        # normalise False to None
        if spec is False:
            spec = None
        if spec_set is False:
            spec_set = None
        if autospec is False:
            autospec = None
    
        if spec is not None and autospec is not None:
            raise TypeError("Can't specify spec and autospec")
        if ((spec is not None or autospec is not None) and
            spec_set not in (True, None)):
            raise TypeError("Can't provide explicit spec_set *and* spec or autospec")
    
>       original, local = self.get_original()
                          ^^^^^^^^^^^^^^^^^^^

../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/unittest/mock.py:1497: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x747c8b02c910>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <app.shared.llm.analyzer.FinOpsAnalyzer object at 0x747c8b059b50> does not have the attribute '_analyze_internal'

../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/unittest/mock.py:1467: AttributeError
___________________ test_analyze_with_delta_analysis_stable ____________________

mock_llm = RunnableLambda(afunc=_ainvoke)
usage_summary = CloudUsageSummary(tenant_id='35df9b69-6abb-48cd-a905-0f0d758b9260', provider='aws', start_date=datetime.date(2026, 2, ...atetime.date(2026, 2, 5), total_cost=Decimal('100.0'), records=[], by_service={}, by_region={}, by_tag={}, metadata={})
mock_db = <AsyncMock id='128078257731440'>

    @pytest.mark.asyncio
    async def test_analyze_with_delta_analysis_stable(mock_llm, usage_summary, mock_db):
        analyzer = FinOpsAnalyzer(mock_llm, mock_db)
        tenant_id = uuid4()
    
        mock_delta_svc = MagicMock()
        mock_delta_svc.compute_delta = MagicMock()
        # Mock stable scenario: has_significant_changes = False
        mock_delta_svc.compute_delta.return_value = MagicMock(has_significant_changes=False)
    
        with patch("app.shared.llm.analyzer.get_cache_service", return_value=MagicMock()), \
>            patch("app.shared.llm.analyzer.DeltaAnalysisService", return_value=mock_delta_svc), \
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
             patch("app.shared.llm.analyzer.get_settings") as mock_settings:

tests/unit/llm/test_analyzer_exhaustive.py:253: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x747c8b02e0b0>

    def __enter__(self):
        """Perform the patch."""
        if self.is_started:
            raise RuntimeError("Patch is already started")
    
        new, spec, spec_set = self.new, self.spec, self.spec_set
        autospec, kwargs = self.autospec, self.kwargs
        new_callable = self.new_callable
        self.target = self.getter()
    
        # normalise False to None
        if spec is False:
            spec = None
        if spec_set is False:
            spec_set = None
        if autospec is False:
            autospec = None
    
        if spec is not None and autospec is not None:
            raise TypeError("Can't specify spec and autospec")
        if ((spec is not None or autospec is not None) and
            spec_set not in (True, None)):
            raise TypeError("Can't provide explicit spec_set *and* spec or autospec")
    
>       original, local = self.get_original()
                          ^^^^^^^^^^^^^^^^^^^

../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/unittest/mock.py:1497: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x747c8b02e0b0>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'app.shared.llm.analyzer' from '/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/llm/analyzer.py'> does not have the attribute 'DeltaAnalysisService'

../../../.local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/lib/python3.13/unittest/mock.py:1467: AttributeError
______________________ test_analyze_internal_llm_all_fail ______________________

mock_llm_factory = <function mock_llm_factory.<locals>._create_mock_llm at 0x747c8b015b20>
usage_summary = CloudUsageSummary(tenant_id='3e6c7cf2-177a-4048-9bb7-7e6b8afc8f23', provider='aws', start_date=datetime.date(2026, 2, ...atetime.date(2026, 2, 5), total_cost=Decimal('100.0'), records=[], by_service={}, by_region={}, by_tag={}, metadata={})
mock_db = <AsyncMock id='128078257732112'>

    @pytest.mark.asyncio
    async def test_analyze_internal_llm_all_fail(mock_llm_factory, usage_summary, mock_db):
        # Test case where all LLMs fail in the fallback loop
        failing_llm = mock_llm_factory(should_fail=True)
        analyzer = FinOpsAnalyzer(failing_llm, mock_db)
    
        with patch("app.shared.llm.analyzer.LLMFactory.create", return_value=failing_llm), \
             patch("app.shared.llm.analyzer.get_settings") as mock_settings:
                mock_settings.return_value.LLM_FALLBACK_MODELS = ["fallback-1"]
    
                with pytest.raises(AIAnalysisError) as exc:
>                   await analyzer._analyze_with_fallback("Prompt", [], None)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E                   AttributeError: 'FinOpsAnalyzer' object has no attribute '_analyze_with_fallback'

tests/unit/llm/test_analyzer_exhaustive.py:271: AttributeError
____________________ test_process_results_with_slack_alert _____________________

mock_llm = RunnableLambda(afunc=_ainvoke)
mock_db = <AsyncMock id='128078257722368'>

    @pytest.mark.asyncio
    async def test_process_results_with_slack_alert(mock_llm, mock_db):
        analyzer = FinOpsAnalyzer(mock_llm, mock_db)
    
        with patch("app.shared.llm.analyzer.get_settings") as mock_settings, \
             patch("app.shared.llm.analyzer.SlackService.send_alert", new_callable=AsyncMock) as mock_slack:
                mock_settings.return_value.SLACK_BOT_TOKEN = "xoxb-test"
    
                # Mock validation failure to trigger slack alert
                with patch("app.shared.llm.analyzer.LLMGuardrails.validate_output", side_effect=Exception("Invalid")):
                    await analyzer._process_analysis_results('{"bad": "json"}', None, MagicMock(records=[], tenant_id=uuid4()))
>                   assert mock_slack.called
E                   AssertionError: assert False
E                    +  where False = <AsyncMock name='send_alert' id='128078257720352'>.called

tests/unit/llm/test_analyzer_exhaustive.py:285: AssertionError
----------------------------- Captured stdout call -----------------------------
2026-02-05 12:22:12 [debug    ] redis_disabled                 reason='UPSTASH credentials not configured'
2026-02-05 12:22:12 [warning  ] llm_validation_failed          error=Invalid
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.13.5-final-0 ________________

Name                                                Stmts   Miss Branch BrPart  Cover   Missing
-----------------------------------------------------------------------------------------------
app/__init__.py                                         0      0      0      0   100%
app/main.py                                           196    196     18      0     0%   1-399
app/models/anomaly_marker.py                           21      1      0      0    95%   57
app/models/attribution.py                              33      0      0      0   100%
app/models/aws_connection.py                           40      3      0      0    92%   126, 129, 134
app/models/azure_connection.py                         33      1      0      0    97%   68
app/models/background_job.py                           55      4      0      0    93%   94, 103-105
app/models/carbon_settings.py                          21      0      0      0   100%
app/models/cloud.py                                    40      0      0      0   100%
app/models/discovered_account.py                       19      1      0      0    95%   43
app/models/gcp_connection.py                           34      1      0      0    97%   72
app/models/llm.py                                      67     10      0      0    85%   97, 148, 152, 156, 160, 164, 168, 172, 176, 185
app/models/notification_settings.py                    23      1      0      0    96%   61
app/models/pricing.py                                  25      0      0      0   100%
app/models/remediation.py                              67      1      0      0    99%   145
app/models/security.py                                 17      0      0      0   100%
app/models/tenant.py                                   50      3      2      1    92%   26, 83, 87
app/modules/notifications/__init__.py                   2      0      0      0   100%
app/modules/notifications/domain/__init__.py            3      0      0      0   100%
app/modules/notifications/domain/email_service.py     102     86      4      0    15%   20-22, 41-45, 62-93, 97-105, 164-224, 228-280, 284-341
app/modules/notifications/domain/slack.py              75     56     18      0    20%   33-35, 44-49, 53-72, 83-103, 128, 164-181, 201-209, 221-226
app/schemas/costs.py                                   33      0      0      0   100%
app/shared/__init__.py                                  0      0      0      0   100%
app/shared/analysis/__init__.py                         0      0      0      0   100%
app/shared/analysis/azure_usage_analyzer.py           120    120     64      0     0%   7-327
app/shared/analysis/carbon_data.py                      3      0      0      0   100%
app/shared/analysis/cur_usage_analyzer.py             180    180     98      0     0%   11-447
app/shared/analysis/forecaster.py                     128     98     32      1    19%   15, 34-49, 71-92, 104-148, 163-191, 202-211, 216-227, 234-247
app/shared/analysis/gcp_usage_analyzer.py             115    115     52      0     0%   7-333
app/shared/cache/__init__.py                            3      3      0      0     0%   1-4
app/shared/connections/__init__.py                      6      6      0      0     0%   1-7
app/shared/connections/aws.py                          36     36      4      0     0%   1-59
app/shared/connections/azure.py                        24     24      4      0     0%   1-36
app/shared/connections/cur_automation.py                2      2      0      0     0%   1-3
app/shared/connections/gcp.py                          21     21      4      0     0%   1-30
app/shared/connections/instructions.py                 14     14      0      0     0%   1-49
app/shared/connections/oidc.py                         64     64      8      0     0%   1-124
app/shared/connections/organizations.py                39     39     10      0     0%   1-81
app/shared/core/__init__.py                             0      0      0      0   100%
app/shared/core/auth.py                                98     98     22      0     0%   1-247
app/shared/core/cache.py                               86     48     18      2    38%   44-57, 69-76, 92-93, 97-98, 102-103, 107-108, 112-120, 124-133, 137-149, 159->161
app/shared/core/celery_app.py                          11     11      4      0     0%   1-48
app/shared/core/cloud_connection.py                    69     69     22      0     0%   10-128
app/shared/core/config.py                             130     33     32      1    60%   31-100, 238
app/shared/core/constants.py                           12      0      0      0   100%
app/shared/core/currency.py                            87     87     32      0     0%   8-173
app/shared/core/dependencies.py                        25     25      2      0     0%   1-34
app/shared/core/exceptions.py                          42     14      4      0    61%   25-26, 31-39, 44, 49, 54, 59, 74
app/shared/core/health.py                              58     58     10      0     0%   1-79
app/shared/core/logging.py                             44     36     14      0    14%   11-38, 43-47, 50-82, 95-96
app/shared/core/middleware.py                          34     34      4      0     0%   1-68
app/shared/core/notifications.py                       26     26      6      0     0%   8-51
app/shared/core/ops_metrics.py                         11      0      0      0   100%
app/shared/core/pricing.py                            129     73     22      0    37%   233, 238-246, 253-255, 265-291, 298-324, 329-349, 362-364, 367-369, 372, 375, 378, 381-382
app/shared/core/pricing_defaults.py                     2      2      0      0     0%   7-56
app/shared/core/rate_limit.py                         111    111     34      0     0%   8-238
app/shared/core/safety_service.py                      52     52      8      0     0%   10-131
app/shared/core/security.py                           120     83     32      0    24%   40-41, 46-61, 75-90, 95-96, 106-129, 136-139, 145-147, 154-161, 170-187, 193-214, 221-232, 236
app/shared/core/security_metrics.py                     5      5      0      0     0%   8-31
app/shared/core/sentry.py                              53     53     18      0     0%   19-151
app/shared/core/timeout.py                             19     19      0      0     0%   7-47
app/shared/core/tracing.py                             41     41     10      0     0%   1-68
app/shared/db/__init__.py                               0      0      0      0   100%
app/shared/db/base.py                                  10      1      2      1    83%   21
app/shared/db/session.py                              122    122     50      0     0%   1-250
app/shared/health/__init__.py                           2      2      0      0     0%   1-3
app/shared/lead_gen/__init__.py                         2      2      0      0     0%   1-3
app/shared/lead_gen/assessment.py                       9      9      2      0     0%   1-17
app/shared/llm/__init__.py                              5      0      0      0   100%
app/shared/llm/analyzer.py                            227     58     56     17    69%   68->74, 70-71, 143->170, 166->170, 178-180, 191-193, 196->214, 210-211, 224, 235-253, 270->293, 276-277, 283-290, 306-315, 318-320, 324->331, 327->331, 339, 372, 381-388, 409-414, 446-450
app/shared/llm/budget_manager.py                      144    111     36      0    18%   55-71, 87-178, 196-249, 267-319, 326-370
app/shared/llm/circuit_breaker.py                      95     95     30      0     0%   25-232
app/shared/llm/delta_analysis.py                      133    133     34      0     0%   16-407
app/shared/llm/factory.py                              82     55     32      0    24%   23-34, 42, 47-52, 69-118, 128-139, 148-171, 190-200
app/shared/llm/guardrails.py                          111     60     24      0    38%   44-104, 111-117, 122-126, 175-201
app/shared/llm/hybrid_scheduler.py                     87     87     22      0     0%   11-282
app/shared/llm/pricing_data.py                          9      0      0      0   100%
app/shared/llm/providers/__init__.py                    5      5      0      0     0%   1-6
app/shared/llm/providers/anthropic.py                  10     10      0      0     0%   1-12
app/shared/llm/providers/base.py                       14     14      6      0     0%   1-26
app/shared/llm/providers/google.py                     10     10      0      0     0%   1-12
app/shared/llm/providers/groq.py                       10     10      0      0     0%   1-12
app/shared/llm/providers/openai.py                     10     10      0      0     0%   1-12
app/shared/llm/usage_tracker.py                        45     27      0      0    40%   28-49, 69, 81, 97, 119-129, 138-150, 156, 160, 164
app/shared/llm/zombie_analyzer.py                      93     72     30      0    17%   83-84, 91-95, 99-113, 124-166, 183-209, 221-240
-----------------------------------------------------------------------------------------------
TOTAL                                                4211   2957    936     23    25%
Coverage HTML written to dir htmlcov
FAIL Required test coverage of 80% not reached. Total coverage: 25.00%
=========================== short test summary info ============================
FAILED tests/unit/llm/test_analyzer_exhaustive.py::test_analyze_force_refresh - AttributeError: <app.shared.llm.analyzer.FinOpsAnalyzer object at 0x747c8b059b50> does not have the attribute '_analyze_internal'
FAILED tests/unit/llm/test_analyzer_exhaustive.py::test_analyze_with_delta_analysis_stable - AttributeError: <module 'app.shared.llm.analyzer' from '/home/daretechie/DevProject/GitHub/CloudSentinel-AI/app/shared/llm/analyzer.py'> does not have the attribute 'DeltaAnalysisService'
FAILED tests/unit/llm/test_analyzer_exhaustive.py::test_analyze_internal_llm_all_fail - AttributeError: 'FinOpsAnalyzer' object has no attribute '_analyze_with_fallback'
FAILED tests/unit/llm/test_analyzer_exhaustive.py::test_process_results_with_slack_alert - AssertionError: assert False
 +  where False = <AsyncMock name='send_alert' id='128078257720352'>.called
========================= 4 failed, 9 passed in 3.81s ==========================
