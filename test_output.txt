============================= test session starts ==============================
platform linux -- Python 3.13.5, pytest-9.0.2, pluggy-1.6.0 -- /home/daretechie/DevProject/GitHub/CloudSentinel-AI/.venv/bin/python3
cachedir: .pytest_cache
rootdir: /home/daretechie/DevProject/GitHub/CloudSentinel-AI
configfile: pyproject.toml
plugins: anyio-4.12.1, mock-3.15.1, langsmith-0.6.2, respx-0.22.0, cov-7.0.0, asyncio-1.3.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 1 item

tests/unit/reporting/test_reporting_persistence_deep.py::test_save_summary_sqlite_idempotency FAILED [100%]
ERROR: Coverage failure: total of 17 is less than fail-under=80


=================================== FAILURES ===================================
_____________________ test_save_summary_sqlite_idempotency _____________________

persistence_service = <app.modules.reporting.domain.persistence.CostPersistenceService object at 0x7f5b82df9be0>
mock_db = <AsyncMock id='140031014444336'>
sample_summary = CloudUsageSummary(tenant_id='09129737-cb26-4a28-90fd-227ac2a9f4f3', provider='aws', start_date=datetime.date(2026, 2, ...'AmazonEC2', region='us-east-1', usage_type='BoxUsage', tags={})], by_service={}, by_region={}, by_tag={}, metadata={})

    @pytest.mark.asyncio
    async def test_save_summary_sqlite_idempotency(persistence_service, mock_db, sample_summary):
        mock_db.bind.url = "sqlite+aiosqlite:///:memory:"
        account_id = str(uuid4())
    
        # Mock existing record
        existing_record = MagicMock()
        mock_result = MagicMock()
        mock_result.scalars.return_value.first.return_value = existing_record
        mock_db.execute.return_value = mock_result
    
>       await persistence_service.save_summary(sample_summary, account_id)

tests/unit/reporting/test_reporting_persistence_deep.py:83: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.modules.reporting.domain.persistence.CostPersistenceService object at 0x7f5b82df9be0>
summary = CloudUsageSummary(tenant_id='09129737-cb26-4a28-90fd-227ac2a9f4f3', provider='aws', start_date=datetime.date(2026, 2, ...'AmazonEC2', region='us-east-1', usage_type='BoxUsage', tags={})], by_service={}, by_region={}, by_tag={}, metadata={})
account_id = '1368cd6c-a6f2-4936-af1a-baf62be78c6d'
reconciliation_run_id = None, is_preliminary = True

    async def save_summary(
        self,
        summary: CloudUsageSummary,
        account_id: str,
        reconciliation_run_id: uuid.UUID | None = None,
        is_preliminary: bool = True
    ) -> dict:
        """
        Saves a CloudUsageSummary to the database.
        Uses PostgreSQL ON CONFLICT DO UPDATE for idempotency.
        """
        records_saved = 0
        total_processed = len(summary.records)
    
        # Batch size for database performance
        BATCH_SIZE = 500
    
        for i in range(0, total_processed, BATCH_SIZE):
            batch = summary.records[i : i + BATCH_SIZE]
    
            # Prepare values for bulk insert
            values = []
            for r in batch:
                # Forensic Lineage (FinOps Audit Phase 1)
                # We store the hash of the raw record if a specific ID isn't provided
                ingestion_meta = {
                    "source_id": str(uuid.uuid4()), # CostRecord schema doesn't have ID, always generate new
                    "ingestion_timestamp": datetime.now(timezone.utc).isoformat(),
                    "api_request_id": str(reconciliation_run_id) if reconciliation_run_id else None
                }
    
                values.append({
                    "tenant_id": summary.tenant_id,
                    "account_id": account_id,
                    "service": r.service or "Unknown",
                    "region": r.region or "Global",
                    "cost_usd": r.amount,
                    "amount_raw": r.amount_raw,
                    "currency": r.currency,
                    "recorded_at": r.date.date(), # Legacy date column
                    "timestamp": r.date,           # New hourly/timestamp column
                    "usage_type": r.usage_type,
                    "is_preliminary": is_preliminary,
                    "cost_status": "PRELIMINARY" if is_preliminary else "FINAL",
                    "reconciliation_run_id": reconciliation_run_id,
                    "ingestion_metadata": ingestion_meta
                })
    
            # BE-COST-2: Check for significant cost adjustments (>2%)
            if not is_preliminary:
                await self._check_for_significant_adjustments(summary.tenant_id, account_id, batch)
    
>           await self._bulk_upsert(values)

app/modules/reporting/domain/persistence.py:77: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.modules.reporting.domain.persistence.CostPersistenceService object at 0x7f5b82df9be0>
values = [{'account_id': '1368cd6c-a6f2-4936-af1a-baf62be78c6d', 'amount_raw': None, 'cost_status': 'PRELIMINARY', 'cost_usd': Decimal('10.00'), ...}]

    async def _bulk_upsert(self, values: List[Dict[str, Any]]):
        """Helper for PostgreSQL ON CONFLICT DO UPDATE bulk insert."""
        if not values:
            return
        bind_url = str(self.db.bind.url if self.db.bind else "")
        if "postgresql" in bind_url:
            stmt = pg_insert(CostRecord).values(values)
            stmt = stmt.on_conflict_do_update(
                constraint="uix_account_cost_granularity",
                set_={
                    "cost_usd": stmt.excluded.cost_usd,
                    "amount_raw": stmt.excluded.amount_raw,
                    "currency": stmt.excluded.currency,
                    "usage_type": stmt.excluded.usage_type
                }
            )
            await self.db.execute(stmt)
        else:
            # Fallback for SQLite/Testing: Manual Idempotency
            # We use session methods directly to avoid driver-level conflicts
            for val in values:
                # Use a fresh select to avoid session state issues
                stmt = select(CostRecord).where(
                    CostRecord.account_id == val["account_id"],
                    CostRecord.recorded_at == val["recorded_at"],
                    CostRecord.service == val["service"],
                    CostRecord.usage_type == val["usage_type"]
                )
                # Use scalar() which is safer
                res = await self.db.execute(stmt)
                existing = res.scalars().first()
    
                if existing:
                    existing.cost_usd = Decimal(str(val["cost_usd"]))
                    if "amount_raw" in val:
>                       existing.amount_raw = Decimal(str(val["amount_raw"]))
                                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E                       decimal.InvalidOperation: [<class 'decimal.ConversionSyntax'>]

app/modules/reporting/domain/persistence.py:169: InvalidOperation
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.13.5-final-0 ________________

Name                                                 Stmts   Miss Branch BrPart  Cover   Missing
------------------------------------------------------------------------------------------------
app/__init__.py                                          0      0      0      0   100%
app/main.py                                            196    196     18      0     0%   1-399
app/models/anomaly_marker.py                            21      1      0      0    95%   57
app/models/attribution.py                               33      0      0      0   100%
app/models/aws_connection.py                            40      3      0      0    92%   126, 129, 134
app/models/azure_connection.py                          33      1      0      0    97%   68
app/models/background_job.py                            55      4      0      0    93%   94, 103-105
app/models/carbon_settings.py                           21      0      0      0   100%
app/models/cloud.py                                     40      0      0      0   100%
app/models/cost_audit.py                                20      0      0      0   100%
app/models/discovered_account.py                        19      1      0      0    95%   43
app/models/gcp_connection.py                            34      1      0      0    97%   72
app/models/llm.py                                       67     10      0      0    85%   97, 148, 152, 156, 160, 164, 168, 172, 176, 185
app/models/notification_settings.py                     23      1      0      0    96%   61
app/models/pricing.py                                   25      0      0      0   100%
app/models/remediation.py                               67      1      0      0    99%   145
app/models/security.py                                  17      0      0      0   100%
app/models/tenant.py                                    50      3      2      1    92%   26, 83, 87
app/modules/reporting/__init__.py                        5      0      0      0   100%
app/modules/reporting/domain/__init__.py                 3      0      0      0   100%
app/modules/reporting/domain/aggregator.py             149    118     32      0    17%   31-40, 54-95, 114-158, 179-211, 229-279, 298-336, 360-421, 431-446
app/modules/reporting/domain/attribution_engine.py     126    107     62      0    10%   27, 34-41, 49-71, 82-196, 206-221, 234-263, 279-317, 328-357
app/modules/reporting/domain/calculator.py              80     65     26      0    14%   95-134, 145-173, 183-249, 257, 278-294, 314-319
app/modules/reporting/domain/persistence.py            118     75     38      7    33%   75, 78-88, 100-132, 137, 140-150, 168->154, 171-173, 186-255, 259-264, 271-295, 301-323
app/modules/reporting/domain/service.py                 63     45     10      0    25%   24, 28-32, 38-120
app/schemas/costs.py                                    33      0      0      0   100%
app/shared/__init__.py                                   0      0      0      0   100%
app/shared/adapters/aws_cur.py                         150    121     32      0    16%   30-33, 37, 43-138, 147-148, 155, 166-169, 189, 195-238, 245-303, 317-331, 344-352, 357-359, 362, 378
app/shared/adapters/aws_multitenant.py                 148    106     34      0    24%   66-70, 76, 85-88, 93-106, 111-145, 165-173, 196-223, 244-294, 302-306, 319, 327-384
app/shared/adapters/azure.py                            99     74     22      0    21%   30-33, 36-42, 45-48, 51-57, 63-70, 80-96, 102, 123-146, 167, 181-183, 189-214
app/shared/adapters/base.py                             15      1      0      0    93%   52
app/shared/adapters/factory.py                          26     14     12      0    32%   24-46
app/shared/adapters/gcp.py                             104     76     16      0    23%   30, 41-49, 53-59, 62, 68, 72-80, 93-131, 135, 153, 173-175, 190-192, 198-241
app/shared/analysis/__init__.py                          0      0      0      0   100%
app/shared/analysis/azure_usage_analyzer.py            120    120     64      0     0%   7-327
app/shared/analysis/carbon_data.py                       3      3      0      0     0%   6-18
app/shared/analysis/cur_usage_analyzer.py              180    180     98      0     0%   11-447
app/shared/analysis/forecaster.py                      128    128     32      0     0%   1-247
app/shared/analysis/gcp_usage_analyzer.py              115    115     52      0     0%   7-333
app/shared/cache/__init__.py                             3      3      0      0     0%   1-4
app/shared/connections/__init__.py                       6      6      0      0     0%   1-7
app/shared/connections/aws.py                           36     36      4      0     0%   1-59
app/shared/connections/azure.py                         24     24      4      0     0%   1-36
app/shared/connections/cur_automation.py                 2      2      0      0     0%   1-3
app/shared/connections/gcp.py                           21     21      4      0     0%   1-30
app/shared/connections/instructions.py                  14     14      0      0     0%   1-49
app/shared/connections/oidc.py                          64     64      8      0     0%   1-124
app/shared/connections/organizations.py                 39     39     10      0     0%   1-81
app/shared/core/__init__.py                              0      0      0      0   100%
app/shared/core/auth.py                                 98     98     22      0     0%   1-247
app/shared/core/cache.py                                86     86     18      0     0%   14-161
app/shared/core/celery_app.py                           11     11      4      0     0%   1-48
app/shared/core/cloud_connection.py                     69     69     22      0     0%   10-128
app/shared/core/config.py                              130     33     32      1    60%   31-100, 238
app/shared/core/constants.py                            12      0      0      0   100%
app/shared/core/currency.py                             87     87     32      0     0%   8-173
app/shared/core/dependencies.py                         25     25      2      0     0%   1-34
app/shared/core/exceptions.py                           42     21      4      0    46%   13-17, 25-26, 31-39, 44, 49, 54, 59, 64, 69, 74
app/shared/core/health.py                               58     58     10      0     0%   1-79
app/shared/core/logging.py                              44     44     14      0     0%   1-96
app/shared/core/middleware.py                           34     34      4      0     0%   1-68
app/shared/core/notifications.py                        26     26      6      0     0%   8-51
app/shared/core/ops_metrics.py                          11     11      0      0     0%   8-71
app/shared/core/pricing.py                             129    129     22      0     0%   1-382
app/shared/core/pricing_defaults.py                      2      2      0      0     0%   7-56
app/shared/core/rate_limit.py                          111    111     34      0     0%   8-238
app/shared/core/safety_service.py                       52     52      8      0     0%   10-131
app/shared/core/security.py                            120     83     32      0    24%   40-41, 46-61, 75-90, 95-96, 106-129, 136-139, 145-147, 154-161, 170-187, 193-214, 221-232, 236
app/shared/core/security_metrics.py                      5      5      0      0     0%   8-31
app/shared/core/sentry.py                               53     53     18      0     0%   19-151
app/shared/core/timeout.py                              19     19      0      0     0%   7-47
app/shared/core/tracing.py                              41     41     10      0     0%   1-68
app/shared/db/__init__.py                                0      0      0      0   100%
app/shared/db/base.py                                   10      1      2      1    83%   21
app/shared/db/session.py                               122    122     50      0     0%   1-250
app/shared/health/__init__.py                            2      2      0      0     0%   1-3
app/shared/lead_gen/__init__.py                          2      2      0      0     0%   1-3
app/shared/lead_gen/assessment.py                        9      9      2      0     0%   1-17
app/shared/llm/__init__.py                               5      5      0      0     0%   1-6
app/shared/llm/analyzer.py                             227    227     56      0     0%   1-450
app/shared/llm/budget_manager.py                       144    144     36      0     0%   8-370
app/shared/llm/circuit_breaker.py                       95     95     30      0     0%   25-232
app/shared/llm/delta_analysis.py                       133    133     34      0     0%   16-407
app/shared/llm/factory.py                               82     82     32      0     0%   1-203
app/shared/llm/guardrails.py                           111    111     24      0     0%   1-201
app/shared/llm/hybrid_scheduler.py                      87     87     22      0     0%   11-282
app/shared/llm/pricing_data.py                           9      9      0      0     0%   1-42
app/shared/llm/providers/__init__.py                     5      5      0      0     0%   1-6
app/shared/llm/providers/anthropic.py                   10     10      0      0     0%   1-12
app/shared/llm/providers/base.py                        14     14      6      0     0%   1-26
app/shared/llm/providers/google.py                      10     10      0      0     0%   1-12
app/shared/llm/providers/groq.py                        10     10      0      0     0%   1-12
app/shared/llm/providers/openai.py                      10     10      0      0     0%   1-12
app/shared/llm/usage_tracker.py                         45     45      0      0     0%   8-164
app/shared/llm/zombie_analyzer.py                       93     93     30      0     0%   11-240
------------------------------------------------------------------------------------------------
TOTAL                                                 5135   4103   1198     10    17%
Coverage HTML written to dir htmlcov
FAIL Required test coverage of 80% not reached. Total coverage: 16.52%
=========================== short test summary info ============================
FAILED tests/unit/reporting/test_reporting_persistence_deep.py::test_save_summary_sqlite_idempotency - decimal.InvalidOperation: [<class 'decimal.ConversionSyntax'>]
============================== 1 failed in 6.70s ===============================
